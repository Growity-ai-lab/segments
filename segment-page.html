<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A.T.L.A.S | Growity AI Studio</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700;800&family=Space+Mono:wght@400;700&family=Sora:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --bg-primary: #0a0a0f; --bg-secondary: #12121a; --bg-card: #1a1a24; --accent-blue: #00d4ff; --accent-purple: #7c3aed; --accent-green: #10b981; --accent-yellow: #f59e0b; --text-primary: #f0f0f5; --text-secondary: #8888a0; --border-color: #2a2a3a; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Sora', sans-serif; background: var(--bg-primary); color: var(--text-primary); min-height: 100vh; }
        .bg-grid { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-image: linear-gradient(rgba(0,212,255,0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(0,212,255,0.03) 1px, transparent 1px); background-size: 50px 50px; pointer-events: none; z-index: 0; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px 24px; position: relative; z-index: 1; }
        .header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 24px; padding-bottom: 16px; border-bottom: 1px solid var(--border-color); }
        .logo { display: flex; align-items: center; gap: 16px; }
        .logo-icon { width: 56px; height: 56px; }
        .logo-icon svg { width: 100%; height: 100%; }
        /* Globe animations */
        .globe-outer { animation: rotateRing 20s linear infinite; transform-origin: center; }
        .globe-mid { animation: rotateRing 15s linear infinite reverse; transform-origin: center; }
        .globe-inner { animation: pulseRing 3s ease-in-out infinite; transform-origin: center; }
        .globe-lat { animation: wobbleLat 8s ease-in-out infinite; transform-origin: center; }
        .globe-long { animation: wobbleLong 10s ease-in-out infinite; transform-origin: center; }
        .globe-center { animation: centerPulse 2s ease-in-out infinite; transform-origin: center; }
        .cardinal-point:nth-child(1) { animation: orbitTop 8s ease-in-out infinite; transform-origin: 28px 28px; }
        .cardinal-point:nth-child(2) { animation: orbitRight 10s ease-in-out infinite; transform-origin: 28px 28px; }
        .cardinal-point:nth-child(3) { animation: orbitBottom 7s ease-in-out infinite; transform-origin: 28px 28px; }
        .cardinal-point:nth-child(4) { animation: orbitLeft 9s ease-in-out infinite; transform-origin: 28px 28px; }
        .seg-1 { animation: floatSeg1 6s ease-in-out infinite; }
        .seg-2 { animation: floatSeg2 7s ease-in-out infinite; }
        .seg-3 { animation: floatSeg3 5s ease-in-out infinite; }
        .seg-4 { animation: floatSeg4 8s ease-in-out infinite; }
        @keyframes rotateRing { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        @keyframes pulseRing { 0%, 100% { transform: scale(1); opacity: 0.5; } 50% { transform: scale(1.08); opacity: 0.8; } }
        @keyframes wobbleLat { 0%, 100% { transform: scaleY(1); } 50% { transform: scaleY(1.15); } }
        @keyframes wobbleLong { 0%, 100% { transform: scaleX(1); } 50% { transform: scaleX(1.15); } }
        @keyframes centerPulse { 0%, 100% { transform: scale(1); filter: drop-shadow(0 0 4px rgba(0,212,255,0.6)); } 50% { transform: scale(1.2); filter: drop-shadow(0 0 10px rgba(124,58,237,0.8)); } }
        @keyframes orbitTop { 0%, 100% { transform: translate(0, 0) scale(1); } 50% { transform: translate(8px, 5px) scale(1.15); } }
        @keyframes orbitRight { 0%, 100% { transform: translate(0, 0) scale(1); } 50% { transform: translate(-6px, 8px) scale(1.1); } }
        @keyframes orbitBottom { 0%, 100% { transform: translate(0, 0) scale(1); } 50% { transform: translate(-8px, -5px) scale(1.2); } }
        @keyframes orbitLeft { 0%, 100% { transform: translate(0, 0) scale(1); } 50% { transform: translate(6px, -8px) scale(1.1); } }
        @keyframes floatSeg1 { 0%, 100% { transform: translate(0, 0) scale(1); } 50% { transform: translate(-4px, 3px) scale(1.2); } }
        @keyframes floatSeg2 { 0%, 100% { transform: translate(0, 0) scale(1); } 50% { transform: translate(4px, -4px) scale(1.15); } }
        @keyframes floatSeg3 { 0%, 100% { transform: translate(0, 0) scale(1); } 50% { transform: translate(5px, 3px) scale(1.25); } }
        @keyframes floatSeg4 { 0%, 100% { transform: translate(0, 0) scale(1); } 50% { transform: translate(-3px, -5px) scale(1.1); } }
        .logo-text { display: flex; flex-direction: column; }
        .logo-text .brand { font-family: 'Outfit', sans-serif; font-size: 26px; font-weight: 800; letter-spacing: 2px; background: linear-gradient(135deg, #00d4ff 0%, #7c3aed 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; line-height: 1.2; }
        .logo-text .tagline { font-size: 9px; font-family: 'Space Mono', monospace; color: var(--text-secondary); letter-spacing: 0.3px; margin-top: 2px; }
        .logo-text .powered-by { display: flex; align-items: center; gap: 6px; font-size: 9px; color: var(--text-secondary); margin-top: 6px; padding-top: 6px; border-top: 1px solid var(--border-color); }
        .logo-text .powered-by .growity-name { font-weight: 600; background: linear-gradient(90deg, #E91E8C, #7B2D8E); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .header-nav { display: flex; gap: 10px; }
        .nav-link { padding: 10px 16px; border: 1px solid var(--border-color); border-radius: 10px; background: var(--bg-card); color: var(--text-primary); font-size: 12px; text-decoration: none; transition: all 0.3s; }
        .nav-link:hover { border-color: var(--accent-blue); }
        .nav-link.po { border-color: rgba(227,30,36,0.4); color: #e31e24; }
        .nav-link.enerjisa { border-color: rgba(255,193,7,0.4); color: #ffc107; }
        .onboarding-toggle { display: none; padding: 10px 16px; background: linear-gradient(135deg, rgba(0,212,255,0.1), rgba(124,58,237,0.1)); border: 1px solid rgba(0,212,255,0.3); border-radius: 10px; color: var(--accent-blue); font-size: 12px; cursor: pointer; margin-bottom: 16px; }
        .onboarding-toggle.visible { display: inline-flex; align-items: center; gap: 8px; }
        .onboarding { background: linear-gradient(135deg, rgba(0,212,255,0.08), rgba(124,58,237,0.08)); border: 1px solid rgba(0,212,255,0.2); border-radius: 16px; padding: 24px; margin-bottom: 24px; }
        .onboarding.hidden { display: none; }
        .onboarding-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .onboarding-title { font-size: 18px; font-weight: 600; }
        .onboarding-title span { background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .onboarding-dismiss { padding: 6px 12px; background: transparent; border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-secondary); font-size: 11px; cursor: pointer; }
        .steps { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; }
        .step { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 12px; padding: 18px; position: relative; }
        .step.active { border-color: var(--accent-green); background: rgba(16,185,129,0.1); }
        .step-number { position: absolute; top: -10px; left: 18px; width: 24px; height: 24px; background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple)); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 700; }
        .step.active .step-number { background: linear-gradient(135deg, var(--accent-green), #059669); }
        .step-icon { width: 40px; height: 40px; margin-bottom: 12px; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, rgba(0,212,255,0.1), rgba(124,58,237,0.1)); border-radius: 10px; }
        .step-icon svg { width: 20px; height: 20px; stroke: var(--accent-blue); }
        .step.active .step-icon { background: linear-gradient(135deg, rgba(16,185,129,0.15), rgba(5,150,105,0.1)); }
        .step.active .step-icon svg { stroke: var(--accent-green); }
        .step-title { font-size: 13px; font-weight: 600; margin-bottom: 6px; }
        .step-desc { font-size: 11px; color: var(--text-secondary); line-height: 1.5; }
        .step-check { position: absolute; top: 12px; right: 12px; width: 20px; height: 20px; background: var(--accent-green); border-radius: 50%; display: none; align-items: center; justify-content: center; font-size: 12px; }
        .step.completed .step-check { display: flex; }
        .quick-actions { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 24px; }
        .quick-action { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 12px; padding: 20px; cursor: pointer; transition: all 0.3s; text-align: center; }
        .quick-action:hover { border-color: var(--accent-blue); transform: translateY(-2px); }
        .quick-action-icon { width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 22px; margin: 0 auto 12px; }
        .quick-action-icon.awareness { background: rgba(124,58,237,0.2); }
        .quick-action-icon.consideration { background: rgba(245,158,11,0.2); }
        .quick-action-icon.conversion { background: rgba(16,185,129,0.2); }
        .quick-action-title { font-size: 14px; font-weight: 600; margin-bottom: 4px; }
        .quick-action-count { font-size: 11px; color: var(--text-secondary); font-family: 'Space Mono', monospace; }
        .quick-action.active { border-color: var(--accent-green); background: rgba(16,185,129,0.1); }
        .meta-panel { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 12px; padding: 16px 20px; margin-bottom: 20px; }
        .meta-panel-header { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px; margin-bottom: 12px; }
        .meta-panel-title { font-size: 13px; font-weight: 600; color: var(--accent-blue); display: flex; align-items: center; gap: 8px; }
        .meta-status { font-size: 10px; padding: 4px 10px; border-radius: 12px; font-family: 'Space Mono', monospace; background: rgba(255,255,255,0.05); color: var(--text-secondary); }
        .meta-status.connected { background: rgba(52,211,153,0.15); color: #34d399; }
        .meta-status.loading { background: rgba(251,191,36,0.15); color: #fbbf24; }
        .platform-tabs { display: flex; gap: 6px; }
        .platform-tab { display: flex; align-items: center; gap: 6px; padding: 8px 14px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-secondary); font-size: 11px; font-weight: 500; cursor: pointer; transition: all 0.2s; }
        .platform-tab:hover:not(:disabled) { border-color: var(--accent-blue); color: var(--text-primary); }
        .platform-tab.active { background: linear-gradient(135deg, rgba(0,212,255,0.15), rgba(124,58,237,0.15)); border-color: var(--accent-blue); color: var(--text-primary); }
        .platform-tab[data-platform="meta"].active { background: linear-gradient(135deg, rgba(24,119,242,0.2), rgba(66,103,178,0.15)); border-color: #1877f2; }
        .platform-tab[data-platform="tiktok"].active { background: linear-gradient(135deg, rgba(0,0,0,0.2), rgba(238,45,86,0.15)); border-color: #ee2d5e; }
        .platform-tab[data-platform="google"].active { background: linear-gradient(135deg, rgba(66,133,244,0.2), rgba(52,168,83,0.15)); border-color: #4285f4; }
        .platform-tab:disabled { opacity: 0.4; cursor: not-allowed; }
        .platform-tab svg { flex-shrink: 0; }
        .tiktok-connect-btn { display: flex; align-items: center; justify-content: center; width: 32px; height: 32px; background: linear-gradient(135deg, rgba(238,45,86,0.15), rgba(238,45,86,0.05)); border: 1px solid rgba(238,45,86,0.3); border-radius: 8px; color: #ee2d5e; cursor: pointer; transition: all 0.2s; margin-left: -4px; }
        .tiktok-connect-btn:hover { background: linear-gradient(135deg, rgba(238,45,86,0.25), rgba(238,45,86,0.1)); border-color: #ee2d5e; transform: translateY(-1px); }
        .tiktok-connect-btn.connected { background: linear-gradient(135deg, rgba(16,185,129,0.15), rgba(16,185,129,0.05)); border-color: rgba(16,185,129,0.3); color: #10b981; }
        .tiktok-connect-btn.connected:hover { border-color: #10b981; }
        .connection-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--border-color); margin-left: 4px; }
        .connection-dot.connected { background: #10b981; box-shadow: 0 0 6px #10b981; }
        .connection-dot.pending { background: #f59e0b; animation: pulse 1.5s infinite; }
        .meta-controls { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; margin-top: 12px; }
        .meta-input { padding: 8px 12px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--bg-secondary); color: var(--text-primary); font-size: 12px; width: 200px; }
        .meta-input:focus { outline: none; border-color: var(--accent-blue); }
        .meta-btn { padding: 8px 14px; background: linear-gradient(135deg, #1877f2, #0d65d9); border: none; border-radius: 8px; color: white; font-size: 11px; font-weight: 500; cursor: pointer; }
        .meta-btn:hover { transform: translateY(-1px); }
        .meta-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .meta-btn.purple { background: linear-gradient(135deg, #7c3aed, #6d28d9); }
        .meta-btn.green { background: linear-gradient(135deg, #10b981, #059669); }
        .meta-count { font-size: 10px; color: var(--text-secondary); font-family: 'Space Mono', monospace; }
        #interestResults { display: none; margin-top: 16px; padding: 16px; background: var(--bg-card); border-radius: 12px; max-height: 500px; overflow-y: auto; border: 2px solid var(--accent-blue); box-shadow: 0 4px 20px rgba(0,212,255,0.2); }
        .ai-suggestions { display: none; margin-top: 16px; background: linear-gradient(135deg, rgba(124,58,237,0.1), rgba(236,72,153,0.1)); border: 1px solid rgba(124,58,237,0.3); border-radius: 12px; padding: 16px; }
        .ai-suggestions.visible { display: block; }
        .ai-suggestions-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; flex-wrap: wrap; gap: 10px; }
        .ai-suggestions-title { font-size: 13px; font-weight: 600; color: var(--accent-purple); display: flex; align-items: center; gap: 8px; }
        .ai-suggestions-actions { display: flex; gap: 8px; flex-wrap: wrap; }
        .suggestions-list { display: flex; flex-direction: column; gap: 8px; max-height: 300px; overflow-y: auto; }
        .suggestion-item { display: flex; align-items: center; justify-content: space-between; padding: 10px 14px; background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 10px; gap: 10px; }
        .suggestion-item.accepted { border-color: var(--accent-green); background: rgba(16,185,129,0.1); }
        .suggestion-item.loading { opacity: 0.6; }
        .suggestion-left { display: flex; align-items: center; gap: 10px; flex: 1; flex-wrap: wrap; }
        .suggestion-segment { font-size: 12px; font-weight: 500; min-width: 150px; }
        .suggestion-arrow { color: var(--text-secondary); }
        .suggestion-interest { font-size: 12px; color: var(--accent-blue); }
        .suggestion-size { font-size: 10px; color: var(--accent-green); font-family: 'Space Mono', monospace; }
        .suggestion-actions { display: flex; gap: 6px; }
        .suggestion-btn { padding: 6px 12px; border: none; border-radius: 6px; font-size: 10px; font-weight: 500; cursor: pointer; }
        .suggestion-btn.accept { background: var(--accent-green); color: white; }
        .suggestion-btn.skip { background: var(--bg-secondary); color: var(--text-secondary); border: 1px solid var(--border-color); }
        .suggestion-status { font-size: 10px; color: var(--accent-green); font-weight: 500; }
        .meta-reach { display: inline-flex; align-items: center; gap: 4px; padding: 3px 8px; background: linear-gradient(135deg, rgba(24,119,242,0.15), rgba(24,119,242,0.05)); border: 1px solid rgba(24,119,242,0.25); border-radius: 10px; font-size: 9px; font-family: 'Space Mono', monospace; color: #60a5fa; }
        .meta-reach.loaded { color: #34d399; border-color: rgba(52,211,153,0.3); background: linear-gradient(135deg, rgba(52,211,153,0.15), rgba(52,211,153,0.05)); }
        .platform-badges { display: flex; flex-direction: column; gap: 4px; align-items: flex-end; }
        .platform-badge { display: inline-flex; align-items: center; gap: 4px; padding: 3px 8px; border-radius: 10px; font-size: 9px; font-family: 'Space Mono', monospace; white-space: nowrap; max-width: 180px; overflow: hidden; text-overflow: ellipsis; }
        .platform-badge.meta { background: linear-gradient(135deg, rgba(24,119,242,0.15), rgba(24,119,242,0.05)); border: 1px solid rgba(24,119,242,0.25); color: #60a5fa; }
        .platform-badge.tiktok { background: linear-gradient(135deg, rgba(238,45,86,0.15), rgba(238,45,86,0.05)); border: 1px solid rgba(238,45,86,0.25); color: #ee2d5e; }
        .platform-badge.google { background: linear-gradient(135deg, rgba(66,133,244,0.15), rgba(52,168,83,0.05)); border: 1px solid rgba(66,133,244,0.25); color: #4285f4; }
        .platform-badge.empty { background: rgba(255,255,255,0.03); border: 1px solid var(--border-color); color: var(--text-secondary); }
        .meta-live { width: 6px; height: 6px; background: #34d399; border-radius: 50%; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        
        /* TikTok Connection Modal */
        .tiktok-modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(8px); z-index: 1000; align-items: center; justify-content: center; }
        .tiktok-modal-overlay.visible { display: flex; animation: fadeIn 0.2s ease; }
        .tiktok-modal { background: var(--bg-card); border: 1px solid rgba(238,45,86,0.3); border-radius: 20px; padding: 32px; max-width: 480px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.5), 0 0 40px rgba(238,45,86,0.15); animation: slideIn 0.3s ease; }
        .tiktok-modal-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 24px; }
        .tiktok-modal-title { display: flex; align-items: center; gap: 12px; font-size: 20px; font-weight: 600; }
        .tiktok-modal-title svg { color: #ee2d5e; }
        .tiktok-modal-close { width: 32px; height: 32px; background: rgba(255,255,255,0.05); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-secondary); cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .tiktok-modal-close:hover { background: rgba(255,255,255,0.1); color: var(--text-primary); }
        .tiktok-modal-status { padding: 16px; border-radius: 12px; margin-bottom: 20px; display: flex; align-items: center; gap: 12px; }
        .tiktok-modal-status.disconnected { background: linear-gradient(135deg, rgba(238,45,86,0.1), rgba(0,0,0,0.2)); border: 1px solid rgba(238,45,86,0.2); }
        .tiktok-modal-status.connected { background: linear-gradient(135deg, rgba(16,185,129,0.1), rgba(0,0,0,0.2)); border: 1px solid rgba(16,185,129,0.2); }
        .tiktok-modal-status-icon { width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 20px; }
        .tiktok-modal-status.disconnected .tiktok-modal-status-icon { background: rgba(238,45,86,0.15); }
        .tiktok-modal-status.connected .tiktok-modal-status-icon { background: rgba(16,185,129,0.15); }
        .tiktok-modal-status-text { flex: 1; }
        .tiktok-modal-status-title { font-size: 14px; font-weight: 600; margin-bottom: 2px; }
        .tiktok-modal-status.disconnected .tiktok-modal-status-title { color: #ee2d5e; }
        .tiktok-modal-status.connected .tiktok-modal-status-title { color: #10b981; }
        .tiktok-modal-status-desc { font-size: 11px; color: var(--text-secondary); }
        .tiktok-modal-info { background: rgba(255,255,255,0.03); border: 1px solid var(--border-color); border-radius: 12px; padding: 16px; margin-bottom: 20px; }
        .tiktok-modal-info p { font-size: 12px; color: var(--text-secondary); line-height: 1.6; margin-bottom: 12px; }
        .tiktok-modal-info p:last-child { margin-bottom: 0; }
        .tiktok-modal-info strong { color: var(--text-primary); }
        .tiktok-modal-actions { display: flex; gap: 12px; flex-wrap: wrap; }
        .tiktok-modal-btn { flex: 1; padding: 14px 20px; border: none; border-radius: 10px; font-size: 14px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; transition: all 0.2s; }
        .tiktok-modal-btn.primary { background: linear-gradient(135deg, #ee2d5e, #ff0050); color: white; box-shadow: 0 4px 15px rgba(238,45,86,0.3); }
        .tiktok-modal-btn.primary:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(238,45,86,0.4); }
        .tiktok-modal-btn.secondary { background: rgba(255,255,255,0.05); border: 1px solid var(--border-color); color: var(--text-primary); }
        .tiktok-modal-btn.secondary:hover { background: rgba(255,255,255,0.1); }
        .tiktok-modal-btn.danger { background: rgba(239,68,68,0.15); border: 1px solid rgba(239,68,68,0.3); color: #ef4444; }
        .tiktok-modal-btn.danger:hover { background: rgba(239,68,68,0.25); }
        .tiktok-modal-footer { margin-top: 20px; padding-top: 16px; border-top: 1px solid var(--border-color); text-align: center; }
        .tiktok-modal-footer p { font-size: 10px; color: var(--text-secondary); font-family: 'Space Mono', monospace; }
        .stats-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 20px; }
        .stat-card { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 10px; padding: 14px 16px; display: flex; align-items: center; gap: 12px; }
        .stat-icon { width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 18px; }
        .stat-icon.blue { background: rgba(0,212,255,0.15); }
        .stat-icon.purple { background: rgba(124,58,237,0.15); }
        .stat-icon.green { background: rgba(16,185,129,0.15); }
        .stat-icon.orange { background: rgba(255,107,53,0.15); }
        .stat-value { font-size: 22px; font-weight: 700; font-family: 'Space Mono', monospace; color: var(--accent-blue); }
        .stat-label { font-size: 10px; color: var(--text-secondary); text-transform: uppercase; }
        .controls { display: flex; gap: 16px; margin-bottom: 20px; align-items: center; flex-wrap: wrap; }
        .search-box { flex: 1; max-width: 350px; position: relative; }
        .search-icon { position: absolute; left: 14px; top: 50%; transform: translateY(-50%); font-size: 14px; color: var(--text-secondary); }
        .search-input { width: 100%; padding: 12px 14px 12px 42px; background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 10px; color: var(--text-primary); font-size: 13px; }
        .search-input:focus { outline: none; border-color: var(--accent-blue); }
        .filter-btns { display: flex; gap: 8px; flex-wrap: wrap; }
        .filter-btn { padding: 10px 16px; background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-secondary); font-size: 12px; cursor: pointer; }
        .filter-btn.active { background: rgba(0,212,255,0.15); border-color: var(--accent-blue); color: var(--accent-blue); }
        .segment-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(340px, 1fr)); gap: 16px; margin-bottom: 100px; }
        .parent-card { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 14px; overflow: hidden; animation: fadeIn 0.3s ease; }
        .parent-card.has-selected { border-color: var(--accent-green); box-shadow: 0 0 0 1px var(--accent-green); }
        .parent-header { padding: 16px 18px; display: flex; align-items: center; justify-content: space-between; cursor: pointer; border-bottom: 1px solid transparent; }
        .parent-card.expanded .parent-header { border-bottom-color: var(--border-color); }
        .parent-left { display: flex; align-items: center; gap: 12px; }
        .parent-icon { width: 42px; height: 42px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 20px; background: rgba(255,255,255,0.05); }
        .parent-name { font-size: 14px; font-weight: 600; }
        .parent-count { font-size: 11px; color: var(--text-secondary); margin-top: 2px; }
        .parent-actions { display: flex; align-items: center; gap: 10px; }
        .select-all-btn { padding: 6px 12px; background: transparent; border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-secondary); font-size: 10px; cursor: pointer; }
        .expand-icon { color: var(--text-secondary); font-size: 12px; transition: transform 0.3s; }
        .parent-card.expanded .expand-icon { transform: rotate(180deg); }
        .sub-segments { max-height: 0; overflow: hidden; transition: max-height 0.3s ease; }
        .parent-card.expanded .sub-segments { max-height: 800px; }
        .sub-segment { padding: 12px 18px; display: flex; align-items: center; gap: 12px; cursor: pointer; border-bottom: 1px solid rgba(255,255,255,0.03); }
        .sub-segment:last-child { border-bottom: none; }
        .sub-segment:hover { background: rgba(0,212,255,0.05); }
        .sub-segment.selected { background: rgba(16,185,129,0.1); }
        .checkbox { width: 20px; height: 20px; border: 2px solid var(--border-color); border-radius: 5px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .checkbox.checked { background: var(--accent-green); border-color: var(--accent-green); }
        .checkbox.checked::after { content: '✓'; color: white; font-size: 12px; font-weight: bold; }
        .sub-info { flex: 1; }
        .sub-name { font-size: 13px; font-weight: 500; }
        .sub-desc { font-size: 11px; color: var(--text-secondary); margin-top: 2px; }
        .sub-meta { display: flex; flex-direction: column; align-items: flex-end; gap: 4px; }
        .meta-tag { padding: 4px 8px; background: rgba(0,212,255,0.1); border-radius: 6px; font-size: 10px; color: var(--accent-blue); font-family: 'Space Mono', monospace; }
        .footer-actions { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(18,18,26,0.95); backdrop-filter: blur(20px); border-top: 1px solid var(--border-color); padding: 16px 24px; display: flex; justify-content: space-between; align-items: center; transform: translateY(100%); transition: transform 0.3s ease; z-index: 100; }
        .footer-actions.visible { transform: translateY(0); }
        .footer-left { display: flex; align-items: center; gap: 16px; }
        .footer-count { font-size: 14px; color: var(--text-secondary); }
        .footer-count strong { color: var(--accent-blue); font-family: 'Space Mono', monospace; }
        .selected-chips { display: flex; gap: 8px; flex-wrap: wrap; }
        .selected-chip { padding: 6px 12px; background: rgba(16,185,129,0.15); border: 1px solid rgba(16,185,129,0.3); border-radius: 20px; font-size: 11px; color: var(--accent-green); display: flex; align-items: center; gap: 6px; }
        .chip-remove { cursor: pointer; opacity: 0.7; }
        .footer-right { display: flex; gap: 12px; }
        .btn { padding: 12px 20px; border: none; border-radius: 10px; font-size: 13px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px; }
        .btn-secondary { background: var(--bg-card); border: 1px solid var(--border-color); color: var(--text-primary); }
        .btn-primary { background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple)); color: white; }
        .empty-state { grid-column: 1 / -1; text-align: center; padding: 60px 20px; }
        .empty-state-icon { font-size: 48px; margin-bottom: 16px; opacity: 0.5; }
        @media (max-width: 1200px) { .steps { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 768px) { .steps { grid-template-columns: 1fr; } .quick-actions { grid-template-columns: 1fr; } .stats-row { grid-template-columns: repeat(2, 1fr); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideIn { from { transform: translateX(100px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
        
        /* === UI/UX PRO MAX ENHANCEMENTS === */
        
        /* Cursor pointer for all interactive elements */
        button, a, [onclick], [role="button"], .clickable, .quick-action, .parent-header, .sub-segment, .segment-item, .filter-btn, .nav-link, .btn, .onboarding-dismiss, .onboarding-toggle, .select-all-btn, .chip-remove, .suggestion-btn, .meta-btn { cursor: pointer; }
        
        /* Smooth transitions */
        button, a, input, .card, .btn, .nav-link, .filter-btn, .quick-action, .parent-card, .parent-header, .sub-segment, .segment-item, .stat-card, .suggestion-item { transition: all 0.2s ease-out; }
        
        /* Focus states for keyboard navigation */
        :focus { outline: none; }
        :focus-visible { outline: 2px solid var(--accent-blue); outline-offset: 2px; }
        button:focus-visible, a:focus-visible, input:focus-visible { box-shadow: 0 0 0 3px rgba(0, 212, 255, 0.25); }
        
        /* Reduced motion for accessibility */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after { animation-duration: 0.01ms !important; animation-iteration-count: 1 !important; transition-duration: 0.01ms !important; scroll-behavior: auto !important; }
            .bg-grid { display: none; }
        }
        
        /* Prevent text selection on UI elements */
        button, .btn, .nav-link, .filter-btn, .quick-action, .segment-item, .stat-card { user-select: none; -webkit-user-select: none; }
        
        /* Better scrollbar */
        * { scrollbar-width: thin; scrollbar-color: var(--border-color) var(--bg-secondary); }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-secondary); border-radius: 4px; }
        ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-secondary); }
        
        /* Screen reader only */
        .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border-width: 0; }
        
        /* Improved hover states */
        .quick-action:hover, .nav-link:hover, .filter-btn:hover, .parent-header:hover, .segment-item:hover, .sub-segment:hover { transform: translateY(-1px); }
        .btn:hover, .meta-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3); }
        .quick-action:active, .btn:active, .nav-link:active, .filter-btn:active { transform: translateY(0); }
        
        /* Card hover enhancement */
        .parent-card:hover, .stat-card:hover { border-color: rgba(0, 212, 255, 0.3); box-shadow: 0 0 20px rgba(0, 212, 255, 0.08); }
        
        /* Icon base styles */
        .icon { display: inline-flex; align-items: center; justify-content: center; width: 1em; height: 1em; }
        .icon svg { width: 100%; height: 100%; fill: none; stroke: currentColor; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; }

        
        /* === TOAST NOTIFICATION SYSTEM === */
        .toast-container { position: fixed; bottom: 24px; right: 24px; z-index: 10000; display: flex; flex-direction: column; gap: 12px; pointer-events: none; }
        .toast { pointer-events: auto; padding: 14px 20px; background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 12px; display: flex; align-items: center; gap: 12px; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4); transform: translateX(120%); opacity: 0; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); max-width: 380px; }
        .toast.visible { transform: translateX(0); opacity: 1; }
        .toast.hiding { transform: translateX(120%); opacity: 0; }
        .toast-success { border-left: 4px solid var(--accent-green); }
        .toast-error { border-left: 4px solid #ef4444; }
        .toast-info { border-left: 4px solid var(--accent-blue); }
        .toast-warning { border-left: 4px solid var(--accent-yellow); }
        .toast-icon { width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .toast-success .toast-icon { background: rgba(16, 185, 129, 0.2); color: var(--accent-green); }
        .toast-error .toast-icon { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
        .toast-info .toast-icon { background: rgba(0, 212, 255, 0.2); color: var(--accent-blue); }
        .toast-warning .toast-icon { background: rgba(245, 158, 11, 0.2); color: var(--accent-yellow); }
        .toast-content { flex: 1; }
        .toast-title { font-size: 13px; font-weight: 600; margin-bottom: 2px; }
        .toast-message { font-size: 12px; color: var(--text-secondary); }
        .toast-close { background: none; border: none; color: var(--text-secondary); cursor: pointer; padding: 4px; border-radius: 4px; transition: all 0.2s; }
        .toast-close:hover { background: rgba(255,255,255,0.1); color: var(--text-primary); }
        .toast-progress { position: absolute; bottom: 0; left: 0; height: 3px; background: var(--accent-green); border-radius: 0 0 0 12px; animation: toast-progress linear forwards; }
        .toast-error .toast-progress { background: #ef4444; }
        .toast-info .toast-progress { background: var(--accent-blue); }
        .toast-warning .toast-progress { background: var(--accent-yellow); }
        @keyframes toast-progress { from { width: 100%; } to { width: 0%; } }
        
        /* === LOADING BUTTON STATES === */
        .btn-loading { position: relative; pointer-events: none; opacity: 0.7; }
        .btn-loading .btn-text { opacity: 0; }
        .btn-loading .btn-spinner { display: flex; }
        .btn-spinner { display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); }
        .btn-spinner svg { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        button:disabled, .btn:disabled { opacity: 0.6; cursor: not-allowed; pointer-events: none; }
        .btn-content { display: flex; align-items: center; gap: 6px; }
    </style>
</head>
<body>
    <div class="bg-grid"></div>
    <div class="container">
        <header class="header">
            <div class="logo">
                <div class="logo-icon">
                    <svg viewBox="0 0 56 56" fill="none">
                        <!-- Rings -->
                        <circle class="globe-outer" cx="28" cy="28" r="25" stroke="url(#atlasGrad)" stroke-width="1.5" fill="none"/>
                        <circle class="globe-mid" cx="28" cy="28" r="17" stroke="url(#atlasGrad)" stroke-width="1" fill="none" opacity="0.7"/>
                        <circle class="globe-inner" cx="28" cy="28" r="10" stroke="url(#atlasGrad)" stroke-width="1" fill="none" opacity="0.5"/>
                        <!-- Lat/Long -->
                        <ellipse class="globe-lat" cx="28" cy="28" rx="25" ry="9" stroke="url(#atlasGrad)" stroke-width="0.75" fill="none" opacity="0.4"/>
                        <ellipse class="globe-long" cx="28" cy="28" rx="9" ry="25" stroke="url(#atlasGrad)" stroke-width="0.75" fill="none" opacity="0.4"/>
                        <!-- Center -->
                        <circle class="globe-center" cx="28" cy="28" r="3" fill="url(#atlasGrad)"/>
                        <!-- Cardinal points -->
                        <g class="cardinal-points">
                            <circle class="cardinal-point" cx="28" cy="3" r="2.5" fill="#00d4ff"/>
                            <circle class="cardinal-point" cx="53" cy="28" r="2.5" fill="#7c3aed"/>
                            <circle class="cardinal-point" cx="28" cy="53" r="2.5" fill="#14b8a6"/>
                            <circle class="cardinal-point" cx="3" cy="28" r="2.5" fill="#00d4ff"/>
                        </g>
                        <!-- Segment points -->
                        <circle class="seg-1" cx="42" cy="12" r="1.5" fill="#ec4899"/>
                        <circle class="seg-2" cx="46" cy="38" r="1.5" fill="#f59e0b"/>
                        <circle class="seg-3" cx="14" cy="44" r="1.5" fill="#10b981"/>
                        <circle class="seg-4" cx="10" cy="18" r="1.5" fill="#8b5cf6"/>
                        <defs>
                            <linearGradient id="atlasGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" stop-color="#00d4ff"/>
                                <stop offset="50%" stop-color="#7c3aed"/>
                                <stop offset="100%" stop-color="#14b8a6"/>
                            </linearGradient>
                        </defs>
                    </svg>
                </div>
                <div class="logo-text">
                    <span class="brand">A.T.L.A.S</span>
                    <span class="tagline">Audience Targeting & Layered Analysis System</span>
                    <div class="powered-by">
                        <span>powered by</span>
                        <svg viewBox="0 0 20 20" width="12" height="12"><circle cx="7" cy="10" r="5" fill="none" stroke="#E91E8C" stroke-width="1.5"/><circle cx="13" cy="10" r="5" fill="none" stroke="#7B2D8E" stroke-width="1.5"/></svg>
                        <span class="growity-name">Growity AI Studio</span>
                    </div>
                </div>
            </div>
            <nav class="header-nav">
                <a href="segmentation-quadrant.html" class="nav-link" aria-label="Quadrant Analizi"><span class="icon"><svg viewBox="0 0 24 24"><rect width="7" height="7" x="3" y="3" rx="1"/><rect width="7" height="7" x="14" y="3" rx="1"/><rect width="7" height="7" x="14" y="14" rx="1"/><rect width="7" height="7" x="3" y="14" rx="1"/></svg></span> Quadrant</a>
                <a href="po-segmentasyon.html" class="nav-link po" aria-label="Petrol Ofisi Premium Market"><span class="icon"><svg viewBox="0 0 24 24"><path d="M3 22V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v17"/><path d="M14 10h1a2 2 0 0 1 2 2v2a2 2 0 0 0 2 2h0a2 2 0 0 0 2-2V9.83a2 2 0 0 0-.59-1.42L18 6"/><path d="M3 22h14"/><path d="M7 10h4"/></svg></span> PO Premium</a>
                <a href="enerjisa-30yil.html" class="nav-link enerjisa" aria-label="Enerjisa 30. Yıl"><span class="icon"><svg viewBox="0 0 24 24"><path d="M4 14a1 1 0 0 1-.78-1.63l9.9-10.2a.5.5 0 0 1 .86.46l-1.92 6.02A1 1 0 0 0 13 10h7a1 1 0 0 1 .78 1.63l-9.9 10.2a.5.5 0 0 1-.86-.46l1.92-6.02A1 1 0 0 0 11 14z"/></svg></span> Enerjisa</a>
            </nav>
        </header>
        <button class="onboarding-toggle" id="onboardingToggle" onclick="toggleOnboarding()" aria-label="Kullanım Rehberini Göster"><span class="icon"><svg viewBox="0 0 24 24"><path d="M12 16v-4"/><path d="M12 8h.01"/><circle cx="12" cy="12" r="10"/></svg></span> Kullanım Rehberini Göster</button>
        <section class="onboarding" id="onboarding">
            <div class="onboarding-header">
                <div class="onboarding-title"><span class="icon"><svg viewBox="0 0 24 24"><path d="M9.937 15.5A2 2 0 0 0 8.5 14.063l-6.135-1.582a.5.5 0 0 1 0-.962L8.5 9.936A2 2 0 0 0 9.937 8.5l1.582-6.135a.5.5 0 0 1 .963 0L14.063 8.5A2 2 0 0 0 15.5 9.937l6.135 1.581a.5.5 0 0 1 0 .964L15.5 14.063a2 2 0 0 0-1.437 1.437l-1.582 6.135a.5.5 0 0 1-.963 0z"/></svg></span> <span>Hoş Geldiniz!</span> Segment seçimine başlayın</div>
                <button class="onboarding-dismiss" onclick="toggleOnboarding()">Gizle ✕</button>
            </div>
            <div class="steps">
                <div class="step active" id="step1"><div class="step-number">1</div><div class="step-check"><svg viewBox="0 0 24 24" width="12" height="12" fill="none" stroke="currentColor" stroke-width="3"><path d="M20 6 9 17l-5-5"/></svg></div><div class="step-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="3"/><path d="M12 2v4"/><path d="M12 18v4"/><path d="M2 12h4"/><path d="M18 12h4"/></svg></div><div class="step-title">Hedef Belirleyin</div><div class="step-desc">Awareness, Consideration veya Conversion funnel'ından birini seçin</div></div>
                <div class="step" id="step2"><div class="step-number">2</div><div class="step-check"><svg viewBox="0 0 24 24" width="12" height="12" fill="none" stroke="currentColor" stroke-width="3"><path d="M20 6 9 17l-5-5"/></svg></div><div class="step-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="5" width="6" height="6" rx="1"/><path d="m5 8 1 1 2-2"/><path d="M13 6h8"/><path d="M13 10h5"/><rect x="3" y="13" width="6" height="6" rx="1"/><path d="M13 14h8"/><path d="M13 18h5"/></svg></div><div class="step-title">Segment Seçin</div><div class="step-desc">İlgili kategorileri açıp hedef segmentleri işaretleyin</div></div>
                <div class="step" id="step3"><div class="step-number">3</div><div class="step-check"><svg viewBox="0 0 24 24" width="12" height="12" fill="none" stroke="currentColor" stroke-width="3"><path d="M20 6 9 17l-5-5"/></svg></div><div class="step-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v18h18"/><circle cx="9" cy="9" r="2"/><circle cx="17" cy="7" r="2"/><circle cx="13" cy="15" r="2"/></svg></div><div class="step-title">Analiz Edin</div><div class="step-desc">Seçimleri Quadrant'a göndererek görselleştirin</div></div>
                <div class="step" id="step4"><div class="step-number">4</div><div class="step-check"><svg viewBox="0 0 24 24" width="12" height="12" fill="none" stroke="currentColor" stroke-width="3"><path d="M20 6 9 17l-5-5"/></svg></div><div class="step-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><polyline points="16 6 12 2 8 6"/><line x1="12" x2="12" y1="2" y2="15"/></svg></div><div class="step-title">Dışa Aktarın</div><div class="step-desc">CSV veya PNG olarak planlama ekibinizle paylaşın</div></div>
            </div>
        </section>
        <section class="quick-actions">
            <div class="quick-action" onclick="selectFunnel('awareness')" id="funnel-awareness" role="button" tabindex="0" aria-label="Awareness segmentlerini seç"><div class="quick-action-icon awareness"><svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="#7c3aed" stroke-width="2"><path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/><path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"/></svg></div><div class="quick-action-title">Awareness</div><div class="quick-action-count">18 segment otomatik seç</div></div>
            <div class="quick-action" onclick="selectFunnel('consideration')" id="funnel-consideration" role="button" tabindex="0" aria-label="Consideration segmentlerini seç"><div class="quick-action-icon consideration"><svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="#f59e0b" stroke-width="2"><path d="M12 5a3 3 0 1 0-5.997.125 4 4 0 0 0-2.526 5.77 4 4 0 0 0 .556 6.588A4 4 0 1 0 12 18Z"/><path d="M12 5a3 3 0 1 1 5.997.125 4 4 0 0 1 2.526 5.77 4 4 0 0 1-.556 6.588A4 4 0 1 1 12 18Z"/><path d="M12 5v13"/></svg></div><div class="quick-action-title">Consideration</div><div class="quick-action-count">20 segment otomatik seç</div></div>
            <div class="quick-action" onclick="selectFunnel('conversion')" id="funnel-conversion" role="button" tabindex="0" aria-label="Conversion segmentlerini seç"><div class="quick-action-icon conversion"><svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="#10b981" stroke-width="2"><circle cx="8" cy="8" r="6"/><path d="M18.09 10.37A6 6 0 1 1 10.34 18"/><path d="M7 6h1v4"/><path d="m16.71 13.88.7.71-2.82 2.82"/></svg></div><div class="quick-action-title">Conversion</div><div class="quick-action-count">16 segment otomatik seç</div></div>
        </section>
        <div class="meta-panel">
            <div class="meta-panel-header">
                <div class="meta-panel-title"><span class="icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/></svg></span> Audience Data <span class="meta-status" id="metaStatus">Hazır</span></div>
                <div class="platform-tabs">
                    <button class="platform-tab active" data-platform="meta" onclick="switchPlatform('meta')">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.477 2 2 6.477 2 12c0 4.991 3.657 9.128 8.438 9.879V14.89h-2.54V12h2.54V9.797c0-2.506 1.492-3.89 3.777-3.89 1.094 0 2.238.195 2.238.195v2.46h-1.26c-1.243 0-1.63.771-1.63 1.562V12h2.773l-.443 2.89h-2.33v6.989C18.343 21.129 22 16.99 22 12c0-5.523-4.477-10-10-10z"/></svg>
                        Meta
                        <span class="connection-dot connected"></span>
                    </button>
                    <button class="platform-tab" data-platform="tiktok" onclick="switchPlatform('tiktok')">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M19.59 6.69a4.83 4.83 0 0 1-3.77-4.25V2h-3.45v13.67a2.89 2.89 0 0 1-5.2 1.74 2.89 2.89 0 0 1 2.31-4.64 2.93 2.93 0 0 1 .88.13V9.4a6.84 6.84 0 0 0-1-.05A6.33 6.33 0 0 0 5 20.1a6.34 6.34 0 0 0 10.86-4.43v-7a8.16 8.16 0 0 0 4.77 1.52v-3.4a4.85 4.85 0 0 1-1-.1z"/></svg>
                        TikTok
                        <span class="connection-dot" id="tiktokConnectionDot"></span>
                    </button>
                    <button class="tiktok-connect-btn" id="tiktokConnectBtn" onclick="event.stopPropagation(); showTikTokConnectionModal()" title="TikTok Hesap Ayarları">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>
                    </button>
                    <button class="platform-tab" data-platform="google" onclick="switchPlatform('google')" disabled title="Yakında">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
                        Google
                        <span class="connection-dot"></span>
                    </button>
                </div>
            </div>
            <div class="meta-controls">
                <input type="text" id="interestSearch" class="meta-input" placeholder="Interest ara (ör: travel)...">
                <button class="meta-btn" onclick="searchInterest()" aria-label="Interest Ara"><span class="icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg></span> Ara</button>
                <button class="meta-btn purple" onclick="showMappingsModal()" aria-label="Eşleştirmeleri Görüntüle"><span class="icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect width="8" height="4" x="8" y="2" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/></svg></span> Eşleştirmeler</button>
                <span class="meta-count" id="metaLoadedCount">0 eşleşme</span>
            </div>
            <div id="interestResults"></div>
            <div class="ai-suggestions" id="aiSuggestions">
                <div class="ai-suggestions-header">
                    <div class="ai-suggestions-title">🤖 Akıllı Interest Önerileri <span id="suggestionCount" style="font-weight:400;color:var(--text-secondary);"></span></div>
                    <div class="ai-suggestions-actions">
                        <button class="meta-btn green" onclick="acceptAllSuggestions()">✓ Tümünü Kabul</button>
                        <button class="meta-btn" onclick="fetchAllSuggestions()">🔄 Yeniden Öner</button>
                        <button class="suggestion-btn skip" onclick="closeSuggestions()">✕ Kapat</button>
                    </div>
                </div>
                <div class="suggestions-list" id="suggestionsList"></div>
            </div>
        </div>
        <div class="stats-row">
            <div class="stat-card"><div class="stat-icon blue">👥</div><div><div class="stat-value">68</div><div class="stat-label">Toplam Segment</div></div></div>
            <div class="stat-card"><div class="stat-icon purple">📁</div><div><div class="stat-value">16</div><div class="stat-label">Ana Kategori</div></div></div>
            <div class="stat-card"><div class="stat-icon green">✓</div><div><div class="stat-value" id="selectedCount">0</div><div class="stat-label">Seçili</div></div></div>
            <div class="stat-card"><div class="stat-icon orange">📈</div><div><div class="stat-value" id="totalReach">0%</div><div class="stat-label">Tahmini Reach</div></div></div>
        </div>
        <div class="controls">
            <div class="search-box"><span class="search-icon">🔍</span><input type="text" class="search-input" placeholder="Segment ara..." id="searchInput"></div>
            <div class="filter-btns">
                <button class="filter-btn active" data-filter="all">Tümü</button>
                <button class="filter-btn" data-filter="lifestyle">🌟 Lifestyle</button>
                <button class="filter-btn" data-filter="demografik">👤 Demografik</button>
                <button class="filter-btn" data-filter="davranis">🛒 Davranış</button>
                <button class="filter-btn" data-filter="b2c">⚡ B2C</button>
                <button class="filter-btn" data-filter="b2b">🏢 B2B</button>
            </div>
            <button class="btn btn-secondary" onclick="toggleAllCategories()" id="toggleAllBtn" style="margin-left:auto;font-size:12px;padding:8px 14px;">
                <span class="icon" style="margin-right:4px;">📂</span> Tümünü Aç
            </button>
        </div>
        <div class="segment-grid" id="segmentGrid"></div>
    </div>
    
    <!-- TikTok Connection Modal -->
    <div class="tiktok-modal-overlay" id="tiktokModal" onclick="if(event.target === this) closeTikTokModal()">
        <div class="tiktok-modal">
            <div class="tiktok-modal-header">
                <div class="tiktok-modal-title">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M19.59 6.69a4.83 4.83 0 0 1-3.77-4.25V2h-3.45v13.67a2.89 2.89 0 0 1-5.2 1.74 2.89 2.89 0 0 1 2.31-4.64 2.93 2.93 0 0 1 .88.13V9.4a6.84 6.84 0 0 0-1-.05A6.33 6.33 0 0 0 5 20.1a6.34 6.34 0 0 0 10.86-4.43v-7a8.16 8.16 0 0 0 4.77 1.52v-3.4a4.85 4.85 0 0 1-1-.1z"/></svg>
                    TikTok Business API
                </div>
                <button class="tiktok-modal-close" onclick="closeTikTokModal()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                </button>
            </div>
            
            <div class="tiktok-modal-status disconnected" id="tiktokModalStatus">
                <div class="tiktok-modal-status-icon">🔌</div>
                <div class="tiktok-modal-status-text">
                    <div class="tiktok-modal-status-title" id="tiktokStatusTitle">Bağlantı Yok</div>
                    <div class="tiktok-modal-status-desc" id="tiktokStatusDesc">TikTok Ads Manager hesabınız bağlı değil</div>
                </div>
            </div>
            
            <div class="tiktok-modal-info">
                <p><strong>💡 Meta ile farkı nedir?</strong></p>
                <p>Meta API token'ları uzun süreli (60 gün+) geçerlidir ve sürekli bağlı kalır. TikTok Business API ise güvenlik nedeniyle daha kısa süreli token'lar kullanır ve periyodik yenileme gerektirebilir.</p>
                <p>Bağlantı koptuğunda sistem otomatik olarak <strong>simüle edilmiş Türkiye verileri</strong> kullanmaya devam eder.</p>
            </div>
            
            <div class="tiktok-modal-actions" id="tiktokModalActions">
                <button class="tiktok-modal-btn primary" onclick="initTikTokAuth()">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M19.59 6.69a4.83 4.83 0 0 1-3.77-4.25V2h-3.45v13.67a2.89 2.89 0 0 1-5.2 1.74 2.89 2.89 0 0 1 2.31-4.64 2.93 2.93 0 0 1 .88.13V9.4a6.84 6.84 0 0 0-1-.05A6.33 6.33 0 0 0 5 20.1a6.34 6.34 0 0 0 10.86-4.43v-7a8.16 8.16 0 0 0 4.77 1.52v-3.4a4.85 4.85 0 0 1-1-.1z"/></svg>
                    TikTok Hesabını Bağla
                </button>
                <button class="tiktok-modal-btn secondary" onclick="closeTikTokModal()">Demo Mod</button>
            </div>
            
            <div class="tiktok-modal-footer">
                <p>App ID: <span id="tiktokAppIdDisplay"></span></p>
            </div>
        </div>
    </div>
    
    <div class="footer-actions" id="footerActions">
        <div class="footer-left"><span class="footer-count"><strong id="footerCount">0</strong> segment seçildi</span><div class="selected-chips" id="selectedChips"></div></div>
        <div class="footer-right">
            <button class="btn btn-secondary" onclick="clearSelection()">Temizle</button>
            <button class="btn btn-secondary" onclick="exportSelection()">📥 CSV</button>
            <button class="btn btn-primary" onclick="goToQuadrant()">Quadrant'a Gönder →</button>
        </div>
    </div>
    <script>
const segments = [
    { id: 'yasam-tarzi', name: 'Yaşam Tarzı', icon: '🌟', category: 'lifestyle', subs: [
        { id: 'yt-1', name: 'Trendsetter Öncüler', desc: 'Yeniliklere açık, trendleri belirleyen', reach: 8.2 },
        { id: 'yt-2', name: 'Statü Odaklı Profesyoneller', desc: 'Kariyer ve sosyal statü öncelikli', reach: 12.5 },
        { id: 'yt-3', name: 'Deneyim Avcıları', desc: 'Yeni deneyimler arayan maceraperestler', reach: 9.8 },
        { id: 'yt-4', name: 'Wellness Tutkunları', desc: 'Sağlık ve wellness odaklı yaşam', reach: 7.3 },
        { id: 'yt-5', name: 'Sürdürülebilir Yaşam', desc: 'Çevre dostu tercihler yapan', reach: 11.4 },
        { id: 'yt-6', name: 'Minimalistler', desc: 'Az ve öz yaşamı tercih eden', reach: 5.8 }
    ]},
    { id: 'tuketim', name: 'Tüketim Davranışı', icon: '🛒', category: 'davranis', subs: [
        { id: 'tk-1', name: 'Premium Tüketiciler', desc: 'Kaliteyi fiyatın önünde tutan', reach: 11.2 },
        { id: 'tk-2', name: 'Akıllı Alışverişçiler', desc: 'Araştırıp en iyiyi bulan', reach: 22.4 },
        { id: 'tk-3', name: 'Dürtüsel Alışverişçiler', desc: 'Anlık kararlarla alışveriş yapan', reach: 14.3 },
        { id: 'tk-4', name: 'Sadık Müşteriler', desc: 'Marka bağlılığı yüksek', reach: 18.6 },
        { id: 'tk-5', name: 'Fırsat Avcıları', desc: 'İndirim ve kampanya takipçisi', reach: 26.8 }
    ]},
    { id: 'dijital', name: 'Dijital Davranış', icon: '📱', category: 'davranis', subs: [
        { id: 'dj-1', name: 'Dijital Yerliler', desc: 'Hayatı dijitalde yaşayan Z kuşağı', reach: 22.4 },
        { id: 'dj-2', name: 'Sosyal Medya Aktifi', desc: 'Tüm platformlarda aktif paylaşımcı', reach: 28.6 },
        { id: 'dj-3', name: 'E-Ticaret Uzmanı', desc: 'Online alışverişi tercih eden', reach: 19.2 },
        { id: 'dj-4', name: 'Gamers', desc: 'Mobil ve PC oyuncuları', reach: 16.8 },
        { id: 'dj-5', name: 'İçerik Tüketicileri', desc: 'Video ve podcast takipçisi', reach: 31.2 }
    ]},
    { id: 'aile', name: 'Aile & Yaşam Evresi', icon: '👨‍👩‍👧‍👦', category: 'demografik', subs: [
        { id: 'al-1', name: 'Genç Bekarlar', desc: 'Kariyer başlangıcı, bağımsız yaşam', reach: 14.2 },
        { id: 'al-2', name: 'Yeni Evliler', desc: 'Yuva kuran çiftler', reach: 8.6 },
        { id: 'al-3', name: 'Genç Aileler', desc: '0-6 yaş çocuklu aileler', reach: 16.8 },
        { id: 'al-4', name: 'Büyüyen Aileler', desc: 'Okul çağı çocuklu aileler', reach: 14.2 },
        { id: 'al-5', name: 'Olgun Haneler', desc: 'Yetişkin çocuklu veya çocuksuz 45+ haneler', reach: 18.5 }
    ]},
    { id: 'gelir', name: 'Sosyo-Ekonomik', icon: '💰', category: 'demografik', subs: [
        { id: 'gl-1', name: 'Premium (A+)', desc: 'En yüksek gelir ve harcama', reach: 5.2 },
        { id: 'gl-2', name: 'Üst Segment (A)', desc: 'Yüksek alım gücü', reach: 12.8 },
        { id: 'gl-3', name: 'Orta Üst (B+)', desc: 'Konforlu orta sınıf', reach: 18.4 },
        { id: 'gl-4', name: 'Orta (B)', desc: 'Geniş orta segment', reach: 28.6 }
    ]},
    { id: 'medya', name: 'Medya Tüketimi', icon: '📺', category: 'davranis', subs: [
        { id: 'md-1', name: 'TV Bağımlıları', desc: 'Geleneksel TV ağırlıklı', reach: 32.3 },
        { id: 'md-2', name: 'Streaming Nesli', desc: 'Netflix, YouTube Premium', reach: 28.5 },
        { id: 'md-3', name: 'Podcast Dinleyicileri', desc: 'Sesli içerik takipçisi', reach: 12.4 },
        { id: 'md-4', name: 'Sosyal Video', desc: 'TikTok, Reels, Shorts izleyicisi', reach: 34.8 },
        { id: 'md-5', name: 'Haber Takipçileri', desc: 'Aktif haber okuyucusu', reach: 26.2 }
    ]},
    { id: 'otomotiv', name: 'Otomotiv', icon: '🚗', category: 'davranis', subs: [
        { id: 'ot-1', name: 'Premium Araç Sahipleri', desc: 'Lüks segment tercih eden', reach: 8.4 },
        { id: 'ot-2', name: 'SUV & Crossover', desc: 'Geniş aile aracı seven', reach: 15.2 },
        { id: 'ot-3', name: 'Elektrikli Araç İlgilileri', desc: 'EV ve hibrit meraklıları', reach: 9.8 }
    ]},
    { id: 'seyahat', name: 'Seyahat', icon: '✈️', category: 'lifestyle', subs: [
        { id: 'sy-1', name: 'Sık Seyahat Edenler', desc: 'Yılda 4+ uçuş yapan', reach: 12.4 },
        { id: 'sy-2', name: 'Tatilciler', desc: 'Yıllık tatil planlayıcısı', reach: 28.6 },
        { id: 'sy-3', name: 'İş Gezgini', desc: 'Profesyonel seyahat eden', reach: 9.8 }
    ]},
    { id: 'finans', name: 'Finansal Davranış', icon: '💳', category: 'davranis', subs: [
        { id: 'fn-1', name: 'Aktif Yatırımcılar', desc: 'Borsa ve kripto ilgili', reach: 14.6 },
        { id: 'fn-2', name: 'Tasarrufçular', desc: 'Birikim ve güvenlik odaklı', reach: 22.8 },
        { id: 'fn-3', name: 'Kredi Kullanıcıları', desc: 'Taksit ve kredi aktif', reach: 31.4 },
        { id: 'fn-4', name: 'Dijital Bankacılık', desc: 'Mobile-first bankacılık', reach: 45.2 },
        { id: 'fn-5', name: 'BNPL Kullanıcıları', desc: 'Şimdi al sonra öde tercih eden', reach: 18.6 }
    ]},
    { id: 'beslenme', name: 'Yeme-İçme', icon: '🍽️', category: 'lifestyle', subs: [
        { id: 'bs-1', name: 'Sağlıklı Beslenme', desc: 'Organik ve doğal tercih eden', reach: 18.4 },
        { id: 'bs-2', name: 'Foodie & Gurme', desc: 'Yemek kültürü meraklısı', reach: 14.2 },
        { id: 'bs-3', name: 'Hızlı Tüketim', desc: 'Fast food ve hazır gıda', reach: 24.6 }
    ]},
    { id: 'konut', name: 'Konut & Emlak', icon: '🏠', category: 'demografik', subs: [
        { id: 'kn-1', name: 'Ev Sahipleri', desc: 'Mülk sahibi haneler', reach: 42.5 },
        { id: 'kn-2', name: 'Kiracılar', desc: 'Kirada oturan haneler', reach: 38.2 },
        { id: 'kn-3', name: 'Ev Arayanlar', desc: 'Aktif emlak araştıran', reach: 12.8 },
        { id: 'kn-4', name: 'Yatırımcı', desc: 'Emlak yatırımı yapan', reach: 6.4 }
    ]},
    { id: 'influencers', name: 'B2C Etkileyiciler', icon: '⚡', category: 'b2c', subs: [
        { id: 'inf-1', name: 'Hane Halkları - Kesintisiz Enerji', desc: 'Güvenilir elektrik bekleyen', reach: 42.5 },
        { id: 'inf-2', name: 'Dijital Müşteriler', desc: 'Online işlem tercih eden', reach: 28.3 },
        { id: 'inf-3', name: 'Mobil Uygulama Kullanıcıları', desc: 'App üzerinden işlem yapan', reach: 35.6 },
        { id: 'inf-4', name: 'KOBİ Sahipleri', desc: 'Enerji maliyeti odaklı işletme', reach: 12.8 },
        { id: 'inf-5', name: 'Fiyat Hassas Tüketiciler', desc: 'Maliyet öncelikli karar veren', reach: 52.1 },
        { id: 'inf-6', name: 'Sosyal Medya Takipçileri', desc: 'Marka etkileşimi yüksek', reach: 48.2 }
    ]},
    { id: 'gatekeeper', name: 'B2B Gatekeepers', icon: '🏛️', category: 'b2b', subs: [
        { id: 'gk-1', name: 'Yerel Yönetimler', desc: 'Belediyeler ve kamu kurumları', reach: 2.4 },
        { id: 'gk-2', name: 'Toplum Liderleri', desc: 'Muhtarlar ve kanaat önderleri', reach: 4.8 },
        { id: 'gk-3', name: 'STK & Sivil Toplum', desc: 'Çevre ve sosyal sorumluluk', reach: 1.6 },
        { id: 'gk-4', name: 'Akademi & Araştırma', desc: 'Üniversiteler ve enstitüler', reach: 0.8 },
        { id: 'gk-5', name: 'Medya & Basın', desc: 'Gazeteciler ve editörler', reach: 3.5 },
        { id: 'gk-6', name: 'Sektör Uzmanları', desc: 'Enerji analistleri', reach: 0.5 }
    ]},
    { id: 'decisionmaker', name: 'B2B Karar Vericiler', icon: '🎯', category: 'b2b', subs: [
        { id: 'dm-1', name: 'Kamu Regülatörleri', desc: 'EPDK, Bakanlıklar', reach: 0.3 },
        { id: 'dm-2', name: 'Kurumsal Yatırımcılar', desc: 'ESG odaklı fonlar', reach: 0.8 },
        { id: 'dm-3', name: 'Bireysel Yatırımcılar', desc: 'Hisse ve fon takipçileri', reach: 3.5 },
        { id: 'dm-4', name: 'Stratejik Ortaklar', desc: 'İş geliştirme partnerleri', reach: 1.4 },
        { id: 'dm-5', name: 'Finans Kuruluşları', desc: 'Bankalar ve fonlar', reach: 0.6 }
    ]}
];

const INTEREST_RECOMMENDATIONS = {
    // Yaşam Tarzı
    'yt-1': { keyword: 'early adopter technology', name: 'Technology early adopters' },
    'yt-2': { keyword: 'business executive', name: 'Business and industry' },
    'yt-3': { keyword: 'adventure outdoor', name: 'Outdoor recreation' },
    'yt-4': { keyword: 'fitness wellness', name: 'Physical fitness' },
    'yt-5': { keyword: 'sustainability eco', name: 'Environmentalism' },
    'yt-6': { keyword: 'minimalism lifestyle', name: 'Minimalism' },
    
    // Tüketim Davranışı
    'tk-1': { keyword: 'luxury shopping', name: 'Luxury goods' },
    'tk-2': { keyword: 'online shopping', name: 'Online shopping' },
    'tk-3': { keyword: 'shopping fashion', name: 'Shopping and fashion' },
    'tk-4': { keyword: 'brand loyalty', name: 'Brand awareness' },
    'tk-5': { keyword: 'coupons deals', name: 'Coupons' },
    
    // Dijital Davranış
    'dj-1': { keyword: 'technology gadgets', name: 'Consumer electronics' },
    'dj-2': { keyword: 'social media', name: 'Social media' },
    'dj-3': { keyword: 'online shopping ecommerce', name: 'Online shopping' },
    'dj-4': { keyword: 'video games gaming', name: 'Video games' },
    'dj-5': { keyword: 'streaming video', name: 'Entertainment' },
    
    // Aile & Yaşam Evresi
    'al-1': { keyword: 'young professionals career', name: 'Career' },
    'al-2': { keyword: 'wedding marriage', name: 'Weddings' },
    'al-3': { keyword: 'parenting babies toddler', name: 'Parenting' },
    'al-4': { keyword: 'family children school', name: 'Family' },
    'al-5': { keyword: 'travel leisure retirement', name: 'Travel' },
    
    // Sosyo-Ekonomik
    'gl-1': { keyword: 'luxury premium', name: 'Luxury goods' },
    'gl-2': { keyword: 'investment wealth', name: 'Investing' },
    'gl-3': { keyword: 'shopping lifestyle', name: 'Shopping and fashion' },
    'gl-4': { keyword: 'value shopping', name: 'Online shopping' },
    
    // Medya Tüketimi
    'md-1': { keyword: 'television tv', name: 'Television' },
    'md-2': { keyword: 'streaming netflix', name: 'Entertainment' },
    'md-3': { keyword: 'podcasts audio', name: 'Podcasts' },
    'md-4': { keyword: 'tiktok short video', name: 'TikTok' },
    'md-5': { keyword: 'news media', name: 'News and media' },
    
    // Otomotiv
    'ot-1': { keyword: 'luxury cars', name: 'Automobiles' },
    'ot-2': { keyword: 'suv crossover', name: 'SUVs' },
    'ot-3': { keyword: 'electric vehicles ev', name: 'Electric vehicle' },
    
    // Seyahat
    'sy-1': { keyword: 'frequent traveler', name: 'Air travel' },
    'sy-2': { keyword: 'vacation holiday', name: 'Tourism' },
    'sy-3': { keyword: 'business travel', name: 'Business travel' },
    
    // Finansal Davranış
    'fn-1': { keyword: 'investing stocks crypto', name: 'Investing' },
    'fn-2': { keyword: 'savings finance', name: 'Personal finance' },
    'fn-3': { keyword: 'credit card loans', name: 'Credit cards' },
    'fn-4': { keyword: 'mobile banking', name: 'Online banking' },
    'fn-5': { keyword: 'buy now pay later', name: 'Online shopping' },
    
    // Yeme-İçme
    'bs-1': { keyword: 'healthy organic food', name: 'Organic food' },
    'bs-2': { keyword: 'foodie restaurants', name: 'Restaurants' },
    'bs-3': { keyword: 'fast food delivery', name: 'Fast food restaurants' },
    
    // Konut & Emlak
    'kn-1': { keyword: 'homeowners home', name: 'Home improvement' },
    'kn-2': { keyword: 'rental apartment', name: 'Apartment' },
    'kn-3': { keyword: 'real estate property', name: 'Real estate' },
    'kn-4': { keyword: 'property investment', name: 'Real estate investing' },
    
    // B2C Etkileyiciler
    'inf-1': { keyword: 'home improvement', name: 'Home improvement' },
    'inf-2': { keyword: 'online services digital', name: 'Online shopping' },
    'inf-3': { keyword: 'mobile apps smartphone', name: 'Smartphones' },
    'inf-4': { keyword: 'small business owner', name: 'Small business' },
    'inf-5': { keyword: 'bargain deals discount', name: 'Coupons' },
    'inf-6': { keyword: 'social media followers', name: 'Social media' },
    
    // B2B Gatekeepers
    'gk-1': { keyword: 'government public', name: 'Politics and social issues' },
    'gk-2': { keyword: 'community local', name: 'Community' },
    'gk-3': { keyword: 'nonprofit charity', name: 'Charity and causes' },
    'gk-4': { keyword: 'higher education research', name: 'Higher education' },
    'gk-5': { keyword: 'journalism media', name: 'Journalism' },
    'gk-6': { keyword: 'energy industry', name: 'Energy industry' },
    
    // B2B Karar Vericiler
    'dm-1': { keyword: 'government policy', name: 'Politics and social issues' },
    'dm-2': { keyword: 'esg investing sustainable', name: 'Investing' },
    'dm-3': { keyword: 'stock market trading', name: 'Investing' },
    'dm-4': { keyword: 'b2b business', name: 'Business' },
    'dm-5': { keyword: 'banking finance', name: 'Banking' }
};

let selectedSegments = new Set();
let activeFunnel = null;
let currentSuggestions = [];
let META_SEGMENT_MAP = {};
let metaDataCache = {};

const funnelSegments = {
    awareness: ['yt-1','yt-3','yt-5','dj-2','dj-5','md-2','md-4','md-5','inf-1','inf-6','gk-1','gk-2','gk-3','gk-5','bs-2','sy-2','kn-1'],
    consideration: ['yt-2','yt-4','tk-1','tk-2','dj-1','dj-3','dj-4','al-3','al-4','md-3','inf-2','inf-3','gk-4','gk-6','dm-2','dm-3','fn-1','fn-4','fn-5','ot-3','kn-3'],
    conversion: ['tk-3','tk-4','tk-5','al-1','al-2','fn-2','fn-3','inf-4','inf-5','gk-1','dm-1','dm-4','dm-5','kn-2','kn-4','bs-1','bs-3']
};

const META_CONFIG = { 
    accessToken: 'EAAYe5SrdjKgBQZAZAZCh5uE3KLAyOrABkdC5gZCZBcLwdzaAXOKAjGVP7puJt2IijGivXAtQZCd6tbPrkDSoK9JRfWZBHsq2CuqdkL4L33a0xWDbZAyQxuwSjA62eZB3GcZBB6FXWueGyExbs3zZApqbB5IlEZCOfMM1zPjqKYaQF1N2TYZCoAfEfbLgWJZBFz0tggiOnKRwZDZD', 
    adAccountId: '1449083392081509', 
    apiVersion: 'v18.0' 
};

const TIKTOK_CONFIG = {
    appId: '7598110409156984833',
    appSecret: '', // Backend'de tutuluyor, frontend'de gerekmez
    redirectUri: 'https://growity-ai-lab.github.io/atlas/',
    accessToken: localStorage.getItem('tiktokAccessToken') || '',
    advertiserId: localStorage.getItem('tiktokAdvertiserId') || '',
    apiVersion: 'v1.3',
    authUrl: 'https://business-api.tiktok.com/portal/auth',
    backendUrl: 'https://atlas-taupe-alpha.vercel.app' // Backend Proxy URL
};

// Platform state
let activePlatform = 'meta';
let PLATFORM_SEGMENT_MAP = {
    meta: {},
    tiktok: {},
    google: {}
};
let platformDataCache = {
    meta: {},
    tiktok: {},
    google: {}
};

// TikTok Interest kategorileri (Türkiye pazarı - simüle edilmiş, gerçek API'den gelecek)
const TIKTOK_INTEREST_CATEGORIES = {
    // Ana Kategoriler
    'technology': { id: '25001', name: 'Teknoloji', audience_size: 8500000, subcategories: ['Akıllı Telefon', 'Bilgisayar', 'Yazılım'] },
    'fashion': { id: '25002', name: 'Moda', audience_size: 12000000, subcategories: ['Streetwear', 'Lüks Moda', 'Vintage'] },
    'food': { id: '25003', name: 'Yemek & Tarif', audience_size: 15000000, subcategories: ['Türk Mutfağı', 'Vegan', 'Fast Food'] },
    'travel': { id: '25004', name: 'Seyahat', audience_size: 6500000, subcategories: ['Yurt İçi', 'Yurt Dışı', 'Macera'] },
    'fitness': { id: '25005', name: 'Fitness & Spor', audience_size: 7200000, subcategories: ['Gym', 'Yoga', 'Koşu'] },
    'gaming': { id: '25006', name: 'Oyun', audience_size: 9800000, subcategories: ['Mobile Gaming', 'PC Gaming', 'E-Spor'] },
    'music': { id: '25007', name: 'Müzik', audience_size: 18000000, subcategories: ['Pop', 'Rap/Hip-Hop', 'Türk Sanat'] },
    'beauty': { id: '25008', name: 'Güzellik & Makyaj', audience_size: 11000000, subcategories: ['Skincare', 'Makyaj', 'Saç Bakımı'] },
    'sports': { id: '25009', name: 'Spor', audience_size: 8000000, subcategories: ['Futbol', 'Basketbol', 'Voleybol'] },
    'business': { id: '25010', name: 'İş & Kariyer', audience_size: 4500000, subcategories: ['Girişimcilik', 'Freelance', 'Kariyer'] },
    'education': { id: '25011', name: 'Eğitim', audience_size: 5200000, subcategories: ['Dil Öğrenimi', 'Sınav Hazırlık', 'Online Kurs'] },
    'entertainment': { id: '25012', name: 'Eğlence', audience_size: 22000000, subcategories: ['Komedi', 'Drama', 'Reality'] },
    'family': { id: '25013', name: 'Aile & Çocuk', audience_size: 9500000, subcategories: ['Bebek Bakımı', 'Çocuk Aktiviteleri', 'Aile Yaşamı'] },
    'finance': { id: '25014', name: 'Finans & Yatırım', audience_size: 3800000, subcategories: ['Borsa', 'Kripto', 'Tasarruf'] },
    'home': { id: '25015', name: 'Ev & Dekorasyon', audience_size: 6800000, subcategories: ['DIY', 'İç Mekan', 'Bahçe'] },
    'automotive': { id: '25016', name: 'Otomotiv', audience_size: 4200000, subcategories: ['Araba İncelemeleri', 'Modifiye', 'Elektrikli Araç'] },
    'pets': { id: '25017', name: 'Evcil Hayvan', audience_size: 5500000, subcategories: ['Kedi', 'Köpek', 'Egzotik'] },
    'shopping': { id: '25018', name: 'Alışveriş', audience_size: 16000000, subcategories: ['Online Shopping', 'İndirim', 'Lüks'] },
    'wellness': { id: '25019', name: 'Sağlık & Wellness', audience_size: 7800000, subcategories: ['Mental Sağlık', 'Beslenme', 'Meditasyon'] },
    'parenting': { id: '25020', name: 'Ebeveynlik', audience_size: 8200000, subcategories: ['Hamilelik', 'Bebek', 'Çocuk Eğitimi'] },
    
    // Türkiye'ye Özel Ek Kategoriler
    'turkishcontent': { id: '25021', name: 'Türk İçerik Üreticileri', audience_size: 14000000, subcategories: ['Influencer', 'Vlogger', 'Komedyen'] },
    'dizi': { id: '25022', name: 'Dizi & Film', audience_size: 16500000, subcategories: ['Türk Dizileri', 'Netflix', 'Sinema'] },
    'wedding': { id: '25023', name: 'Düğün & Nişan', audience_size: 4800000, subcategories: ['Gelin', 'Organizasyon', 'Mekan'] },
    'realestate': { id: '25024', name: 'Emlak', audience_size: 3200000, subcategories: ['Ev Alma', 'Kiralama', 'Yatırım'] },
    'career': { id: '25025', name: 'Kariyer & İş Arama', audience_size: 5800000, subcategories: ['CV Hazırlama', 'Mülakat', 'Remote Work'] },
    'student': { id: '25026', name: 'Öğrenci Hayatı', audience_size: 7500000, subcategories: ['Üniversite', 'YKS/LGS', 'Erasmus'] },
    'coffee': { id: '25027', name: 'Kahve Kültürü', audience_size: 6200000, subcategories: ['3. Dalga', 'Türk Kahvesi', 'Cafe'] },
    'sustainability': { id: '25028', name: 'Sürdürülebilirlik', audience_size: 2800000, subcategories: ['Zero Waste', 'Vegan Yaşam', 'Eko Ürünler'] },
    'luxury': { id: '25029', name: 'Lüks Yaşam', audience_size: 2400000, subcategories: ['Premium Markalar', 'VIP', 'Koleksiyon'] },
    'nightlife': { id: '25030', name: 'Gece Hayatı', audience_size: 4100000, subcategories: ['Mekanlar', 'Etkinlikler', 'DJ/Parti'] }
};

// TikTok - Segment eşleştirme önerileri
const TIKTOK_SEGMENT_RECOMMENDATIONS = {
    'yt-1': { keyword: 'technology', name: 'Teknoloji' },
    'yt-2': { keyword: 'business', name: 'İş & Kariyer' },
    'yt-3': { keyword: 'travel', name: 'Seyahat' },
    'yt-4': { keyword: 'wellness', name: 'Sağlık & Wellness' },
    'yt-5': { keyword: 'sustainability', name: 'Sürdürülebilirlik' },
    'yt-6': { keyword: 'home', name: 'Ev & Dekorasyon' },
    'tk-1': { keyword: 'luxury', name: 'Lüks Yaşam' },
    'tk-2': { keyword: 'shopping', name: 'Alışveriş' },
    'tk-3': { keyword: 'shopping', name: 'Alışveriş' },
    'tk-4': { keyword: 'shopping', name: 'Alışveriş' },
    'tk-5': { keyword: 'shopping', name: 'Alışveriş' },
    'dj-1': { keyword: 'technology', name: 'Teknoloji' },
    'dj-2': { keyword: 'turkishcontent', name: 'Türk İçerik Üreticileri' },
    'dj-3': { keyword: 'shopping', name: 'Alışveriş' },
    'dj-4': { keyword: 'gaming', name: 'Oyun' },
    'dj-5': { keyword: 'entertainment', name: 'Eğlence' },
    'al-1': { keyword: 'career', name: 'Kariyer & İş Arama' },
    'al-2': { keyword: 'wedding', name: 'Düğün & Nişan' },
    'al-3': { keyword: 'parenting', name: 'Ebeveynlik' },
    'al-4': { keyword: 'family', name: 'Aile & Çocuk' },
    'al-5': { keyword: 'travel', name: 'Seyahat' },
    'gl-1': { keyword: 'luxury', name: 'Lüks Yaşam' },
    'gl-2': { keyword: 'finance', name: 'Finans & Yatırım' },
    'gl-3': { keyword: 'shopping', name: 'Alışveriş' },
    'gl-4': { keyword: 'shopping', name: 'Alışveriş' },
    'md-1': { keyword: 'dizi', name: 'Dizi & Film' },
    'md-2': { keyword: 'entertainment', name: 'Eğlence' },
    'md-3': { keyword: 'entertainment', name: 'Eğlence' },
    'md-4': { keyword: 'turkishcontent', name: 'Türk İçerik Üreticileri' },
    'md-5': { keyword: 'turkishcontent', name: 'Türk İçerik Üreticileri' },
    'ot-1': { keyword: 'automotive', name: 'Otomotiv' },
    'ot-2': { keyword: 'automotive', name: 'Otomotiv' },
    'ot-3': { keyword: 'automotive', name: 'Otomotiv' },
    'sy-1': { keyword: 'travel', name: 'Seyahat' },
    'sy-2': { keyword: 'travel', name: 'Seyahat' },
    'sy-3': { keyword: 'business', name: 'İş & Kariyer' },
    'fn-1': { keyword: 'finance', name: 'Finans & Yatırım' },
    'fn-2': { keyword: 'finance', name: 'Finans & Yatırım' },
    'fn-3': { keyword: 'finance', name: 'Finans & Yatırım' },
    'fn-4': { keyword: 'technology', name: 'Teknoloji' },
    'fn-5': { keyword: 'shopping', name: 'Alışveriş' },
    'bs-1': { keyword: 'wellness', name: 'Sağlık & Wellness' },
    'bs-2': { keyword: 'food', name: 'Yemek & Tarif' },
    'bs-3': { keyword: 'food', name: 'Yemek & Tarif' },
    'kn-1': { keyword: 'home', name: 'Ev & Dekorasyon' },
    'kn-2': { keyword: 'realestate', name: 'Emlak' },
    'kn-3': { keyword: 'realestate', name: 'Emlak' },
    'kn-4': { keyword: 'finance', name: 'Finans & Yatırım' },
    'inf-1': { keyword: 'home', name: 'Ev & Dekorasyon' },
    'inf-2': { keyword: 'technology', name: 'Teknoloji' },
    'inf-3': { keyword: 'technology', name: 'Teknoloji' },
    'inf-4': { keyword: 'business', name: 'İş & Kariyer' },
    'inf-5': { keyword: 'shopping', name: 'Alışveriş' },
    'inf-6': { keyword: 'turkishcontent', name: 'Türk İçerik Üreticileri' }
};

function switchPlatform(platform) {
    activePlatform = platform;
    
    // Tab'ları güncelle
    document.querySelectorAll('.platform-tab').forEach(tab => {
        tab.classList.remove('active');
        if (tab.dataset.platform === platform) {
            tab.classList.add('active');
        }
    });
    
    // Status'u güncelle
    const status = document.getElementById('metaStatus');
    if (platform === 'meta') {
        status.textContent = 'Meta Hazır';
        status.className = 'meta-status connected';
    } else if (platform === 'tiktok') {
        if (TIKTOK_CONFIG.accessToken) {
            status.textContent = 'TikTok Bağlı ✓';
            status.className = 'meta-status connected';
        } else {
            status.textContent = 'TikTok - Bağlan';
            status.className = 'meta-status';
        }
    } else if (platform === 'google') {
        status.textContent = 'Google (Yakında)';
        status.className = 'meta-status';
    }
    
    // Placeholder'ı güncelle
    const searchInput = document.getElementById('interestSearch');
    if (platform === 'tiktok') {
        searchInput.placeholder = 'TikTok interest ara (ör: gaming, music)...';
    } else {
        searchInput.placeholder = 'Interest ara (ör: travel)...';
    }
    
    // TikTok connection UI'ı güncelle (buton durumu)
    updateTikTokConnectionUI();
    
    // Sonuçları gizle
    document.getElementById('interestResults').style.display = 'none';
    
    // Sayaçları güncelle
    updateMetaCount();
}

// TikTok OAuth Functions
function initTikTokAuth() {
    const state = 'atlas_' + Date.now(); // CSRF protection
    localStorage.setItem('tiktokAuthState', state);
    
    const authUrl = `${TIKTOK_CONFIG.authUrl}?app_id=${TIKTOK_CONFIG.appId}&state=${state}&redirect_uri=${encodeURIComponent(TIKTOK_CONFIG.redirectUri)}`;
    
    window.location.href = authUrl;
}

function handleTikTokCallback() {
    // Debug: Mevcut token durumunu kontrol et
    console.log('🎵 TikTok Init Check:', {
        savedToken: localStorage.getItem('tiktokAccessToken') ? 'EXISTS' : 'NONE',
        savedAdvertiserId: localStorage.getItem('tiktokAdvertiserId') || 'NONE',
        configToken: TIKTOK_CONFIG.accessToken ? 'LOADED' : 'EMPTY'
    });
    
    // URL'den auth_code ve state'i al
    const urlParams = new URLSearchParams(window.location.search);
    const authCode = urlParams.get('auth_code');
    const state = urlParams.get('state');
    const savedState = localStorage.getItem('tiktokAuthState');
    
    console.log('🎵 TikTok Callback Check:', { authCode: authCode ? 'FOUND' : 'NONE', state, savedState });
    
    if (authCode) {
        // State doğrulama (CSRF protection)
        if (state && savedState && state !== savedState) {
            showToast('Güvenlik hatası: State eşleşmedi', 'error');
            console.error('TikTok State mismatch:', { state, savedState });
            return;
        }
        
        // Auth code ile access token al
        exchangeTikTokToken(authCode);
        
        // URL'i temizle
        window.history.replaceState({}, document.title, window.location.pathname);
    }
}

function exchangeTikTokToken(authCode) {
    showToast('🎵 TikTok bağlantısı kuruluyor...', 'info');
    console.log('🎵 TikTok Token Exchange Started:', { 
        backendUrl: TIKTOK_CONFIG.backendUrl,
        authCodeLength: authCode?.length 
    });
    
    // Backend proxy üzerinden token al
    fetch(`${TIKTOK_CONFIG.backendUrl}/api/tiktok/token`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            auth_code: authCode
        })
    })
    .then(res => {
        console.log('🎵 TikTok API Response Status:', res.status);
        return res.json();
    })
    .then(data => {
        console.log('🎵 TikTok API Response Data:', data);
        
        if (data.success && data.data) {
            // Token'ları kaydet
            TIKTOK_CONFIG.accessToken = data.data.access_token;
            localStorage.setItem('tiktokAccessToken', data.data.access_token);
            console.log('🎵 TikTok Access Token Saved');
            
            if (data.data.advertiser_ids && data.data.advertiser_ids.length > 0) {
                TIKTOK_CONFIG.advertiserId = data.data.advertiser_ids[0];
                localStorage.setItem('tiktokAdvertiserId', data.data.advertiser_ids[0]);
                console.log('🎵 TikTok Advertiser ID Saved:', data.data.advertiser_ids[0]);
            } else {
                console.warn('🎵 TikTok: No advertiser_ids in response');
            }
            
            showToast('🎵 TikTok başarıyla bağlandı!', 'success');
            updateTikTokConnectionUI();
            closeTikTokModal(); // Modal'ı kapat
            switchPlatform('tiktok');
        } else {
            console.error('🎵 TikTok token error:', data);
            showToast('TikTok bağlantı hatası: ' + (data.error || data.message || 'Bilinmeyen hata'), 'error');
        }
    })
    .catch(err => {
        console.error('🎵 TikTok auth error:', err);
        showToast('TikTok bağlantı hatası. Lütfen tekrar deneyin.', 'error');
    });
}

function updateTikTokConnectionUI() {
    const tiktokDot = document.getElementById('tiktokConnectionDot');
    const tiktokConnectBtn = document.getElementById('tiktokConnectBtn');
    
    // Connection dot'u güncelle
    if (tiktokDot) {
        if (TIKTOK_CONFIG.accessToken) {
            tiktokDot.classList.add('connected');
        } else {
            tiktokDot.classList.remove('connected');
        }
    }
    
    // Connect butonunu güncelle
    if (tiktokConnectBtn) {
        if (TIKTOK_CONFIG.accessToken) {
            tiktokConnectBtn.classList.add('connected');
            tiktokConnectBtn.title = 'TikTok Bağlı - Ayarları Aç';
        } else {
            tiktokConnectBtn.classList.remove('connected');
            tiktokConnectBtn.title = 'TikTok Hesabını Bağla';
        }
    }
    
    // Modal içeriğini güncelle
    updateTikTokModalContent();
}

function showTikTokConnectionModal() {
    const modal = document.getElementById('tiktokModal');
    updateTikTokModalContent();
    modal.classList.add('visible');
    
    // ESC tuşu ile kapatma
    document.addEventListener('keydown', handleTikTokModalEsc);
}

function closeTikTokModal() {
    const modal = document.getElementById('tiktokModal');
    modal.classList.remove('visible');
    document.removeEventListener('keydown', handleTikTokModalEsc);
}

function handleTikTokModalEsc(e) {
    if (e.key === 'Escape') closeTikTokModal();
}

function updateTikTokModalContent() {
    const statusDiv = document.getElementById('tiktokModalStatus');
    const statusTitle = document.getElementById('tiktokStatusTitle');
    const statusDesc = document.getElementById('tiktokStatusDesc');
    const actionsDiv = document.getElementById('tiktokModalActions');
    const appIdDisplay = document.getElementById('tiktokAppIdDisplay');
    
    if (appIdDisplay) {
        appIdDisplay.textContent = TIKTOK_CONFIG.appId;
    }
    
    if (TIKTOK_CONFIG.accessToken) {
        // Bağlı durumu
        statusDiv.className = 'tiktok-modal-status connected';
        statusDiv.querySelector('.tiktok-modal-status-icon').textContent = '✓';
        statusTitle.textContent = 'Bağlantı Aktif';
        statusDesc.textContent = TIKTOK_CONFIG.advertiserId 
            ? 'Advertiser ID: ' + TIKTOK_CONFIG.advertiserId 
            : 'TikTok Business hesabınız bağlı';
        
        actionsDiv.innerHTML = `
            <button class="tiktok-modal-btn secondary" onclick="refreshTikTokToken()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"/><path d="M16 16h5v5"/></svg>
                Token Yenile
            </button>
            <button class="tiktok-modal-btn danger" onclick="confirmDisconnectTikTok()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18.36 6.64a9 9 0 1 1-12.73 0"/><line x1="12" x2="12" y1="2" y2="12"/></svg>
                Bağlantıyı Kes
            </button>
        `;
    } else {
        // Bağlı değil durumu
        statusDiv.className = 'tiktok-modal-status disconnected';
        statusDiv.querySelector('.tiktok-modal-status-icon').textContent = '🔌';
        statusTitle.textContent = 'Bağlantı Yok';
        statusDesc.textContent = 'TikTok Ads Manager hesabınız bağlı değil';
        
        actionsDiv.innerHTML = `
            <button class="tiktok-modal-btn primary" onclick="initTikTokAuth()">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M19.59 6.69a4.83 4.83 0 0 1-3.77-4.25V2h-3.45v13.67a2.89 2.89 0 0 1-5.2 1.74 2.89 2.89 0 0 1 2.31-4.64 2.93 2.93 0 0 1 .88.13V9.4a6.84 6.84 0 0 0-1-.05A6.33 6.33 0 0 0 5 20.1a6.34 6.34 0 0 0 10.86-4.43v-7a8.16 8.16 0 0 0 4.77 1.52v-3.4a4.85 4.85 0 0 1-1-.1z"/></svg>
                TikTok Hesabını Bağla
            </button>
            <button class="tiktok-modal-btn secondary" onclick="closeTikTokModal()">Demo Mod ile Devam</button>
        `;
    }
}

function confirmDisconnectTikTok() {
    if (confirm('TikTok bağlantısını kesmek istediğinize emin misiniz?')) {
        disconnectTikTok();
        closeTikTokModal();
    }
}

function refreshTikTokToken() {
    showToast('🔄 Token yenileniyor...', 'info');
    // Gerçek uygulamada refresh token kullanılır
    // Şimdilik yeniden auth başlat
    initTikTokAuth();
}

function disconnectTikTok() {
    TIKTOK_CONFIG.accessToken = '';
    TIKTOK_CONFIG.advertiserId = '';
    localStorage.removeItem('tiktokAccessToken');
    localStorage.removeItem('tiktokAdvertiserId');
    showToast('TikTok bağlantısı kaldırıldı', 'info');
    updateTikTokConnectionUI();
    switchPlatform('tiktok');
}

function init() {
    // TikTok OAuth callback kontrolü
    handleTikTokCallback();
    
    renderSegments();
    setupEventListeners();
    checkOnboardingState();
    loadSavedMappings();
    loadTikTokMappings();
    updateMetaCount();
    
    // TikTok bağlantı durumunu UI'da göster
    updateTikTokConnectionUI();
}

function setupEventListeners() {
    document.querySelectorAll('.filter-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.filter-btn').forEach(function(b) { b.classList.remove('active'); });
            btn.classList.add('active');
            renderSegments(btn.dataset.filter, document.getElementById('searchInput').value);
        });
    });
    
    // Debounced search - 300ms bekle sonra filtrele
    var searchInput = document.getElementById('searchInput');
    var debouncedSearch = debounce(function(value) {
        var activeFilter = document.querySelector('.filter-btn.active');
        renderSegments(activeFilter ? activeFilter.dataset.filter : 'all', value);
    }, 300);
    
    searchInput.addEventListener('input', function(e) {
        debouncedSearch(e.target.value);
    });
    
    document.getElementById('interestSearch').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') searchInterest();
    });
}

// === DEBOUNCE HELPER ===
function debounce(func, wait) {
    var timeout;
    return function() {
        var context = this, args = arguments;
        clearTimeout(timeout);
        timeout = setTimeout(function() {
            func.apply(context, args);
        }, wait);
    };
}

function checkOnboardingState() {
    if (localStorage.getItem('onboardingHidden') === 'true') {
        document.getElementById('onboarding').classList.add('hidden');
        document.getElementById('onboardingToggle').classList.add('visible');
    }
}

function toggleOnboarding() {
    var onboarding = document.getElementById('onboarding');
    var toggle = document.getElementById('onboardingToggle');
    if (onboarding.classList.contains('hidden')) {
        onboarding.classList.remove('hidden');
        toggle.classList.remove('visible');
        localStorage.setItem('onboardingHidden', 'false');
    } else {
        onboarding.classList.add('hidden');
        toggle.classList.add('visible');
        localStorage.setItem('onboardingHidden', 'true');
    }
}

function renderSegments(filter, search) {
    filter = filter || 'all';
    search = search || '';
    var grid = document.getElementById('segmentGrid');
    grid.innerHTML = '';
    
    var filtered = segments.filter(function(parent) {
        if (filter !== 'all' && parent.category !== filter) return false;
        if (search) {
            var s = search.toLowerCase();
            if (parent.name.toLowerCase().indexOf(s) !== -1) return true;
            for (var i = 0; i < parent.subs.length; i++) {
                if (parent.subs[i].name.toLowerCase().indexOf(s) !== -1) return true;
                if (parent.subs[i].desc.toLowerCase().indexOf(s) !== -1) return true;
            }
            return false;
        }
        return true;
    });
    
    if (filtered.length === 0) {
        grid.innerHTML = '<div class="empty-state"><div class="empty-state-icon">🔍</div><h3>Segment bulunamadı</h3></div>';
        return;
    }
    
    filtered.forEach(function(parent, idx) {
        var selectedInParent = parent.subs.filter(function(s) { return selectedSegments.has(s.id); }).length;
        var hasSelected = selectedInParent > 0;
        var card = document.createElement('div');
        card.className = 'parent-card' + (hasSelected ? ' has-selected' : '');
        card.dataset.parent = parent.id;
        card.style.animationDelay = (idx * 0.05) + 's';
        
        var subsHtml = '';
        parent.subs.forEach(function(sub) {
            var metaMapping = META_SEGMENT_MAP[sub.id];
            var tiktokMapping = PLATFORM_SEGMENT_MAP.tiktok[sub.id];
            var isSelected = selectedSegments.has(sub.id);
            
            // Platform badge'leri oluştur
            var platformBadges = '';
            if (metaMapping) {
                platformBadges += '<span class="platform-badge meta" title="Meta: ' + metaMapping.interests[0].name + '">📘 ' + metaMapping.interests[0].name + '</span>';
            }
            if (tiktokMapping) {
                platformBadges += '<span class="platform-badge tiktok" title="TikTok: ' + tiktokMapping.interests[0].name + '">🎵 ' + tiktokMapping.interests[0].name + '</span>';
            }
            if (!metaMapping && !tiktokMapping) {
                platformBadges = '<span class="platform-badge empty">📊 --</span>';
            }
            
            subsHtml += '<div class="sub-segment' + (isSelected ? ' selected' : '') + '" onclick="toggleSegment(\'' + sub.id + '\')">' +
                '<div class="checkbox' + (isSelected ? ' checked' : '') + '"></div>' +
                '<div class="sub-info"><div class="sub-name">' + sub.name + '</div><div class="sub-desc">' + sub.desc + '</div></div>' +
                '<div class="sub-meta"><span class="meta-tag">' + sub.reach + '%</span>' +
                '<div class="platform-badges">' + platformBadges + '</div></div></div>';
        });
        
        card.innerHTML = '<div class="parent-header" onclick="toggleParent(\'' + parent.id + '\')">' +
            '<div class="parent-left"><div class="parent-icon">' + parent.icon + '</div><div>' +
            '<div class="parent-name">' + parent.name + '</div>' +
            '<div class="parent-count">' + parent.subs.length + ' segment' + (selectedInParent > 0 ? ' • <span style="color:var(--accent-green)">' + selectedInParent + ' seçili</span>' : '') + '</div></div></div>' +
            '<div class="parent-actions"><button class="select-all-btn" onclick="event.stopPropagation();selectAllInParent(\'' + parent.id + '\')">' + 
            (selectedInParent === parent.subs.length ? 'Kaldır' : 'Tümü') + '</button><span class="expand-icon">▼</span></div></div>' +
            '<div class="sub-segments">' + subsHtml + '</div>';
        grid.appendChild(card);
    });
}

function toggleParent(parentId) {
    var card = document.querySelector('[data-parent="' + parentId + '"]');
    card.classList.toggle('expanded');
}

let allCategoriesExpanded = false;

function toggleAllCategories() {
    var cards = document.querySelectorAll('.parent-card');
    var btn = document.getElementById('toggleAllBtn');
    
    allCategoriesExpanded = !allCategoriesExpanded;
    
    cards.forEach(function(card) {
        if (allCategoriesExpanded) {
            card.classList.add('expanded');
        } else {
            card.classList.remove('expanded');
        }
    });
    
    btn.innerHTML = allCategoriesExpanded ? 
        '<span class="icon" style="margin-right:4px;">📁</span> Tümünü Kapat' : 
        '<span class="icon" style="margin-right:4px;">📂</span> Tümünü Aç';
}

function toggleSegment(segmentId) {
    if (selectedSegments.has(segmentId)) {
        selectedSegments.delete(segmentId);
    } else {
        selectedSegments.add(segmentId);
    }
    updateUI();
    updateSteps();
}

function selectAllInParent(parentId) {
    var parent = segments.find(function(p) { return p.id === parentId; });
    var allSelected = parent.subs.every(function(s) { return selectedSegments.has(s.id); });
    parent.subs.forEach(function(sub) {
        if (allSelected) { selectedSegments.delete(sub.id); }
        else { selectedSegments.add(sub.id); }
    });
    updateUI();
    updateSteps();
}

function selectFunnel(funnel) {
    var btn = document.getElementById('funnel-' + funnel);
    var wasActive = btn.classList.contains('active');
    document.querySelectorAll('.quick-action').forEach(function(b) { b.classList.remove('active'); });
    
    if (wasActive) {
        activeFunnel = null;
        clearSelection();
        closeSuggestions();
    } else {
        btn.classList.add('active');
        activeFunnel = funnel;
        selectedSegments.clear();
        funnelSegments[funnel].forEach(function(segId) {
            if (findSegment(segId)) { selectedSegments.add(segId); }
        });
        updateUI();
        updateSteps();
        document.querySelectorAll('.parent-card').forEach(function(card) { card.classList.add('expanded'); });
        generateSuggestions();
        showToast(selectedSegments.size + ' ' + funnel.charAt(0).toUpperCase() + funnel.slice(1) + ' segmenti seçildi', 'info');
    }
}

function clearSelection() {
    selectedSegments.clear();
    activeFunnel = null;
    document.querySelectorAll('.quick-action').forEach(function(b) { b.classList.remove('active'); });
    updateUI();
    updateSteps();
    closeSuggestions();
    showToast('Seçim temizlendi', 'info');
}

function findSegment(segmentId) {
    for (var i = 0; i < segments.length; i++) {
        var sub = segments[i].subs.find(function(s) { return s.id === segmentId; });
        if (sub) return sub;
    }
    return null;
}

function updateUI() {
    document.getElementById('selectedCount').textContent = selectedSegments.size;
    document.getElementById('footerCount').textContent = selectedSegments.size;
    
    var totalReach = 0;
    segments.forEach(function(p) {
        p.subs.forEach(function(s) {
            if (selectedSegments.has(s.id)) totalReach += s.reach * 0.6;
        });
    });
    document.getElementById('totalReach').textContent = Math.min(totalReach, 95).toFixed(1) + '%';
    
    if (selectedSegments.size > 0) {
        document.getElementById('footerActions').classList.add('visible');
    } else {
        document.getElementById('footerActions').classList.remove('visible');
    }
    
    var chipsContainer = document.getElementById('selectedChips');
    chipsContainer.innerHTML = '';
    var count = 0;
    selectedSegments.forEach(function(segId) {
        if (count >= 4) return;
        var seg = findSegment(segId);
        if (seg) {
            var chip = document.createElement('span');
            chip.className = 'selected-chip';
            chip.innerHTML = seg.name + ' <span class="chip-remove" onclick="event.stopPropagation();toggleSegment(\'' + segId + '\')">×</span>';
            chipsContainer.appendChild(chip);
            count++;
        }
    });
    if (selectedSegments.size > 4) {
        var moreChip = document.createElement('span');
        moreChip.className = 'selected-chip';
        moreChip.textContent = '+' + (selectedSegments.size - 4) + ' daha';
        chipsContainer.appendChild(moreChip);
    }
    
    var activeFilter = document.querySelector('.filter-btn.active');
    renderSegments(activeFilter ? activeFilter.dataset.filter : 'all', document.getElementById('searchInput').value);
}

function updateSteps() {
    var step1 = document.getElementById('step1');
    var step2 = document.getElementById('step2');
    if (activeFunnel) { step1.classList.add('completed'); } else { step1.classList.remove('completed'); }
    if (selectedSegments.size > 0) {
        step2.classList.add('active');
        if (selectedSegments.size >= 3) { step2.classList.add('completed'); } else { step2.classList.remove('completed'); }
    } else {
        step2.classList.remove('active');
        step2.classList.remove('completed');
    }
}

// AI SUGGESTIONS
function generateSuggestions() {
    currentSuggestions = [];
    var panel = document.getElementById('aiSuggestions');
    
    selectedSegments.forEach(function(segId) {
        if (!META_SEGMENT_MAP[segId] && INTEREST_RECOMMENDATIONS[segId]) {
            var rec = INTEREST_RECOMMENDATIONS[segId];
            var segment = findSegment(segId);
            if (segment) {
                currentSuggestions.push({
                    segmentId: segId,
                    segmentName: segment.name,
                    keyword: rec.keyword,
                    suggestedName: rec.name,
                    status: 'pending',
                    selectedInterest: null,
                    audienceSize: null
                });
            }
        }
    });
    
    if (currentSuggestions.length > 0) {
        panel.classList.add('visible');
        document.getElementById('suggestionCount').textContent = '(' + currentSuggestions.length + ' segment için)';
        renderSuggestions();
        fetchAllSuggestions();
    } else {
        panel.classList.remove('visible');
    }
}

function renderSuggestions() {
    var list = document.getElementById('suggestionsList');
    var html = '';
    
    currentSuggestions.forEach(function(s, idx) {
        var statusHtml = '';
        var actionsHtml = '';
        
        if (s.status === 'loading') {
            statusHtml = '<span style="color:var(--accent-yellow)">⏳ Aranıyor...</span>';
        } else if (s.status === 'accepted') {
            statusHtml = '<span class="suggestion-status">✓ Kabul Edildi</span>';
        } else if (s.status === 'skipped') {
            statusHtml = '<span style="color:var(--text-secondary)">Atlandı</span>';
        } else if (s.selectedInterest) {
            var sizeText = s.audienceSize ? ' (' + formatMetaNumber(s.audienceSize) + ')' : '';
            statusHtml = '<span class="suggestion-interest">' + s.selectedInterest.name + '</span><span class="suggestion-size">' + sizeText + '</span>';
            actionsHtml = '<button class="suggestion-btn accept" onclick="acceptSuggestion(' + idx + ')">✓ Kabul</button><button class="suggestion-btn skip" onclick="skipSuggestion(' + idx + ')">Atla</button>';
        } else {
            statusHtml = '<span style="color:var(--text-secondary)">Bekleniyor...</span>';
        }
        
        html += '<div class="suggestion-item' + (s.status === 'accepted' ? ' accepted' : '') + (s.status === 'loading' ? ' loading' : '') + '">' +
            '<div class="suggestion-left"><span class="suggestion-segment">' + s.segmentName + '</span>' +
            '<span class="suggestion-arrow">→</span>' + statusHtml + '</div>' +
            '<div class="suggestion-actions">' + actionsHtml + '</div></div>';
    });
    
    list.innerHTML = html;
}

function fetchAllSuggestions() {
    updateMetaStatus('loading', 'Öneriler hazırlanıyor...');
    
    var promises = currentSuggestions.map(function(s, idx) {
        if (s.status !== 'pending') return Promise.resolve();
        
        s.status = 'loading';
        renderSuggestions();
        
        return new Promise(function(resolve) {
            setTimeout(function() {
                var url = 'https://graph.facebook.com/' + META_CONFIG.apiVersion + '/search?type=adinterest&q=' + encodeURIComponent(s.keyword) + '&limit=1&access_token=' + META_CONFIG.accessToken;
                
                fetch(url)
                    .then(function(res) { return res.json(); })
                    .then(function(data) {
                        if (data.data && data.data.length > 0) {
                            var interest = data.data[0];
                            s.selectedInterest = { id: interest.id, name: interest.name };
                            
                            return getMetaReachEstimate([{ id: interest.id, name: interest.name }])
                                .then(function(sizeData) {
                                    s.audienceSize = sizeData.users_upper_bound;
                                })
                                .catch(function() {
                                    s.audienceSize = null;
                                });
                        }
                    })
                    .then(function() {
                        s.status = 'ready';
                        renderSuggestions();
                        resolve();
                    })
                    .catch(function(err) {
                        console.error('Error:', err);
                        s.status = 'error';
                        renderSuggestions();
                        resolve();
                    });
            }, idx * 400);
        });
    });
    
    Promise.all(promises).then(function() {
        updateMetaStatus('connected', '✓ Öneriler hazır');
    });
}

function acceptSuggestion(idx) {
    var s = currentSuggestions[idx];
    if (s.selectedInterest) {
        META_SEGMENT_MAP[s.segmentId] = {
            name: s.segmentName,
            interests: [s.selectedInterest]
        };
        if (s.audienceSize) {
            metaDataCache[s.segmentId] = { formatted: formatMetaNumber(s.audienceSize) };
        }
        s.status = 'accepted';
        saveMappings();
        updateMetaCount();
        renderSuggestions();
        renderSegments();
        showToast(s.segmentName + ' → ' + s.selectedInterest.name, 'success');
    }
}

function skipSuggestion(idx) {
    currentSuggestions[idx].status = 'skipped';
    renderSuggestions();
}

function acceptAllSuggestions() {
    var accepted = 0;
    currentSuggestions.forEach(function(s, idx) {
        if (s.status === 'ready' && s.selectedInterest) {
            META_SEGMENT_MAP[s.segmentId] = {
                name: s.segmentName,
                interests: [s.selectedInterest]
            };
            if (s.audienceSize) {
                metaDataCache[s.segmentId] = { formatted: formatMetaNumber(s.audienceSize) };
            }
            s.status = 'accepted';
            accepted++;
        }
    });
    saveMappings();
    updateMetaCount();
    renderSuggestions();
    renderSegments();
    showToast(accepted + ' öneri kabul edildi', 'success');
}

function closeSuggestions() {
    document.getElementById('aiSuggestions').classList.remove('visible');
    currentSuggestions = [];
}

// META API
function formatMetaNumber(num) {
    if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
    if (num >= 1000) return Math.round(num / 1000) + 'K';
    return num.toString();
}

function updateMetaStatus(status, text) {
    var el = document.getElementById('metaStatus');
    el.className = 'meta-status ' + status;
    el.textContent = text;
}

function updateMetaCount() {
    var metaCount = Object.keys(META_SEGMENT_MAP).length;
    var tiktokCount = Object.keys(PLATFORM_SEGMENT_MAP.tiktok).length;
    var totalCount = metaCount + tiktokCount;
    
    var countText = '';
    if (activePlatform === 'meta') {
        countText = metaCount + ' Meta';
        if (tiktokCount > 0) countText += ' • ' + tiktokCount + ' TikTok';
    } else if (activePlatform === 'tiktok') {
        countText = tiktokCount + ' TikTok';
        if (metaCount > 0) countText += ' • ' + metaCount + ' Meta';
    } else {
        countText = totalCount + ' toplam';
    }
    
    document.getElementById('metaLoadedCount').textContent = countText + ' eşleşme';
}

function getMetaReachEstimate(interests) {
    var targetingSpec = {
        geo_locations: { countries: ['TR'] },
        age_min: 18,
        age_max: 65,
        flexible_spec: [{ interests: interests }]
    };
    var url = 'https://graph.facebook.com/' + META_CONFIG.apiVersion + '/act_' + META_CONFIG.adAccountId + '/reachestimate?targeting_spec=' + encodeURIComponent(JSON.stringify(targetingSpec)) + '&access_token=' + META_CONFIG.accessToken;
    
    return fetch(url)
        .then(function(res) { return res.json(); })
        .then(function(data) {
            if (data.error) throw new Error(data.error.message);
            return data.data;
        });
}

function loadSavedMappings() {
    var saved = localStorage.getItem('metaSegmentMappings');
    if (saved) {
        META_SEGMENT_MAP = JSON.parse(saved);
    }
}

function saveMappings() {
    localStorage.setItem('metaSegmentMappings', JSON.stringify(META_SEGMENT_MAP));
}

function searchInterest() {
    var query = document.getElementById('interestSearch').value;
    if (!query || query.length < 2) { alert('En az 2 karakter girin'); return; }
    
    var resultsDiv = document.getElementById('interestResults');
    resultsDiv.style.display = 'block';
    resultsDiv.innerHTML = '<p style="color:var(--text-secondary)">🔍 ' + (activePlatform === 'tiktok' ? 'TikTok' : 'Meta') + '\'da aranıyor...</p>';
    
    if (activePlatform === 'tiktok') {
        searchTikTokInterest(query, resultsDiv);
    } else {
        searchMetaInterest(query, resultsDiv);
    }
}

function searchMetaInterest(query, resultsDiv) {
    var url = 'https://graph.facebook.com/' + META_CONFIG.apiVersion + '/search?type=adinterest&q=' + encodeURIComponent(query) + '&access_token=' + META_CONFIG.accessToken;
    
    fetch(url)
        .then(function(res) { return res.json(); })
        .then(function(data) {
            if (data.error) {
                resultsDiv.innerHTML = '<p style="color:#f87171">Hata: ' + data.error.message + '</p>';
                return;
            }
            if (!data.data || data.data.length === 0) {
                resultsDiv.innerHTML = '<p style="color:var(--text-secondary)">Sonuç bulunamadı</p>';
                return;
            }
            
            var html = '<div style="margin-bottom:16px;padding:12px;background:rgba(24,119,242,0.1);border-radius:10px;border:1px solid rgba(24,119,242,0.2)">' +
                '<div style="font-size:12px;color:#1877f2;margin-bottom:8px;font-weight:600">📘 Meta - Segment seç:</div>' +
                '<select id="segmentSelector" style="width:100%;padding:10px;background:var(--bg-card);border:1px solid var(--border-color);border-radius:8px;color:var(--text-primary);font-size:12px">' +
                '<option value="">-- Segment Seç --</option>' + getAllSegmentOptions() + '</select></div>';
            
            data.data.slice(0, 8).forEach(function(interest) {
                html += '<div style="display:flex;justify-content:space-between;align-items:center;padding:12px;background:var(--bg-card);border-radius:10px;margin-bottom:10px;border-left:3px solid #1877f2">' +
                    '<div style="flex:1"><div style="font-size:14px;font-weight:500">' + interest.name + '</div>' +
                    '<div style="font-size:11px;color:var(--text-secondary)">Meta ID: ' + interest.id + '</div></div>' +
                    '<button onclick="assignInterestToSegment(\'' + interest.id + '\',\'' + interest.name.replace(/'/g, "\\'") + '\', \'meta\')" ' +
                    'style="padding:8px 16px;background:linear-gradient(135deg,#1877f2,#0d65d9);border:none;border-radius:8px;color:white;font-size:11px;cursor:pointer">✓ Ata</button></div>';
            });
            
            resultsDiv.innerHTML = html;
        })
        .catch(function(err) {
            resultsDiv.innerHTML = '<p style="color:#f87171">Hata: ' + err.message + '</p>';
        });
}

function searchTikTokInterest(query, resultsDiv) {
    var queryLower = query.toLowerCase();
    
    // Eğer token varsa gerçek API'yi kullan
    if (TIKTOK_CONFIG.accessToken && TIKTOK_CONFIG.advertiserId) {
        fetch(`${TIKTOK_CONFIG.backendUrl}/api/tiktok/interest-search`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                access_token: TIKTOK_CONFIG.accessToken,
                advertiser_id: TIKTOK_CONFIG.advertiserId,
                keyword: query
            })
        })
        .then(res => res.json())
        .then(data => {
            if (data.success && data.data && data.data.list) {
                renderTikTokResults(data.data.list, resultsDiv, true);
            } else {
                // API hata verirse simüle dataya düş
                searchTikTokLocal(queryLower, resultsDiv);
            }
        })
        .catch(err => {
            console.error('TikTok API error:', err);
            searchTikTokLocal(queryLower, resultsDiv);
        });
    } else {
        // Token yoksa simüle data kullan
        searchTikTokLocal(queryLower, resultsDiv);
    }
}

function searchTikTokLocal(queryLower, resultsDiv) {
    var results = [];
    
    // Keyword ve subcategory eşleştirme
    Object.keys(TIKTOK_INTEREST_CATEGORIES).forEach(function(key) {
        var cat = TIKTOK_INTEREST_CATEGORIES[key];
        var matchScore = 0;
        
        // Ana isim eşleşmesi
        if (key.includes(queryLower) || cat.name.toLowerCase().includes(queryLower)) {
            matchScore = 100;
        }
        
        // Subcategory eşleşmesi
        if (cat.subcategories) {
            cat.subcategories.forEach(function(sub) {
                if (sub.toLowerCase().includes(queryLower)) {
                    matchScore = Math.max(matchScore, 80);
                }
            });
        }
        
        if (matchScore > 0) {
            results.push({
                id: cat.id,
                name: cat.name,
                audience_size: cat.audience_size,
                subcategories: cat.subcategories || [],
                matchScore: matchScore,
                key: key
            });
        }
    });
    
    // Sırala - en iyi eşleşmeler önce
    results.sort(function(a, b) { return b.matchScore - a.matchScore; });
    
    renderTikTokResults(results, resultsDiv, false);
}

function renderTikTokResults(results, resultsDiv, isLive) {
    setTimeout(function() {
        if (results.length === 0) {
            resultsDiv.innerHTML = '<div style="text-align:center;padding:24px">' +
                '<div style="font-size:32px;margin-bottom:12px">🔍</div>' +
                '<p style="color:var(--text-secondary)">TikTok\'ta sonuç bulunamadı</p>' +
                '<p style="color:var(--text-secondary);font-size:11px;margin-top:8px">Farklı bir anahtar kelime deneyin</p></div>';
            return;
        }
        
        // Platform özeti
        var totalReach = results.reduce(function(sum, r) { return sum + (r.audience_size || 0); }, 0);
        var modeLabel = isLive ? '🟢 Canlı API' : '🟡 Demo Modu';
        
        var html = '<div style="margin-bottom:16px;padding:14px;background:linear-gradient(135deg,rgba(0,0,0,0.3),rgba(238,45,86,0.15));border-radius:12px;border:1px solid rgba(238,45,86,0.3)">' +
            '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">' +
            '<div style="font-size:13px;color:#ee2d5e;font-weight:600">🎵 TikTok Türkiye <span style="font-size:10px;color:var(--text-secondary);font-weight:400;margin-left:8px">' + modeLabel + '</span></div>' +
            '<div style="font-size:11px;color:var(--text-secondary)">' + results.length + ' kategori' + (totalReach > 0 ? ' • Toplam ' + formatMetaNumber(totalReach) + ' potansiyel reach' : '') + '</div></div>' +
            '<select id="segmentSelector" style="width:100%;padding:10px;background:var(--bg-card);border:1px solid var(--border-color);border-radius:8px;color:var(--text-primary);font-size:12px">' +
            '<option value="">-- Atanacak Segment Seç --</option>' + getAllSegmentOptions() + '</select></div>';
        
        results.slice(0, 10).forEach(function(interest, idx) {
            var subcatText = interest.subcategories.length > 0 ? interest.subcategories.slice(0, 3).join(', ') : '';
            var audienceBar = Math.min((interest.audience_size / 22000000) * 100, 100); // Max 22M (entertainment)
            
            html += '<div style="padding:14px;background:var(--bg-card);border-radius:12px;margin-bottom:10px;border-left:4px solid #ee2d5e;transition:all 0.2s" onmouseover="this.style.borderLeftWidth=\'6px\'" onmouseout="this.style.borderLeftWidth=\'4px\'">' +
                '<div style="display:flex;justify-content:space-between;align-items:flex-start;gap:12px">' +
                '<div style="flex:1">' +
                '<div style="font-size:15px;font-weight:600;color:var(--text-primary);margin-bottom:4px">' + interest.name + '</div>' +
                (subcatText ? '<div style="font-size:10px;color:var(--text-secondary);margin-bottom:8px">Alt kategoriler: ' + subcatText + '</div>' : '') +
                '<div style="display:flex;align-items:center;gap:8px">' +
                '<div style="flex:1;height:4px;background:rgba(238,45,86,0.2);border-radius:2px;overflow:hidden"><div style="width:' + audienceBar + '%;height:100%;background:linear-gradient(90deg,#ee2d5e,#ff6b8a);border-radius:2px"></div></div>' +
                '<span style="font-size:11px;color:#ee2d5e;font-weight:600;font-family:\'Space Mono\',monospace">' + formatMetaNumber(interest.audience_size) + '</span>' +
                '</div></div>' +
                '<button onclick="assignInterestToSegment(\'' + interest.id + '\',\'' + interest.name.replace(/'/g, "\\'") + '\', \'tiktok\')" ' +
                'style="padding:10px 18px;background:linear-gradient(135deg,#ee2d5e,#ff0050);border:none;border-radius:8px;color:white;font-size:11px;font-weight:600;cursor:pointer;white-space:nowrap;transition:transform 0.2s" onmouseover="this.style.transform=\'scale(1.05)\'" onmouseout="this.style.transform=\'scale(1)\'">✓ Ata</button>' +
                '</div></div>';
        });
        
        // Önerilen eşleştirmeler butonu
        html += '<div style="margin-top:16px;padding:12px;background:rgba(238,45,86,0.08);border-radius:10px;text-align:center">' +
            '<button onclick="showTikTokSuggestions()" style="padding:10px 20px;background:transparent;border:1px solid #ee2d5e;border-radius:8px;color:#ee2d5e;font-size:12px;cursor:pointer">🤖 Tüm Segmentler İçin TikTok Önerileri Al</button></div>';
        
        resultsDiv.innerHTML = html;
    }, 400);
}

function showTikTokSuggestions() {
    var suggestions = [];
    segments.forEach(function(parent) {
        parent.subs.forEach(function(sub) {
            if (!PLATFORM_SEGMENT_MAP.tiktok[sub.id] && TIKTOK_SEGMENT_RECOMMENDATIONS[sub.id]) {
                var rec = TIKTOK_SEGMENT_RECOMMENDATIONS[sub.id];
                var cat = TIKTOK_INTEREST_CATEGORIES[rec.keyword];
                if (cat) {
                    suggestions.push({
                        segmentId: sub.id,
                        segmentName: sub.name,
                        interestId: cat.id,
                        interestName: cat.name,
                        audienceSize: cat.audience_size
                    });
                }
            }
        });
    });
    
    if (suggestions.length === 0) {
        showToast('Tüm segmentler zaten TikTok ile eşleştirilmiş!', 'info');
        return;
    }
    
    var modal = document.createElement('div');
    modal.id = 'tiktokSuggestionsModal';
    modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.85);display:flex;align-items:center;justify-content:center;z-index:10000';
    
    var html = '<div style="background:var(--bg-card);border-radius:16px;width:600px;max-height:80vh;overflow:hidden;border:1px solid rgba(238,45,86,0.3)">' +
        '<div style="padding:18px 22px;border-bottom:1px solid var(--border-color);display:flex;justify-content:space-between;align-items:center;background:linear-gradient(135deg,rgba(238,45,86,0.1),transparent)">' +
        '<h3 style="font-size:15px;color:#ee2d5e">🎵 TikTok Önerileri (' + suggestions.length + ' segment)</h3>' +
        '<button onclick="document.getElementById(\'tiktokSuggestionsModal\').remove()" style="background:none;border:none;color:var(--text-secondary);font-size:20px;cursor:pointer">✕</button></div>' +
        '<div style="padding:16px;max-height:50vh;overflow-y:auto">';
    
    suggestions.forEach(function(s) {
        html += '<div style="display:flex;justify-content:space-between;align-items:center;padding:12px;background:var(--bg-secondary);border-radius:10px;margin-bottom:8px;border-left:3px solid #ee2d5e">' +
            '<div style="flex:1"><div style="font-size:13px;font-weight:500">' + s.segmentName + '</div>' +
            '<div style="font-size:11px;color:#ee2d5e">→ ' + s.interestName + ' <span style="color:var(--text-secondary)">(' + formatMetaNumber(s.audienceSize) + ')</span></div></div>' +
            '<button onclick="acceptTikTokSuggestion(\'' + s.segmentId + '\',\'' + s.interestId + '\',\'' + s.interestName.replace(/'/g, "\\'") + '\')" style="padding:6px 14px;background:#ee2d5e;border:none;border-radius:6px;color:white;font-size:11px;cursor:pointer">Kabul</button></div>';
    });
    
    html += '</div><div style="padding:16px 22px;border-top:1px solid var(--border-color);display:flex;gap:12px;justify-content:flex-end">' +
        '<button onclick="acceptAllTikTokSuggestions()" style="padding:12px 24px;background:linear-gradient(135deg,#ee2d5e,#ff0050);border:none;border-radius:8px;color:white;font-size:12px;font-weight:600;cursor:pointer">✓ Tümünü Kabul Et (' + suggestions.length + ')</button></div></div>';
    
    modal.innerHTML = html;
    document.body.appendChild(modal);
}

function acceptTikTokSuggestion(segmentId, interestId, interestName) {
    var seg = findSegment(segmentId);
    PLATFORM_SEGMENT_MAP.tiktok[segmentId] = {
        name: seg ? seg.name : segmentId,
        interests: [{ id: interestId, name: interestName }],
        platform: 'tiktok'
    };
    saveTikTokMappings();
    updateMetaCount();
    
    // Modal'daki ilgili satırı kaldır
    var modal = document.getElementById('tiktokSuggestionsModal');
    if (modal) {
        showTikTokSuggestions(); // Modal'ı yenile
    }
    renderSegments();
    showToast('🎵 ' + interestName + ' → ' + (seg ? seg.name : segmentId), 'success');
}

function acceptAllTikTokSuggestions() {
    var count = 0;
    segments.forEach(function(parent) {
        parent.subs.forEach(function(sub) {
            if (!PLATFORM_SEGMENT_MAP.tiktok[sub.id] && TIKTOK_SEGMENT_RECOMMENDATIONS[sub.id]) {
                var rec = TIKTOK_SEGMENT_RECOMMENDATIONS[sub.id];
                var cat = TIKTOK_INTEREST_CATEGORIES[rec.keyword];
                if (cat) {
                    PLATFORM_SEGMENT_MAP.tiktok[sub.id] = {
                        name: sub.name,
                        interests: [{ id: cat.id, name: cat.name }],
                        platform: 'tiktok'
                    };
                    count++;
                }
            }
        });
    });
    
    saveTikTokMappings();
    updateMetaCount();
    renderSegments();
    document.getElementById('tiktokSuggestionsModal').remove();
    showToast('🎵 ' + count + ' TikTok eşleştirmesi yapıldı!', 'success');
}

function getAllSegmentOptions() {
    var options = '';
    segments.forEach(function(parent) {
        options += '<optgroup label="' + parent.icon + ' ' + parent.name + '">';
        parent.subs.forEach(function(sub) {
            var currentInterest = META_SEGMENT_MAP[sub.id] ? META_SEGMENT_MAP[sub.id].interests[0].name : 'Atanmamış';
            options += '<option value="' + sub.id + '">' + sub.name + ' (' + currentInterest + ')</option>';
        });
        options += '</optgroup>';
    });
    return options;
}

function assignInterestToSegment(interestId, interestName, platform) {
    platform = platform || activePlatform;
    var selector = document.getElementById('segmentSelector');
    var segmentId = selector.value;
    if (!segmentId) { alert('Lütfen önce bir segment seçin!'); return; }
    
    var seg = findSegment(segmentId);
    
    // Platform bazlı mapping
    if (platform === 'tiktok') {
        PLATFORM_SEGMENT_MAP.tiktok[segmentId] = {
            name: seg ? seg.name : segmentId,
            interests: [{ id: interestId, name: interestName }],
            platform: 'tiktok'
        };
        saveTikTokMappings();
    } else {
        META_SEGMENT_MAP[segmentId] = {
            name: seg ? seg.name : segmentId,
            interests: [{ id: interestId, name: interestName }],
            platform: 'meta'
        };
        saveMappings();
    }
    
    updateMetaCount();
    selector.innerHTML = '<option value="">-- Segment Seç --</option>' + getAllSegmentOptions();
    renderSegments();
    
    var platformLabel = platform === 'tiktok' ? '🎵 TikTok' : '📘 Meta';
    showToast(platformLabel + ': ' + interestName + ' → ' + (seg ? seg.name : segmentId), 'success');
}

function saveTikTokMappings() {
    localStorage.setItem('tiktokSegmentMappings', JSON.stringify(PLATFORM_SEGMENT_MAP.tiktok));
}

function loadTikTokMappings() {
    var saved = localStorage.getItem('tiktokSegmentMappings');
    if (saved) {
        PLATFORM_SEGMENT_MAP.tiktok = JSON.parse(saved);
    }
}

function showMappingsModal() {
    var modal = document.createElement('div');
    modal.id = 'mappingsModal';
    modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);display:flex;align-items:center;justify-content:center;z-index:10000';
    
    var html = '';
    Object.keys(META_SEGMENT_MAP).forEach(function(segId) {
        var data = META_SEGMENT_MAP[segId];
        var segName = findSegment(segId) ? findSegment(segId).name : segId;
        var interestName = data.interests[0].name;
        html += '<div style="display:flex;justify-content:space-between;align-items:center;padding:12px;background:var(--bg-secondary);border-radius:8px;margin-bottom:8px">' +
            '<div><div style="font-size:13px;font-weight:500">' + segName + '</div><div style="font-size:11px;color:var(--accent-blue)">→ ' + interestName + '</div></div>' +
            '<button onclick="removeMapping(\'' + segId + '\')" style="padding:6px 12px;background:#ef4444;border:none;border-radius:6px;color:white;font-size:11px;cursor:pointer">Sil</button></div>';
    });
    
    modal.innerHTML = '<div style="background:var(--bg-card);border-radius:16px;width:520px;max-height:80vh;overflow:hidden;border:1px solid var(--border-color)">' +
        '<div style="padding:18px 22px;border-bottom:1px solid var(--border-color);display:flex;justify-content:space-between;align-items:center">' +
        '<h3 style="font-size:15px;color:var(--accent-blue)">📋 Eşleştirmeler (' + Object.keys(META_SEGMENT_MAP).length + ')</h3>' +
        '<button onclick="document.getElementById(\'mappingsModal\').remove()" style="background:none;border:none;color:var(--text-secondary);font-size:20px;cursor:pointer">✕</button></div>' +
        '<div style="padding:20px;max-height:60vh;overflow-y:auto">' + (html || '<p style="color:var(--text-secondary)">Henüz eşleştirme yok</p>') + '</div>' +
        '<div style="padding:16px 22px;border-top:1px solid var(--border-color);display:flex;gap:12px;justify-content:flex-end">' +
        '<button onclick="clearAllMappings()" style="padding:10px 18px;background:#ef4444;border:none;border-radius:8px;color:white;font-size:12px;cursor:pointer">Tümünü Sil</button>' +
        '<button onclick="exportMappings()" style="padding:10px 18px;background:var(--accent-blue);border:none;border-radius:8px;color:#000;font-size:12px;cursor:pointer">📥 JSON</button></div></div>';
    
    document.body.appendChild(modal);
}

function removeMapping(segId) {
    delete META_SEGMENT_MAP[segId];
    delete metaDataCache[segId];
    saveMappings();
    updateMetaCount();
    document.getElementById('mappingsModal').remove();
    showMappingsModal();
    renderSegments();
}

function clearAllMappings() {
    if (confirm('Tüm eşleştirmeleri silmek istediğinize emin misiniz?')) {
        META_SEGMENT_MAP = {};
        metaDataCache = {};
        localStorage.removeItem('metaSegmentMappings');
        updateMetaCount();
        document.getElementById('mappingsModal').remove();
        showToast('Tüm eşleştirmeler silindi', 'info');
        renderSegments();
    }
}

function exportMappings() {
    var data = JSON.stringify(META_SEGMENT_MAP, null, 2);
    var blob = new Blob([data], { type: 'application/json' });
    var a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'segment-interest-mappings.json';
    a.click();
    showToast('Eşleştirmeler JSON olarak indirildi', 'success');
}

function exportSelection() {
    var btn = event.currentTarget;
    setButtonLoading(btn, true);
    
    setTimeout(function() {
        var csv = 'Segment,Açıklama,Reach,Meta Interest\n';
        selectedSegments.forEach(function(segId) {
            var s = findSegment(segId);
            var interest = META_SEGMENT_MAP[segId] ? META_SEGMENT_MAP[segId].interests[0].name : '';
            if (s) csv += '"' + s.name + '","' + s.desc + '",' + s.reach + '%,"' + interest + '"\n';
        });
        var blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        var a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'secili_segmentler.csv';
        a.click();
        document.getElementById('step4').classList.add('completed');
        showToast(selectedSegments.size + ' segment CSV olarak indirildi', 'success');
        setButtonLoading(btn, false);
    }, 500);
}

function goToQuadrant() {
    if (selectedSegments.size === 0) { alert('Lütfen en az bir segment seçin'); return; }
    var btn = event.currentTarget;
    setButtonLoading(btn, true);
    
    var selectedData = [];
    selectedSegments.forEach(function(segId) {
        for (var i = 0; i < segments.length; i++) {
            var sub = segments[i].subs.find(function(s) { return s.id === segId; });
            if (sub) {
                selectedData.push({ id: sub.id, name: sub.name, desc: sub.desc, reach: sub.reach * 100000, parent: segments[i].name });
                break;
            }
        }
    });
    localStorage.setItem('selectedSegments', JSON.stringify(selectedData));
    localStorage.setItem('metaSegmentMappings', JSON.stringify(META_SEGMENT_MAP));
    document.getElementById('step3').classList.add('completed');
    showToast('Quadrant\'a yönlendiriliyor...', 'info');
    setTimeout(function() { window.location.href = 'segmentation-quadrant.html'; }, 600);
}

// === LOADING BUTTON HELPER ===
var spinnerSVG = '<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10" opacity="0.25"/><path d="M12 2a10 10 0 0 1 10 10" stroke-linecap="round"/></svg>';

function setButtonLoading(btn, isLoading) {
    if (!btn) return;
    
    if (isLoading) {
        btn.dataset.originalHtml = btn.innerHTML;
        btn.classList.add('btn-loading');
        btn.disabled = true;
        btn.innerHTML = '<span class="btn-text">' + btn.innerHTML + '</span><span class="btn-spinner">' + spinnerSVG + '</span>';
    } else {
        btn.classList.remove('btn-loading');
        btn.disabled = false;
        if (btn.dataset.originalHtml) {
            btn.innerHTML = btn.dataset.originalHtml;
        }
    }
}

// === TOAST NOTIFICATION SYSTEM ===
(function() {
    // Create toast container
    var container = document.createElement('div');
    container.className = 'toast-container';
    container.id = 'toastContainer';
    document.body.appendChild(container);
    
    // Toast function
    window.showToast = function(message, type, duration) {
        type = type || 'success';
        duration = duration || 4000;
        
        var icons = {
            success: '<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6 9 17l-5-5"/></svg>',
            error: '<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>',
            info: '<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>',
            warning: '<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/></svg>'
        };
        
        var toast = document.createElement('div');
        toast.className = 'toast toast-' + type;
        toast.innerHTML = '<div class="toast-icon">' + icons[type] + '</div>' +
            '<div class="toast-content"><div class="toast-message">' + message + '</div></div>' +
            '<button class="toast-close" onclick="this.parentElement.remove()">' +
            '<svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg></button>' +
            '<div class="toast-progress" style="animation-duration:' + duration + 'ms"></div>';
        
        container.appendChild(toast);
        
        // Animate in
        requestAnimationFrame(function() {
            toast.classList.add('visible');
        });
        
        // Auto dismiss
        setTimeout(function() {
            toast.classList.add('hiding');
            toast.classList.remove('visible');
            setTimeout(function() { toast.remove(); }, 300);
        }, duration);
        
        return toast;
    };
})();

init();
    </script>
</body>
</html>
