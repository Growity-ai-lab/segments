<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Segment KÃ¼tÃ¼phanesi | Time & Growity</title>
    <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Sora:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --bg-primary: #0a0a0f; --bg-secondary: #12121a; --bg-card: #1a1a24; --accent-blue: #00d4ff; --accent-purple: #7c3aed; --accent-green: #10b981; --accent-yellow: #f59e0b; --text-primary: #f0f0f5; --text-secondary: #8888a0; --border-color: #2a2a3a; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Sora', sans-serif; background: var(--bg-primary); color: var(--text-primary); min-height: 100vh; }
        .bg-grid { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-image: linear-gradient(rgba(0,212,255,0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(0,212,255,0.03) 1px, transparent 1px); background-size: 50px 50px; pointer-events: none; z-index: 0; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px 24px; position: relative; z-index: 1; }
        .header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 24px; padding-bottom: 16px; border-bottom: 1px solid var(--border-color); }
        .logo { display: flex; align-items: center; gap: 14px; }
        .logo-icon { width: 48px; height: 48px; }
        .logo-text h1 { font-size: 22px; font-weight: 600; background: linear-gradient(90deg, #E91E8C, #7B2D8E); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .logo-text .version { font-size: 11px; color: var(--text-secondary); font-family: 'Space Mono', monospace; }
        .header-nav { display: flex; gap: 10px; }
        .nav-link { padding: 10px 16px; border: 1px solid var(--border-color); border-radius: 10px; background: var(--bg-card); color: var(--text-primary); font-size: 12px; text-decoration: none; transition: all 0.3s; }
        .nav-link:hover { border-color: var(--accent-blue); }
        .nav-link.po { border-color: rgba(227,30,36,0.4); color: #e31e24; }
        .nav-link.enerjisa { border-color: rgba(255,193,7,0.4); color: #ffc107; }
        .onboarding-toggle { display: none; padding: 10px 16px; background: linear-gradient(135deg, rgba(0,212,255,0.1), rgba(124,58,237,0.1)); border: 1px solid rgba(0,212,255,0.3); border-radius: 10px; color: var(--accent-blue); font-size: 12px; cursor: pointer; margin-bottom: 16px; }
        .onboarding-toggle.visible { display: inline-flex; align-items: center; gap: 8px; }
        .onboarding { background: linear-gradient(135deg, rgba(0,212,255,0.08), rgba(124,58,237,0.08)); border: 1px solid rgba(0,212,255,0.2); border-radius: 16px; padding: 24px; margin-bottom: 24px; }
        .onboarding.hidden { display: none; }
        .onboarding-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .onboarding-title { font-size: 18px; font-weight: 600; }
        .onboarding-title span { background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .onboarding-dismiss { padding: 6px 12px; background: transparent; border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-secondary); font-size: 11px; cursor: pointer; }
        .steps { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; }
        .step { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 12px; padding: 18px; position: relative; }
        .step.active { border-color: var(--accent-green); background: rgba(16,185,129,0.1); }
        .step-number { position: absolute; top: -10px; left: 18px; width: 24px; height: 24px; background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple)); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 700; }
        .step.active .step-number { background: linear-gradient(135deg, var(--accent-green), #059669); }
        .step-icon { font-size: 24px; margin-bottom: 10px; }
        .step-title { font-size: 13px; font-weight: 600; margin-bottom: 6px; }
        .step-desc { font-size: 11px; color: var(--text-secondary); line-height: 1.5; }
        .step-check { position: absolute; top: 12px; right: 12px; width: 20px; height: 20px; background: var(--accent-green); border-radius: 50%; display: none; align-items: center; justify-content: center; font-size: 12px; }
        .step.completed .step-check { display: flex; }
        .quick-actions { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 24px; }
        .quick-action { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 12px; padding: 20px; cursor: pointer; transition: all 0.3s; text-align: center; }
        .quick-action:hover { border-color: var(--accent-blue); transform: translateY(-2px); }
        .quick-action-icon { width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 22px; margin: 0 auto 12px; }
        .quick-action-icon.awareness { background: rgba(124,58,237,0.2); }
        .quick-action-icon.consideration { background: rgba(245,158,11,0.2); }
        .quick-action-icon.conversion { background: rgba(16,185,129,0.2); }
        .quick-action-title { font-size: 14px; font-weight: 600; margin-bottom: 4px; }
        .quick-action-count { font-size: 11px; color: var(--text-secondary); font-family: 'Space Mono', monospace; }
        .quick-action.active { border-color: var(--accent-green); background: rgba(16,185,129,0.1); }
        .meta-panel { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 12px; padding: 16px 20px; margin-bottom: 20px; }
        .meta-panel-header { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px; }
        .meta-panel-title { font-size: 13px; font-weight: 600; color: var(--accent-blue); display: flex; align-items: center; gap: 8px; }
        .meta-status { font-size: 10px; padding: 4px 10px; border-radius: 12px; font-family: 'Space Mono', monospace; background: rgba(255,255,255,0.05); color: var(--text-secondary); }
        .meta-status.connected { background: rgba(52,211,153,0.15); color: #34d399; }
        .meta-status.loading { background: rgba(251,191,36,0.15); color: #fbbf24; }
        .meta-controls { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        .meta-input { padding: 8px 12px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--bg-secondary); color: var(--text-primary); font-size: 12px; width: 200px; }
        .meta-input:focus { outline: none; border-color: var(--accent-blue); }
        .meta-btn { padding: 8px 14px; background: linear-gradient(135deg, #1877f2, #0d65d9); border: none; border-radius: 8px; color: white; font-size: 11px; font-weight: 500; cursor: pointer; }
        .meta-btn:hover { transform: translateY(-1px); }
        .meta-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .meta-btn.purple { background: linear-gradient(135deg, #7c3aed, #6d28d9); }
        .meta-btn.green { background: linear-gradient(135deg, #10b981, #059669); }
        .meta-count { font-size: 10px; color: var(--text-secondary); font-family: 'Space Mono', monospace; }
        #interestResults { display: none; margin-top: 16px; padding: 16px; background: var(--bg-secondary); border-radius: 12px; max-height: 400px; overflow-y: auto; border: 1px solid var(--border-color); }
        .ai-suggestions { display: none; margin-top: 16px; background: linear-gradient(135deg, rgba(124,58,237,0.1), rgba(236,72,153,0.1)); border: 1px solid rgba(124,58,237,0.3); border-radius: 12px; padding: 16px; }
        .ai-suggestions.visible { display: block; }
        .ai-suggestions-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; flex-wrap: wrap; gap: 10px; }
        .ai-suggestions-title { font-size: 13px; font-weight: 600; color: var(--accent-purple); display: flex; align-items: center; gap: 8px; }
        .ai-suggestions-actions { display: flex; gap: 8px; flex-wrap: wrap; }
        .suggestions-list { display: flex; flex-direction: column; gap: 8px; max-height: 300px; overflow-y: auto; }
        .suggestion-item { display: flex; align-items: center; justify-content: space-between; padding: 10px 14px; background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 10px; gap: 10px; }
        .suggestion-item.accepted { border-color: var(--accent-green); background: rgba(16,185,129,0.1); }
        .suggestion-item.loading { opacity: 0.6; }
        .suggestion-left { display: flex; align-items: center; gap: 10px; flex: 1; flex-wrap: wrap; }
        .suggestion-segment { font-size: 12px; font-weight: 500; min-width: 150px; }
        .suggestion-arrow { color: var(--text-secondary); }
        .suggestion-interest { font-size: 12px; color: var(--accent-blue); }
        .suggestion-size { font-size: 10px; color: var(--accent-green); font-family: 'Space Mono', monospace; }
        .suggestion-actions { display: flex; gap: 6px; }
        .suggestion-btn { padding: 6px 12px; border: none; border-radius: 6px; font-size: 10px; font-weight: 500; cursor: pointer; }
        .suggestion-btn.accept { background: var(--accent-green); color: white; }
        .suggestion-btn.skip { background: var(--bg-secondary); color: var(--text-secondary); border: 1px solid var(--border-color); }
        .suggestion-status { font-size: 10px; color: var(--accent-green); font-weight: 500; }
        .meta-reach { display: inline-flex; align-items: center; gap: 4px; padding: 3px 8px; background: linear-gradient(135deg, rgba(24,119,242,0.15), rgba(24,119,242,0.05)); border: 1px solid rgba(24,119,242,0.25); border-radius: 10px; font-size: 9px; font-family: 'Space Mono', monospace; color: #60a5fa; }
        .meta-reach.loaded { color: #34d399; border-color: rgba(52,211,153,0.3); background: linear-gradient(135deg, rgba(52,211,153,0.15), rgba(52,211,153,0.05)); }
        .meta-live { width: 6px; height: 6px; background: #34d399; border-radius: 50%; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .stats-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 20px; }
        .stat-card { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 10px; padding: 14px 16px; display: flex; align-items: center; gap: 12px; }
        .stat-icon { width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 18px; }
        .stat-icon.blue { background: rgba(0,212,255,0.15); }
        .stat-icon.purple { background: rgba(124,58,237,0.15); }
        .stat-icon.green { background: rgba(16,185,129,0.15); }
        .stat-icon.orange { background: rgba(255,107,53,0.15); }
        .stat-value { font-size: 22px; font-weight: 700; font-family: 'Space Mono', monospace; color: var(--accent-blue); }
        .stat-label { font-size: 10px; color: var(--text-secondary); text-transform: uppercase; }
        .controls { display: flex; gap: 16px; margin-bottom: 20px; align-items: center; flex-wrap: wrap; }
        .search-box { flex: 1; max-width: 350px; position: relative; }
        .search-icon { position: absolute; left: 14px; top: 50%; transform: translateY(-50%); font-size: 14px; color: var(--text-secondary); }
        .search-input { width: 100%; padding: 12px 14px 12px 42px; background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 10px; color: var(--text-primary); font-size: 13px; }
        .search-input:focus { outline: none; border-color: var(--accent-blue); }
        .filter-btns { display: flex; gap: 8px; flex-wrap: wrap; }
        .filter-btn { padding: 10px 16px; background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-secondary); font-size: 12px; cursor: pointer; }
        .filter-btn.active { background: rgba(0,212,255,0.15); border-color: var(--accent-blue); color: var(--accent-blue); }
        .segment-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(340px, 1fr)); gap: 16px; margin-bottom: 100px; }
        .parent-card { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 14px; overflow: hidden; animation: fadeIn 0.3s ease; }
        .parent-card.has-selected { border-color: var(--accent-green); box-shadow: 0 0 0 1px var(--accent-green); }
        .parent-header { padding: 16px 18px; display: flex; align-items: center; justify-content: space-between; cursor: pointer; border-bottom: 1px solid transparent; }
        .parent-card.expanded .parent-header { border-bottom-color: var(--border-color); }
        .parent-left { display: flex; align-items: center; gap: 12px; }
        .parent-icon { width: 42px; height: 42px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 20px; background: rgba(255,255,255,0.05); }
        .parent-name { font-size: 14px; font-weight: 600; }
        .parent-count { font-size: 11px; color: var(--text-secondary); margin-top: 2px; }
        .parent-actions { display: flex; align-items: center; gap: 10px; }
        .select-all-btn { padding: 6px 12px; background: transparent; border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-secondary); font-size: 10px; cursor: pointer; }
        .expand-icon { color: var(--text-secondary); font-size: 12px; transition: transform 0.3s; }
        .parent-card.expanded .expand-icon { transform: rotate(180deg); }
        .sub-segments { max-height: 0; overflow: hidden; transition: max-height 0.3s ease; }
        .parent-card.expanded .sub-segments { max-height: 800px; }
        .sub-segment { padding: 12px 18px; display: flex; align-items: center; gap: 12px; cursor: pointer; border-bottom: 1px solid rgba(255,255,255,0.03); }
        .sub-segment:last-child { border-bottom: none; }
        .sub-segment:hover { background: rgba(0,212,255,0.05); }
        .sub-segment.selected { background: rgba(16,185,129,0.1); }
        .checkbox { width: 20px; height: 20px; border: 2px solid var(--border-color); border-radius: 5px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .checkbox.checked { background: var(--accent-green); border-color: var(--accent-green); }
        .checkbox.checked::after { content: 'âœ“'; color: white; font-size: 12px; font-weight: bold; }
        .sub-info { flex: 1; }
        .sub-name { font-size: 13px; font-weight: 500; }
        .sub-desc { font-size: 11px; color: var(--text-secondary); margin-top: 2px; }
        .sub-meta { display: flex; flex-direction: column; align-items: flex-end; gap: 4px; }
        .meta-tag { padding: 4px 8px; background: rgba(0,212,255,0.1); border-radius: 6px; font-size: 10px; color: var(--accent-blue); font-family: 'Space Mono', monospace; }
        .footer-actions { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(18,18,26,0.95); backdrop-filter: blur(20px); border-top: 1px solid var(--border-color); padding: 16px 24px; display: flex; justify-content: space-between; align-items: center; transform: translateY(100%); transition: transform 0.3s ease; z-index: 100; }
        .footer-actions.visible { transform: translateY(0); }
        .footer-left { display: flex; align-items: center; gap: 16px; }
        .footer-count { font-size: 14px; color: var(--text-secondary); }
        .footer-count strong { color: var(--accent-blue); font-family: 'Space Mono', monospace; }
        .selected-chips { display: flex; gap: 8px; flex-wrap: wrap; }
        .selected-chip { padding: 6px 12px; background: rgba(16,185,129,0.15); border: 1px solid rgba(16,185,129,0.3); border-radius: 20px; font-size: 11px; color: var(--accent-green); display: flex; align-items: center; gap: 6px; }
        .chip-remove { cursor: pointer; opacity: 0.7; }
        .footer-right { display: flex; gap: 12px; }
        .btn { padding: 12px 20px; border: none; border-radius: 10px; font-size: 13px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px; }
        .btn-secondary { background: var(--bg-card); border: 1px solid var(--border-color); color: var(--text-primary); }
        .btn-primary { background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple)); color: white; }
        .empty-state { grid-column: 1 / -1; text-align: center; padding: 60px 20px; }
        .empty-state-icon { font-size: 48px; margin-bottom: 16px; opacity: 0.5; }
        @media (max-width: 1200px) { .steps { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 768px) { .steps { grid-template-columns: 1fr; } .quick-actions { grid-template-columns: 1fr; } .stats-row { grid-template-columns: repeat(2, 1fr); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideIn { from { transform: translateX(100px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
    </style>
</head>
<body>
    <div class="bg-grid"></div>
    <div class="container">
        <header class="header">
            <div class="logo">
                <div class="logo-icon"><svg viewBox="0 0 48 48" width="48" height="48"><circle cx="16" cy="24" r="12" fill="none" stroke="#E91E8C" stroke-width="4"/><circle cx="32" cy="24" r="12" fill="none" stroke="#7B2D8E" stroke-width="4"/></svg></div>
                <div class="logo-text"><h1>Time & Growity</h1><span class="version">Segment KÃ¼tÃ¼phanesi v8.2 â€¢ Ocak 2026</span></div>
            </div>
            <nav class="header-nav">
                <a href="segmentation-quadrant.html" class="nav-link">ğŸ“Š Quadrant</a>
                <a href="po-segmentasyon.html" class="nav-link po">ğŸ¯ PO Premium</a>
                <a href="enerjisa-30yil.html" class="nav-link enerjisa">âš¡ Enerjisa</a>
            </nav>
        </header>
        <button class="onboarding-toggle" id="onboardingToggle" onclick="toggleOnboarding()">ğŸ‘‹ KullanÄ±m Rehberini GÃ¶ster</button>
        <section class="onboarding" id="onboarding">
            <div class="onboarding-header">
                <div class="onboarding-title">ğŸ‘‹ <span>HoÅŸ Geldiniz!</span> Segment seÃ§imine baÅŸlayÄ±n</div>
                <button class="onboarding-dismiss" onclick="toggleOnboarding()">Gizle âœ•</button>
            </div>
            <div class="steps">
                <div class="step active" id="step1"><div class="step-number">1</div><div class="step-check">âœ“</div><div class="step-icon">ğŸ¯</div><div class="step-title">Hedef Belirleyin</div><div class="step-desc">Awareness, Consideration veya Conversion funnel'Ä±ndan birini seÃ§in</div></div>
                <div class="step" id="step2"><div class="step-number">2</div><div class="step-check">âœ“</div><div class="step-icon">âœ…</div><div class="step-title">Segment SeÃ§in</div><div class="step-desc">Ä°lgili kategorileri aÃ§Ä±p hedef segmentleri iÅŸaretleyin</div></div>
                <div class="step" id="step3"><div class="step-number">3</div><div class="step-check">âœ“</div><div class="step-icon">ğŸ“Š</div><div class="step-title">Analiz Edin</div><div class="step-desc">SeÃ§imleri Quadrant'a gÃ¶ndererek gÃ¶rselleÅŸtirin</div></div>
                <div class="step" id="step4"><div class="step-number">4</div><div class="step-check">âœ“</div><div class="step-icon">ğŸ“¥</div><div class="step-title">DÄ±ÅŸa AktarÄ±n</div><div class="step-desc">CSV veya PNG olarak planlama ekibinizle paylaÅŸÄ±n</div></div>
            </div>
        </section>
        <section class="quick-actions">
            <div class="quick-action" onclick="selectFunnel('awareness')" id="funnel-awareness"><div class="quick-action-icon awareness">ğŸ””</div><div class="quick-action-title">Awareness</div><div class="quick-action-count">18 segment otomatik seÃ§</div></div>
            <div class="quick-action" onclick="selectFunnel('consideration')" id="funnel-consideration"><div class="quick-action-icon consideration">ğŸ¤”</div><div class="quick-action-title">Consideration</div><div class="quick-action-count">20 segment otomatik seÃ§</div></div>
            <div class="quick-action" onclick="selectFunnel('conversion')" id="funnel-conversion"><div class="quick-action-icon conversion">ğŸ’°</div><div class="quick-action-title">Conversion</div><div class="quick-action-count">16 segment otomatik seÃ§</div></div>
        </section>
        <div class="meta-panel">
            <div class="meta-panel-header">
                <div class="meta-panel-title"><span>ğŸ“Š</span> Meta Audience Data <span class="meta-status" id="metaStatus">HazÄ±r</span></div>
                <div class="meta-controls">
                    <input type="text" id="interestSearch" class="meta-input" placeholder="Interest ara (Ã¶r: travel)...">
                    <button class="meta-btn" onclick="searchInterest()">ğŸ” Ara</button>
                    <button class="meta-btn purple" onclick="showMappingsModal()">ğŸ“‹ EÅŸleÅŸtirmeler</button>
                    <span class="meta-count" id="metaLoadedCount">0 eÅŸleÅŸme</span>
                </div>
            </div>
            <div id="interestResults"></div>
            <div class="ai-suggestions" id="aiSuggestions">
                <div class="ai-suggestions-header">
                    <div class="ai-suggestions-title">ğŸ¤– AkÄ±llÄ± Interest Ã–nerileri <span id="suggestionCount" style="font-weight:400;color:var(--text-secondary);"></span></div>
                    <div class="ai-suggestions-actions">
                        <button class="meta-btn green" onclick="acceptAllSuggestions()">âœ“ TÃ¼mÃ¼nÃ¼ Kabul</button>
                        <button class="meta-btn" onclick="fetchAllSuggestions()">ğŸ”„ Yeniden Ã–ner</button>
                        <button class="suggestion-btn skip" onclick="closeSuggestions()">âœ• Kapat</button>
                    </div>
                </div>
                <div class="suggestions-list" id="suggestionsList"></div>
            </div>
        </div>
        <div class="stats-row">
            <div class="stat-card"><div class="stat-icon blue">ğŸ‘¥</div><div><div class="stat-value">68</div><div class="stat-label">Toplam Segment</div></div></div>
            <div class="stat-card"><div class="stat-icon purple">ğŸ“</div><div><div class="stat-value">16</div><div class="stat-label">Ana Kategori</div></div></div>
            <div class="stat-card"><div class="stat-icon green">âœ“</div><div><div class="stat-value" id="selectedCount">0</div><div class="stat-label">SeÃ§ili</div></div></div>
            <div class="stat-card"><div class="stat-icon orange">ğŸ“ˆ</div><div><div class="stat-value" id="totalReach">0%</div><div class="stat-label">Tahmini Reach</div></div></div>
        </div>
        <div class="controls">
            <div class="search-box"><span class="search-icon">ğŸ”</span><input type="text" class="search-input" placeholder="Segment ara..." id="searchInput"></div>
            <div class="filter-btns">
                <button class="filter-btn active" data-filter="all">TÃ¼mÃ¼</button>
                <button class="filter-btn" data-filter="lifestyle">ğŸŒŸ Lifestyle</button>
                <button class="filter-btn" data-filter="demografik">ğŸ‘¤ Demografik</button>
                <button class="filter-btn" data-filter="davranis">ğŸ›’ DavranÄ±ÅŸ</button>
                <button class="filter-btn" data-filter="b2c">âš¡ B2C</button>
                <button class="filter-btn" data-filter="b2b">ğŸ¢ B2B</button>
            </div>
        </div>
        <div class="segment-grid" id="segmentGrid"></div>
    </div>
    <div class="footer-actions" id="footerActions">
        <div class="footer-left"><span class="footer-count"><strong id="footerCount">0</strong> segment seÃ§ildi</span><div class="selected-chips" id="selectedChips"></div></div>
        <div class="footer-right">
            <button class="btn btn-secondary" onclick="clearSelection()">Temizle</button>
            <button class="btn btn-secondary" onclick="exportSelection()">ğŸ“¥ CSV</button>
            <button class="btn btn-primary" onclick="goToQuadrant()">Quadrant'a GÃ¶nder â†’</button>
        </div>
    </div>
    <script>
const segments = [
    { id: 'yasam-tarzi', name: 'YaÅŸam TarzÄ± Segmentleri', icon: 'ğŸŒŸ', category: 'lifestyle', subs: [
        { id: 'yt-1', name: 'Trendsetter Ã–ncÃ¼ler', desc: 'Yeniliklere aÃ§Ä±k, trendleri belirleyen', reach: 8.2 },
        { id: 'yt-2', name: 'StatÃ¼ OdaklÄ± Profesyoneller', desc: 'Kariyer ve sosyal statÃ¼ Ã¶ncelikli', reach: 12.5 },
        { id: 'yt-3', name: 'Deneyim AvcÄ±larÄ±', desc: 'Yeni deneyimler arayan maceraperestler', reach: 9.8 },
        { id: 'yt-4', name: 'Wellness TutkunlarÄ±', desc: 'SaÄŸlÄ±k ve wellness odaklÄ±', reach: 7.3 }
    ]},
    { id: 'tuketim', name: 'TÃ¼ketim AlÄ±ÅŸkanlÄ±klarÄ±', icon: 'ğŸ›’', category: 'davranis', subs: [
        { id: 'tk-1', name: 'Premium TÃ¼keticiler', desc: 'Kaliteyi fiyatÄ±n Ã¶nÃ¼nde tutan', reach: 11.2 },
        { id: 'tk-2', name: 'DeÄŸer Arayanlar', desc: 'Fiyat-performans peÅŸinde', reach: 18.7 },
        { id: 'tk-3', name: 'DÃ¼rtÃ¼sel AlÄ±ÅŸveriÅŸÃ§iler', desc: 'AnlÄ±k kararlarla alÄ±ÅŸveriÅŸ', reach: 14.3 },
        { id: 'tk-4', name: 'PlanlÄ± AlÄ±ÅŸveriÅŸÃ§iler', desc: 'Her ÅŸeyi Ã¶nceden planlayan', reach: 15.8 }
    ]},
    { id: 'dijital', name: 'Dijital DavranÄ±ÅŸ', icon: 'ğŸ“±', category: 'davranis', subs: [
        { id: 'dj-1', name: 'Dijital Yerliler', desc: 'HayatÄ± dijitalde yaÅŸayan', reach: 22.4 },
        { id: 'dj-2', name: 'Sosyal Medya Aktifi', desc: 'TÃ¼m platformlarda aktif', reach: 28.6 },
        { id: 'dj-3', name: 'E-Ticaret UzmanÄ±', desc: 'Online alÄ±ÅŸveriÅŸi tercih eden', reach: 19.2 },
        { id: 'dj-4', name: 'Dijital Temkinli', desc: 'Teknolojiyle mesafeli', reach: 12.1 }
    ]},
    { id: 'aile', name: 'Aile YaÅŸamÄ±', icon: 'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦', category: 'demografik', subs: [
        { id: 'al-1', name: 'GenÃ§ Aileler', desc: 'KÃ¼Ã§Ã¼k Ã§ocuklu aileler', reach: 16.8 },
        { id: 'al-2', name: 'BÃ¼yÃ¼yen Aileler', desc: 'Okul Ã§aÄŸÄ± Ã§ocuklu', reach: 14.2 },
        { id: 'al-3', name: 'BoÅŸ Yuva', desc: 'Ã‡ocuklar evden ayrÄ±lmÄ±ÅŸ', reach: 9.5 },
        { id: 'al-4', name: 'Tekli YaÅŸayanlar', desc: 'YalnÄ±z yaÅŸayan yetiÅŸkinler', reach: 11.3 }
    ]},
    { id: 'gelir', name: 'Gelir Segmentleri', icon: 'ğŸ’°', category: 'demografik', subs: [
        { id: 'gl-1', name: 'Ãœst Gelir A+', desc: 'En yÃ¼ksek gelir grubu', reach: 5.2 },
        { id: 'gl-2', name: 'Ãœst-Orta A', desc: 'YÃ¼ksek gelir grubu', reach: 12.8 },
        { id: 'gl-3', name: 'Orta B', desc: 'Orta gelir grubu', reach: 35.4 },
        { id: 'gl-4', name: 'Alt-Orta C', desc: 'Alt-orta gelir grubu', reach: 28.6 }
    ]},
    { id: 'medya', name: 'Medya TÃ¼ketimi', icon: 'ğŸ“º', category: 'davranis', subs: [
        { id: 'md-1', name: 'TV AÄŸÄ±rlÄ±klÄ±', desc: 'Geleneksel TV izleyicisi', reach: 42.3 },
        { id: 'md-2', name: 'Streaming OdaklÄ±', desc: 'Dijital iÃ§erik tercih eden', reach: 31.5 },
        { id: 'md-3', name: 'Multi-Screen', desc: 'Ã‡oklu ekran kullanÄ±cÄ±sÄ±', reach: 38.7 },
        { id: 'md-4', name: 'Radyo Dinleyicisi', desc: 'Aktif radyo takipÃ§isi', reach: 24.8 }
    ]},
    { id: 'otomobil', name: 'Otomobil Segmentleri', icon: 'ğŸš—', category: 'davranis', subs: [
        { id: 'ot-1', name: 'Premium AraÃ§ Sahipleri', desc: 'LÃ¼ks segment araÃ§', reach: 8.4 },
        { id: 'ot-2', name: 'SUV TutkunlarÄ±', desc: 'SUV/crossover tercihi', reach: 15.2 },
        { id: 'ot-3', name: 'Ekonomik SÃ¼rÃ¼cÃ¼ler', desc: 'YakÄ±t tasarrufu odaklÄ±', reach: 22.6 },
        { id: 'ot-4', name: 'Elektrik/Hibrit Ä°lgili', desc: 'Alternatif yakÄ±t meraklÄ±larÄ±', reach: 6.8 }
    ]},
    { id: 'seyahat', name: 'Seyahat Tercihleri', icon: 'âœˆï¸', category: 'lifestyle', subs: [
        { id: 'sy-1', name: 'SÄ±k Seyahat Edenler', desc: 'YÄ±lda 4+ seyahat', reach: 12.4 },
        { id: 'sy-2', name: 'Tatil PlanlayÄ±cÄ±larÄ±', desc: 'YÄ±llÄ±k tatil odaklÄ±', reach: 28.6 },
        { id: 'sy-3', name: 'Ä°ÅŸ Seyahati Yapanlar', desc: 'Profesyonel seyahat', reach: 9.8 },
        { id: 'sy-4', name: 'Yerel Gezginler', desc: 'Yurt iÃ§i keÅŸif seven', reach: 18.2 }
    ]},
    { id: 'finans', name: 'Finansal DavranÄ±ÅŸ', icon: 'ğŸ’³', category: 'davranis', subs: [
        { id: 'fn-1', name: 'YatÄ±rÄ±mcÄ±lar', desc: 'Aktif yatÄ±rÄ±m yapan', reach: 14.6 },
        { id: 'fn-2', name: 'Tasarruf OdaklÄ±', desc: 'Birikim Ã¶ncelikli', reach: 22.8 },
        { id: 'fn-3', name: 'Kredi KullanÄ±cÄ±larÄ±', desc: 'Aktif kredi kullanan', reach: 31.4 },
        { id: 'fn-4', name: 'Dijital BankacÄ±lÄ±k', desc: 'Mobile banking aktif', reach: 45.2 }
    ]},
    { id: 'beslenme', name: 'Beslenme Tercihleri', icon: 'ğŸ½ï¸', category: 'lifestyle', subs: [
        { id: 'bs-1', name: 'SaÄŸlÄ±klÄ± Beslenme', desc: 'Organik ve doÄŸal tercih', reach: 18.4 },
        { id: 'bs-2', name: 'Fast Food Severler', desc: 'HÄ±zlÄ± yemek tercihi', reach: 24.6 },
        { id: 'bs-3', name: 'Gurme TutkunlarÄ±', desc: 'Kaliteli restoran seven', reach: 11.2 },
        { id: 'bs-4', name: 'Ev Yemekleri', desc: 'Evde piÅŸirmeyi tercih', reach: 32.8 }
    ]},
    { id: 'influencers', name: 'Influencers (Etkileyiciler)', icon: 'âš¡', category: 'b2c', subs: [
        { id: 'inf-1', name: 'Hane HalklarÄ± - Kesintisiz Enerji', desc: 'GÃ¼venilir elektrik bekleyen', reach: 42.5 },
        { id: 'inf-2', name: 'Hane HalklarÄ± - Dijital MÃ¼ÅŸteri', desc: 'Online iÅŸlem isteyen', reach: 28.3 },
        { id: 'inf-3', name: 'Mobil KullanÄ±cÄ±lar', desc: 'Uygulama Ã¼zerinden iÅŸlem', reach: 35.6 },
        { id: 'inf-4', name: 'KÃ¼Ã§Ã¼k Ä°ÅŸletmeler', desc: 'Enerji optimizasyonu arayan KOBÄ°', reach: 12.8 },
        { id: 'inf-5', name: 'Enerjisa Ã‡alÄ±ÅŸanlarÄ±', desc: 'Ä°Ã§ paydaÅŸlar', reach: 1.2 },
        { id: 'inf-6', name: 'GÃ¼ven OdaklÄ± TÃ¼keticiler', desc: 'Åeffaf iletiÅŸim bekleyen', reach: 38.4 },
        { id: 'inf-7', name: 'Sosyal Medya TakipÃ§ileri', desc: 'Dijital kanallarda aktif', reach: 48.2 },
        { id: 'inf-8', name: 'Fiyat OdaklÄ± TÃ¼keticiler', desc: 'Maliyet hassasiyeti yÃ¼ksek', reach: 52.1 }
    ]},
    { id: 'gatekeeper', name: 'Gatekeepers', icon: 'ğŸ›ï¸', category: 'b2b', subs: [
        { id: 'gk-1', name: 'Yerel YÃ¶netimler', desc: 'Belediyeler ve il idareleri', reach: 2.4 },
        { id: 'gk-2', name: 'Muhtarlar', desc: 'Mahalle toplum liderleri', reach: 4.8 },
        { id: 'gk-3', name: 'STK ve Sivil Toplum', desc: 'SÃ¼rdÃ¼rÃ¼lebilirlik odaklÄ±', reach: 1.6 },
        { id: 'gk-4', name: 'Akademik Kurumlar', desc: 'Ãœniversiteler', reach: 0.8 },
        { id: 'gk-5', name: 'SÃ¼rdÃ¼rÃ¼lebilirlik Partnerleri', desc: 'YeÅŸil enerji ortaklarÄ±', reach: 1.2 },
        { id: 'gk-6', name: 'Medya KuruluÅŸlarÄ±', desc: 'Gazeteciler', reach: 3.5 },
        { id: 'gk-7', name: 'Enerji SektÃ¶rÃ¼ Analistleri', desc: 'SektÃ¶r uzmanlarÄ±', reach: 0.5 },
        { id: 'gk-8', name: 'Yerel Ticaret OdalarÄ±', desc: 'BÃ¶lgesel iÅŸ temsilcileri', reach: 2.1 },
        { id: 'gk-9', name: 'TÃ¼ketici Dernekleri', desc: 'TÃ¼ketici haklarÄ±', reach: 1.8 },
        { id: 'gk-10', name: 'Ã‡evre Aktivistleri', desc: 'Ä°klim odaklÄ± gruplar', reach: 2.2 }
    ]},
    { id: 'decisionmaker', name: 'Decision Makers', icon: 'ğŸ¯', category: 'b2b', subs: [
        { id: 'dm-1', name: 'Devlet KurumlarÄ±', desc: 'EPDK, Enerji BakanlÄ±ÄŸÄ±', reach: 0.3 },
        { id: 'dm-2', name: 'RegÃ¼latÃ¶rler (EPDK)', desc: 'DÃ¼zenleyici kurumlar', reach: 0.2 },
        { id: 'dm-3', name: 'Kurumsal YatÄ±rÄ±mcÄ±lar', desc: 'ESG odaklÄ± fonlar', reach: 0.8 },
        { id: 'dm-4', name: 'Bireysel YatÄ±rÄ±mcÄ±lar', desc: 'Hisse takipÃ§ileri', reach: 3.5 },
        { id: 'dm-5', name: 'Stratejik Ä°ÅŸ OrtaklarÄ±', desc: 'Uzun vadeli ortaklÄ±k', reach: 1.4 },
        { id: 'dm-6', name: 'Finans KuruluÅŸlarÄ±', desc: 'Bankalar', reach: 0.6 },
        { id: 'dm-7', name: 'UluslararasÄ± Enerji FonlarÄ±', desc: 'Global ESG fonlarÄ±', reach: 0.4 },
        { id: 'dm-8', name: 'Borsa Analistleri', desc: 'Equity research', reach: 0.7 },
        { id: 'dm-9', name: 'Finans MedyasÄ±', desc: 'Bloomberg, Reuters', reach: 1.2 },
        { id: 'dm-10', name: 'Perakende YatÄ±rÄ±mcÄ± TopluluklarÄ±', desc: 'Online forumlar', reach: 4.8 }
    ]}
];

const INTEREST_RECOMMENDATIONS = {
    'yt-1': { keyword: 'early adopter', name: 'Early adopters' },
    'yt-2': { keyword: 'luxury', name: 'Luxury goods' },
    'yt-3': { keyword: 'adventure travel', name: 'Adventure travel' },
    'yt-4': { keyword: 'wellness', name: 'Health and wellness' },
    'tk-1': { keyword: 'premium products', name: 'Premium products' },
    'tk-2': { keyword: 'discount', name: 'Discount stores' },
    'tk-3': { keyword: 'shopping', name: 'Online shopping' },
    'tk-4': { keyword: 'budgeting', name: 'Personal finance' },
    'dj-1': { keyword: 'technology', name: 'Technology' },
    'dj-2': { keyword: 'social media', name: 'Social media' },
    'dj-3': { keyword: 'e-commerce', name: 'E-commerce' },
    'dj-4': { keyword: 'traditional media', name: 'Television' },
    'al-1': { keyword: 'parenting', name: 'Parenting' },
    'al-2': { keyword: 'family', name: 'Family' },
    'al-3': { keyword: 'retirement', name: 'Retirement' },
    'al-4': { keyword: 'single lifestyle', name: 'Urban lifestyle' },
    'md-1': { keyword: 'television', name: 'Television' },
    'md-2': { keyword: 'netflix', name: 'Streaming services' },
    'md-3': { keyword: 'smartphone', name: 'Smartphones' },
    'md-4': { keyword: 'radio', name: 'Radio' },
    'ot-1': { keyword: 'luxury cars', name: 'Luxury vehicles' },
    'ot-2': { keyword: 'suv', name: 'SUVs' },
    'ot-3': { keyword: 'fuel efficiency', name: 'Fuel efficiency' },
    'ot-4': { keyword: 'electric vehicles', name: 'Electric vehicles' },
    'sy-1': { keyword: 'travel', name: 'Travel' },
    'sy-2': { keyword: 'vacation', name: 'Vacation' },
    'sy-3': { keyword: 'business travel', name: 'Business travel' },
    'sy-4': { keyword: 'tourism', name: 'Tourism' },
    'fn-1': { keyword: 'investing', name: 'Investing' },
    'fn-2': { keyword: 'savings', name: 'Savings' },
    'fn-3': { keyword: 'credit cards', name: 'Credit cards' },
    'fn-4': { keyword: 'mobile banking', name: 'Mobile banking' },
    'bs-1': { keyword: 'organic food', name: 'Organic food' },
    'bs-2': { keyword: 'fast food', name: 'Fast food' },
    'bs-3': { keyword: 'fine dining', name: 'Fine dining' },
    'bs-4': { keyword: 'cooking', name: 'Cooking' },
    'inf-1': { keyword: 'home improvement', name: 'Homeowners' },
    'inf-2': { keyword: 'digital services', name: 'Online services' },
    'inf-3': { keyword: 'mobile apps', name: 'Mobile applications' },
    'inf-4': { keyword: 'small business', name: 'Small business' },
    'inf-5': { keyword: 'corporate', name: 'Corporate culture' },
    'inf-6': { keyword: 'customer service', name: 'Customer service' },
    'inf-7': { keyword: 'social media marketing', name: 'Social media' },
    'inf-8': { keyword: 'discount shopping', name: 'Discount shoppers' },
    'gk-1': { keyword: 'government', name: 'Government' },
    'gk-2': { keyword: 'community', name: 'Community' },
    'gk-3': { keyword: 'ngo', name: 'Non-profit' },
    'gk-4': { keyword: 'education', name: 'Higher education' },
    'gk-5': { keyword: 'sustainability', name: 'Sustainability' },
    'gk-6': { keyword: 'journalism', name: 'Journalism' },
    'gk-7': { keyword: 'energy industry', name: 'Energy industry' },
    'gk-8': { keyword: 'business networking', name: 'Business networking' },
    'gk-9': { keyword: 'consumer rights', name: 'Consumer advocacy' },
    'gk-10': { keyword: 'environment', name: 'Environmental activism' },
    'dm-1': { keyword: 'public policy', name: 'Public policy' },
    'dm-2': { keyword: 'regulation', name: 'Regulatory affairs' },
    'dm-3': { keyword: 'esg investing', name: 'ESG investing' },
    'dm-4': { keyword: 'stock trading', name: 'Stock trading' },
    'dm-5': { keyword: 'b2b', name: 'B2B' },
    'dm-6': { keyword: 'banking', name: 'Banking' },
    'dm-7': { keyword: 'international finance', name: 'International finance' },
    'dm-8': { keyword: 'financial analysis', name: 'Financial analysis' },
    'dm-9': { keyword: 'financial news', name: 'Financial news' },
    'dm-10': { keyword: 'day trading', name: 'Day trading' }
};

let selectedSegments = new Set();
let activeFunnel = null;
let currentSuggestions = [];
let META_SEGMENT_MAP = {};
let metaDataCache = {};

const funnelSegments = {
    awareness: ['yt-1','yt-3','dj-2','dj-1','md-2','md-1','inf-1','inf-2','inf-6','inf-7','gk-1','gk-2','gk-3','gk-6','dm-3','dm-5','bs-1','sy-2'],
    consideration: ['yt-2','yt-4','tk-1','tk-2','dj-3','al-1','al-2','md-3','inf-3','inf-4','inf-8','gk-4','gk-5','gk-7','dm-4','dm-6','dm-8','fn-1','fn-4','ot-4'],
    conversion: ['tk-3','tk-4','dj-4','al-3','al-4','fn-2','fn-3','inf-5','gk-8','gk-9','gk-10','dm-1','dm-2','dm-7','dm-9','dm-10']
};

const META_CONFIG = { 
    accessToken: 'EAAYe5SrdjKgBQZAZAZCh5uE3KLAyOrABkdC5gZCZBcLwdzaAXOKAjGVP7puJt2IijGivXAtQZCd6tbPrkDSoK9JRfWZBHsq2CuqdkL4L33a0xWDbZAyQxuwSjA62eZB3GcZBB6FXWueGyExbs3zZApqbB5IlEZCOfMM1zPjqKYaQF1N2TYZCoAfEfbLgWJZBFz0tggiOnKRwZDZD', 
    adAccountId: '1449083392081509', 
    apiVersion: 'v18.0' 
};

function init() {
    renderSegments();
    setupEventListeners();
    checkOnboardingState();
    loadSavedMappings();
    updateMetaCount();
}

function setupEventListeners() {
    document.querySelectorAll('.filter-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.filter-btn').forEach(function(b) { b.classList.remove('active'); });
            btn.classList.add('active');
            renderSegments(btn.dataset.filter, document.getElementById('searchInput').value);
        });
    });
    document.getElementById('searchInput').addEventListener('input', function(e) {
        var activeFilter = document.querySelector('.filter-btn.active');
        renderSegments(activeFilter ? activeFilter.dataset.filter : 'all', e.target.value);
    });
    document.getElementById('interestSearch').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') searchInterest();
    });
}

function checkOnboardingState() {
    if (localStorage.getItem('onboardingHidden') === 'true') {
        document.getElementById('onboarding').classList.add('hidden');
        document.getElementById('onboardingToggle').classList.add('visible');
    }
}

function toggleOnboarding() {
    var onboarding = document.getElementById('onboarding');
    var toggle = document.getElementById('onboardingToggle');
    if (onboarding.classList.contains('hidden')) {
        onboarding.classList.remove('hidden');
        toggle.classList.remove('visible');
        localStorage.setItem('onboardingHidden', 'false');
    } else {
        onboarding.classList.add('hidden');
        toggle.classList.add('visible');
        localStorage.setItem('onboardingHidden', 'true');
    }
}

function renderSegments(filter, search) {
    filter = filter || 'all';
    search = search || '';
    var grid = document.getElementById('segmentGrid');
    grid.innerHTML = '';
    
    var filtered = segments.filter(function(parent) {
        if (filter !== 'all' && parent.category !== filter) return false;
        if (search) {
            var s = search.toLowerCase();
            if (parent.name.toLowerCase().indexOf(s) !== -1) return true;
            for (var i = 0; i < parent.subs.length; i++) {
                if (parent.subs[i].name.toLowerCase().indexOf(s) !== -1) return true;
                if (parent.subs[i].desc.toLowerCase().indexOf(s) !== -1) return true;
            }
            return false;
        }
        return true;
    });
    
    if (filtered.length === 0) {
        grid.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ”</div><h3>Segment bulunamadÄ±</h3></div>';
        return;
    }
    
    filtered.forEach(function(parent, idx) {
        var selectedInParent = parent.subs.filter(function(s) { return selectedSegments.has(s.id); }).length;
        var hasSelected = selectedInParent > 0;
        var card = document.createElement('div');
        card.className = 'parent-card' + (hasSelected ? ' has-selected' : '');
        card.dataset.parent = parent.id;
        card.style.animationDelay = (idx * 0.05) + 's';
        
        var subsHtml = '';
        parent.subs.forEach(function(sub) {
            var mapping = META_SEGMENT_MAP[sub.id];
            var metaText = mapping ? mapping.interests[0].name : '--';
            var isSelected = selectedSegments.has(sub.id);
            subsHtml += '<div class="sub-segment' + (isSelected ? ' selected' : '') + '" onclick="toggleSegment(\'' + sub.id + '\')">' +
                '<div class="checkbox' + (isSelected ? ' checked' : '') + '"></div>' +
                '<div class="sub-info"><div class="sub-name">' + sub.name + '</div><div class="sub-desc">' + sub.desc + '</div></div>' +
                '<div class="sub-meta"><span class="meta-tag">' + sub.reach + '%</span>' +
                '<span class="meta-reach' + (mapping ? ' loaded' : '') + '" id="meta-' + sub.id + '">ğŸ“Š ' + metaText + '</span></div></div>';
        });
        
        card.innerHTML = '<div class="parent-header" onclick="toggleParent(\'' + parent.id + '\')">' +
            '<div class="parent-left"><div class="parent-icon">' + parent.icon + '</div><div>' +
            '<div class="parent-name">' + parent.name + '</div>' +
            '<div class="parent-count">' + parent.subs.length + ' segment' + (selectedInParent > 0 ? ' â€¢ <span style="color:var(--accent-green)">' + selectedInParent + ' seÃ§ili</span>' : '') + '</div></div></div>' +
            '<div class="parent-actions"><button class="select-all-btn" onclick="event.stopPropagation();selectAllInParent(\'' + parent.id + '\')">' + 
            (selectedInParent === parent.subs.length ? 'KaldÄ±r' : 'TÃ¼mÃ¼') + '</button><span class="expand-icon">â–¼</span></div></div>' +
            '<div class="sub-segments">' + subsHtml + '</div>';
        grid.appendChild(card);
    });
}

function toggleParent(parentId) {
    var card = document.querySelector('[data-parent="' + parentId + '"]');
    card.classList.toggle('expanded');
}

function toggleSegment(segmentId) {
    if (selectedSegments.has(segmentId)) {
        selectedSegments.delete(segmentId);
    } else {
        selectedSegments.add(segmentId);
    }
    updateUI();
    updateSteps();
}

function selectAllInParent(parentId) {
    var parent = segments.find(function(p) { return p.id === parentId; });
    var allSelected = parent.subs.every(function(s) { return selectedSegments.has(s.id); });
    parent.subs.forEach(function(sub) {
        if (allSelected) { selectedSegments.delete(sub.id); }
        else { selectedSegments.add(sub.id); }
    });
    updateUI();
    updateSteps();
}

function selectFunnel(funnel) {
    var btn = document.getElementById('funnel-' + funnel);
    var wasActive = btn.classList.contains('active');
    document.querySelectorAll('.quick-action').forEach(function(b) { b.classList.remove('active'); });
    
    if (wasActive) {
        activeFunnel = null;
        clearSelection();
        closeSuggestions();
    } else {
        btn.classList.add('active');
        activeFunnel = funnel;
        selectedSegments.clear();
        funnelSegments[funnel].forEach(function(segId) {
            if (findSegment(segId)) { selectedSegments.add(segId); }
        });
        updateUI();
        updateSteps();
        document.querySelectorAll('.parent-card').forEach(function(card) { card.classList.add('expanded'); });
        generateSuggestions();
    }
}

function clearSelection() {
    selectedSegments.clear();
    activeFunnel = null;
    document.querySelectorAll('.quick-action').forEach(function(b) { b.classList.remove('active'); });
    updateUI();
    updateSteps();
    closeSuggestions();
}

function findSegment(segmentId) {
    for (var i = 0; i < segments.length; i++) {
        var sub = segments[i].subs.find(function(s) { return s.id === segmentId; });
        if (sub) return sub;
    }
    return null;
}

function updateUI() {
    document.getElementById('selectedCount').textContent = selectedSegments.size;
    document.getElementById('footerCount').textContent = selectedSegments.size;
    
    var totalReach = 0;
    segments.forEach(function(p) {
        p.subs.forEach(function(s) {
            if (selectedSegments.has(s.id)) totalReach += s.reach * 0.6;
        });
    });
    document.getElementById('totalReach').textContent = Math.min(totalReach, 95).toFixed(1) + '%';
    
    if (selectedSegments.size > 0) {
        document.getElementById('footerActions').classList.add('visible');
    } else {
        document.getElementById('footerActions').classList.remove('visible');
    }
    
    var chipsContainer = document.getElementById('selectedChips');
    chipsContainer.innerHTML = '';
    var count = 0;
    selectedSegments.forEach(function(segId) {
        if (count >= 4) return;
        var seg = findSegment(segId);
        if (seg) {
            var chip = document.createElement('span');
            chip.className = 'selected-chip';
            chip.innerHTML = seg.name + ' <span class="chip-remove" onclick="event.stopPropagation();toggleSegment(\'' + segId + '\')">Ã—</span>';
            chipsContainer.appendChild(chip);
            count++;
        }
    });
    if (selectedSegments.size > 4) {
        var moreChip = document.createElement('span');
        moreChip.className = 'selected-chip';
        moreChip.textContent = '+' + (selectedSegments.size - 4) + ' daha';
        chipsContainer.appendChild(moreChip);
    }
    
    var activeFilter = document.querySelector('.filter-btn.active');
    renderSegments(activeFilter ? activeFilter.dataset.filter : 'all', document.getElementById('searchInput').value);
}

function updateSteps() {
    var step1 = document.getElementById('step1');
    var step2 = document.getElementById('step2');
    if (activeFunnel) { step1.classList.add('completed'); } else { step1.classList.remove('completed'); }
    if (selectedSegments.size > 0) {
        step2.classList.add('active');
        if (selectedSegments.size >= 3) { step2.classList.add('completed'); } else { step2.classList.remove('completed'); }
    } else {
        step2.classList.remove('active');
        step2.classList.remove('completed');
    }
}

// AI SUGGESTIONS
function generateSuggestions() {
    currentSuggestions = [];
    var panel = document.getElementById('aiSuggestions');
    
    selectedSegments.forEach(function(segId) {
        if (!META_SEGMENT_MAP[segId] && INTEREST_RECOMMENDATIONS[segId]) {
            var rec = INTEREST_RECOMMENDATIONS[segId];
            var segment = findSegment(segId);
            if (segment) {
                currentSuggestions.push({
                    segmentId: segId,
                    segmentName: segment.name,
                    keyword: rec.keyword,
                    suggestedName: rec.name,
                    status: 'pending',
                    selectedInterest: null,
                    audienceSize: null
                });
            }
        }
    });
    
    if (currentSuggestions.length > 0) {
        panel.classList.add('visible');
        document.getElementById('suggestionCount').textContent = '(' + currentSuggestions.length + ' segment iÃ§in)';
        renderSuggestions();
        fetchAllSuggestions();
    } else {
        panel.classList.remove('visible');
    }
}

function renderSuggestions() {
    var list = document.getElementById('suggestionsList');
    var html = '';
    
    currentSuggestions.forEach(function(s, idx) {
        var statusHtml = '';
        var actionsHtml = '';
        
        if (s.status === 'loading') {
            statusHtml = '<span style="color:var(--accent-yellow)">â³ AranÄ±yor...</span>';
        } else if (s.status === 'accepted') {
            statusHtml = '<span class="suggestion-status">âœ“ Kabul Edildi</span>';
        } else if (s.status === 'skipped') {
            statusHtml = '<span style="color:var(--text-secondary)">AtlandÄ±</span>';
        } else if (s.selectedInterest) {
            var sizeText = s.audienceSize ? ' (' + formatMetaNumber(s.audienceSize) + ')' : '';
            statusHtml = '<span class="suggestion-interest">' + s.selectedInterest.name + '</span><span class="suggestion-size">' + sizeText + '</span>';
            actionsHtml = '<button class="suggestion-btn accept" onclick="acceptSuggestion(' + idx + ')">âœ“ Kabul</button><button class="suggestion-btn skip" onclick="skipSuggestion(' + idx + ')">Atla</button>';
        } else {
            statusHtml = '<span style="color:var(--text-secondary)">Bekleniyor...</span>';
        }
        
        html += '<div class="suggestion-item' + (s.status === 'accepted' ? ' accepted' : '') + (s.status === 'loading' ? ' loading' : '') + '">' +
            '<div class="suggestion-left"><span class="suggestion-segment">' + s.segmentName + '</span>' +
            '<span class="suggestion-arrow">â†’</span>' + statusHtml + '</div>' +
            '<div class="suggestion-actions">' + actionsHtml + '</div></div>';
    });
    
    list.innerHTML = html;
}

function fetchAllSuggestions() {
    updateMetaStatus('loading', 'Ã–neriler hazÄ±rlanÄ±yor...');
    
    var promises = currentSuggestions.map(function(s, idx) {
        if (s.status !== 'pending') return Promise.resolve();
        
        s.status = 'loading';
        renderSuggestions();
        
        return new Promise(function(resolve) {
            setTimeout(function() {
                var url = 'https://graph.facebook.com/' + META_CONFIG.apiVersion + '/search?type=adinterest&q=' + encodeURIComponent(s.keyword) + '&limit=1&access_token=' + META_CONFIG.accessToken;
                
                fetch(url)
                    .then(function(res) { return res.json(); })
                    .then(function(data) {
                        if (data.data && data.data.length > 0) {
                            var interest = data.data[0];
                            s.selectedInterest = { id: interest.id, name: interest.name };
                            
                            return getMetaReachEstimate([{ id: interest.id, name: interest.name }])
                                .then(function(sizeData) {
                                    s.audienceSize = sizeData.users_upper_bound;
                                })
                                .catch(function() {
                                    s.audienceSize = null;
                                });
                        }
                    })
                    .then(function() {
                        s.status = 'ready';
                        renderSuggestions();
                        resolve();
                    })
                    .catch(function(err) {
                        console.error('Error:', err);
                        s.status = 'error';
                        renderSuggestions();
                        resolve();
                    });
            }, idx * 400);
        });
    });
    
    Promise.all(promises).then(function() {
        updateMetaStatus('connected', 'âœ“ Ã–neriler hazÄ±r');
    });
}

function acceptSuggestion(idx) {
    var s = currentSuggestions[idx];
    if (s.selectedInterest) {
        META_SEGMENT_MAP[s.segmentId] = {
            name: s.segmentName,
            interests: [s.selectedInterest]
        };
        if (s.audienceSize) {
            metaDataCache[s.segmentId] = { formatted: formatMetaNumber(s.audienceSize) };
        }
        s.status = 'accepted';
        saveMappings();
        updateMetaCount();
        renderSuggestions();
        renderSegments();
        showNotification('âœ“ ' + s.segmentName + ' â†’ ' + s.selectedInterest.name);
    }
}

function skipSuggestion(idx) {
    currentSuggestions[idx].status = 'skipped';
    renderSuggestions();
}

function acceptAllSuggestions() {
    var accepted = 0;
    currentSuggestions.forEach(function(s, idx) {
        if (s.status === 'ready' && s.selectedInterest) {
            META_SEGMENT_MAP[s.segmentId] = {
                name: s.segmentName,
                interests: [s.selectedInterest]
            };
            if (s.audienceSize) {
                metaDataCache[s.segmentId] = { formatted: formatMetaNumber(s.audienceSize) };
            }
            s.status = 'accepted';
            accepted++;
        }
    });
    saveMappings();
    updateMetaCount();
    renderSuggestions();
    renderSegments();
    showNotification('âœ“ ' + accepted + ' Ã¶neri kabul edildi');
}

function closeSuggestions() {
    document.getElementById('aiSuggestions').classList.remove('visible');
    currentSuggestions = [];
}

// META API
function formatMetaNumber(num) {
    if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
    if (num >= 1000) return Math.round(num / 1000) + 'K';
    return num.toString();
}

function updateMetaStatus(status, text) {
    var el = document.getElementById('metaStatus');
    el.className = 'meta-status ' + status;
    el.textContent = text;
}

function updateMetaCount() {
    var count = Object.keys(META_SEGMENT_MAP).length;
    document.getElementById('metaLoadedCount').textContent = count + ' eÅŸleÅŸme';
}

function getMetaReachEstimate(interests) {
    var targetingSpec = {
        geo_locations: { countries: ['TR'] },
        age_min: 18,
        age_max: 65,
        flexible_spec: [{ interests: interests }]
    };
    var url = 'https://graph.facebook.com/' + META_CONFIG.apiVersion + '/act_' + META_CONFIG.adAccountId + '/reachestimate?targeting_spec=' + encodeURIComponent(JSON.stringify(targetingSpec)) + '&access_token=' + META_CONFIG.accessToken;
    
    return fetch(url)
        .then(function(res) { return res.json(); })
        .then(function(data) {
            if (data.error) throw new Error(data.error.message);
            return data.data;
        });
}

function loadSavedMappings() {
    var saved = localStorage.getItem('metaSegmentMappings');
    if (saved) {
        META_SEGMENT_MAP = JSON.parse(saved);
    }
}

function saveMappings() {
    localStorage.setItem('metaSegmentMappings', JSON.stringify(META_SEGMENT_MAP));
}

function searchInterest() {
    var query = document.getElementById('interestSearch').value;
    if (!query || query.length < 2) { alert('En az 2 karakter girin'); return; }
    
    var resultsDiv = document.getElementById('interestResults');
    resultsDiv.style.display = 'block';
    resultsDiv.innerHTML = '<p style="color:var(--text-secondary)">ğŸ” AranÄ±yor...</p>';
    
    var url = 'https://graph.facebook.com/' + META_CONFIG.apiVersion + '/search?type=adinterest&q=' + encodeURIComponent(query) + '&access_token=' + META_CONFIG.accessToken;
    
    fetch(url)
        .then(function(res) { return res.json(); })
        .then(function(data) {
            if (data.error) {
                resultsDiv.innerHTML = '<p style="color:#f87171">Hata: ' + data.error.message + '</p>';
                return;
            }
            if (!data.data || data.data.length === 0) {
                resultsDiv.innerHTML = '<p style="color:var(--text-secondary)">SonuÃ§ bulunamadÄ±</p>';
                return;
            }
            
            var html = '<div style="margin-bottom:16px;padding:12px;background:rgba(0,212,255,0.1);border-radius:10px">' +
                '<div style="font-size:12px;color:var(--accent-blue);margin-bottom:8px;font-weight:600">ğŸ“Œ Segment seÃ§:</div>' +
                '<select id="segmentSelector" style="width:100%;padding:10px;background:var(--bg-card);border:1px solid var(--border-color);border-radius:8px;color:var(--text-primary);font-size:12px">' +
                '<option value="">-- Segment SeÃ§ --</option>' + getAllSegmentOptions() + '</select></div>';
            
            data.data.slice(0, 8).forEach(function(interest) {
                html += '<div style="display:flex;justify-content:space-between;align-items:center;padding:12px;background:var(--bg-card);border-radius:10px;margin-bottom:10px">' +
                    '<div style="flex:1"><div style="font-size:14px;font-weight:500">' + interest.name + '</div>' +
                    '<div style="font-size:11px;color:var(--text-secondary)">ID: ' + interest.id + '</div></div>' +
                    '<button onclick="assignInterestToSegment(\'' + interest.id + '\',\'' + interest.name.replace(/'/g, "\\'") + '\')" ' +
                    'style="padding:8px 16px;background:linear-gradient(135deg,#10b981,#059669);border:none;border-radius:8px;color:white;font-size:11px;cursor:pointer">âœ“ Ata</button></div>';
            });
            
            resultsDiv.innerHTML = html;
        })
        .catch(function(err) {
            resultsDiv.innerHTML = '<p style="color:#f87171">Hata: ' + err.message + '</p>';
        });
}

function getAllSegmentOptions() {
    var options = '';
    segments.forEach(function(parent) {
        options += '<optgroup label="' + parent.icon + ' ' + parent.name + '">';
        parent.subs.forEach(function(sub) {
            var currentInterest = META_SEGMENT_MAP[sub.id] ? META_SEGMENT_MAP[sub.id].interests[0].name : 'AtanmamÄ±ÅŸ';
            options += '<option value="' + sub.id + '">' + sub.name + ' (' + currentInterest + ')</option>';
        });
        options += '</optgroup>';
    });
    return options;
}

function assignInterestToSegment(interestId, interestName) {
    var selector = document.getElementById('segmentSelector');
    var segmentId = selector.value;
    if (!segmentId) { alert('LÃ¼tfen Ã¶nce bir segment seÃ§in!'); return; }
    
    var seg = findSegment(segmentId);
    META_SEGMENT_MAP[segmentId] = {
        name: seg ? seg.name : segmentId,
        interests: [{ id: interestId, name: interestName }]
    };
    saveMappings();
    updateMetaCount();
    selector.innerHTML = '<option value="">-- Segment SeÃ§ --</option>' + getAllSegmentOptions();
    renderSegments();
    showNotification('âœ“ ' + interestName + ' â†’ ' + (seg ? seg.name : segmentId));
}

function showNotification(message) {
    var notif = document.createElement('div');
    notif.style.cssText = 'position:fixed;bottom:100px;right:20px;background:linear-gradient(135deg,#10b981,#059669);color:white;padding:14px 24px;border-radius:12px;font-size:13px;font-weight:500;z-index:10000;animation:slideIn 0.3s ease';
    notif.textContent = message;
    document.body.appendChild(notif);
    setTimeout(function() { notif.remove(); }, 2500);
}

function showMappingsModal() {
    var modal = document.createElement('div');
    modal.id = 'mappingsModal';
    modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);display:flex;align-items:center;justify-content:center;z-index:10000';
    
    var html = '';
    Object.keys(META_SEGMENT_MAP).forEach(function(segId) {
        var data = META_SEGMENT_MAP[segId];
        var segName = findSegment(segId) ? findSegment(segId).name : segId;
        var interestName = data.interests[0].name;
        html += '<div style="display:flex;justify-content:space-between;align-items:center;padding:12px;background:var(--bg-secondary);border-radius:8px;margin-bottom:8px">' +
            '<div><div style="font-size:13px;font-weight:500">' + segName + '</div><div style="font-size:11px;color:var(--accent-blue)">â†’ ' + interestName + '</div></div>' +
            '<button onclick="removeMapping(\'' + segId + '\')" style="padding:6px 12px;background:#ef4444;border:none;border-radius:6px;color:white;font-size:11px;cursor:pointer">Sil</button></div>';
    });
    
    modal.innerHTML = '<div style="background:var(--bg-card);border-radius:16px;width:520px;max-height:80vh;overflow:hidden;border:1px solid var(--border-color)">' +
        '<div style="padding:18px 22px;border-bottom:1px solid var(--border-color);display:flex;justify-content:space-between;align-items:center">' +
        '<h3 style="font-size:15px;color:var(--accent-blue)">ğŸ“‹ EÅŸleÅŸtirmeler (' + Object.keys(META_SEGMENT_MAP).length + ')</h3>' +
        '<button onclick="document.getElementById(\'mappingsModal\').remove()" style="background:none;border:none;color:var(--text-secondary);font-size:20px;cursor:pointer">âœ•</button></div>' +
        '<div style="padding:20px;max-height:60vh;overflow-y:auto">' + (html || '<p style="color:var(--text-secondary)">HenÃ¼z eÅŸleÅŸtirme yok</p>') + '</div>' +
        '<div style="padding:16px 22px;border-top:1px solid var(--border-color);display:flex;gap:12px;justify-content:flex-end">' +
        '<button onclick="clearAllMappings()" style="padding:10px 18px;background:#ef4444;border:none;border-radius:8px;color:white;font-size:12px;cursor:pointer">TÃ¼mÃ¼nÃ¼ Sil</button>' +
        '<button onclick="exportMappings()" style="padding:10px 18px;background:var(--accent-blue);border:none;border-radius:8px;color:#000;font-size:12px;cursor:pointer">ğŸ“¥ JSON</button></div></div>';
    
    document.body.appendChild(modal);
}

function removeMapping(segId) {
    delete META_SEGMENT_MAP[segId];
    delete metaDataCache[segId];
    saveMappings();
    updateMetaCount();
    document.getElementById('mappingsModal').remove();
    showMappingsModal();
    renderSegments();
}

function clearAllMappings() {
    if (confirm('TÃ¼m eÅŸleÅŸtirmeleri silmek istediÄŸinize emin misiniz?')) {
        META_SEGMENT_MAP = {};
        metaDataCache = {};
        localStorage.removeItem('metaSegmentMappings');
        updateMetaCount();
        document.getElementById('mappingsModal').remove();
        showNotification('TÃ¼m eÅŸleÅŸtirmeler silindi');
        renderSegments();
    }
}

function exportMappings() {
    var data = JSON.stringify(META_SEGMENT_MAP, null, 2);
    var blob = new Blob([data], { type: 'application/json' });
    var a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'segment-interest-mappings.json';
    a.click();
}

function exportSelection() {
    var csv = 'Segment,AÃ§Ä±klama,Reach,Meta Interest\n';
    selectedSegments.forEach(function(segId) {
        var s = findSegment(segId);
        var interest = META_SEGMENT_MAP[segId] ? META_SEGMENT_MAP[segId].interests[0].name : '';
        if (s) csv += '"' + s.name + '","' + s.desc + '",' + s.reach + '%,"' + interest + '"\n';
    });
    var blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    var a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'secili_segmentler.csv';
    a.click();
    document.getElementById('step4').classList.add('completed');
}

function goToQuadrant() {
    if (selectedSegments.size === 0) { alert('LÃ¼tfen en az bir segment seÃ§in'); return; }
    var selectedData = [];
    selectedSegments.forEach(function(segId) {
        for (var i = 0; i < segments.length; i++) {
            var sub = segments[i].subs.find(function(s) { return s.id === segId; });
            if (sub) {
                selectedData.push({ id: sub.id, name: sub.name, desc: sub.desc, reach: sub.reach * 100000, parent: segments[i].name });
                break;
            }
        }
    });
    localStorage.setItem('selectedSegments', JSON.stringify(selectedData));
    localStorage.setItem('metaSegmentMappings', JSON.stringify(META_SEGMENT_MAP));
    document.getElementById('step3').classList.add('completed');
    setTimeout(function() { window.location.href = 'segmentation-quadrant.html'; }, 300);
}

init();
    </script>
</body>
</html>
