<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Segment K√ºt√ºphanesi | Time & Growity</title>
    <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Sora:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-card: #1a1a24;
            --accent-blue: #00d4ff;
            --accent-purple: #7c3aed;
            --accent-orange: #ff6b35;
            --accent-green: #10b981;
            --accent-yellow: #f59e0b;
            --accent-pink: #ec4899;
            --accent-red: #ef4444;
            --accent-teal: #14b8a6;
            --text-primary: #f0f0f5;
            --text-secondary: #8888a0;
            --border-color: #2a2a3a;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Sora', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .bg-grid {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background-image: 
                linear-gradient(rgba(0, 212, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 212, 255, 0.03) 1px, transparent 1px);
            background-size: 50px 50px;
            pointer-events: none;
            z-index: 0;
        }

        .container {
            max-width: 1500px;
            margin: 0 auto;
            padding: 20px 24px;
            position: relative;
            z-index: 1;
        }

        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border-color);
        }

        .logo { display: flex; align-items: center; gap: 16px; }
        .logo-icon { width: 52px; height: 52px; }
        .logo-text h1 { font-size: 24px; font-weight: 600; background: linear-gradient(90deg, #E91E8C, #7B2D8E); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .logo-text .version-line { display: flex; align-items: center; gap: 12px; margin-top: 2px; }
        .logo-text .version { font-size: 12px; color: var(--text-secondary); font-family: 'Space Mono', monospace; letter-spacing: 1px; }
        .logo-text .update-date { font-size: 11px; color: var(--text-secondary); font-family: 'Space Mono', monospace; opacity: 0.7; }

        .header-actions { display: flex; gap: 12px; align-items: center; }
        .badge { background: var(--bg-card); border: 1px solid var(--border-color); padding: 8px 16px; border-radius: 20px; font-size: 12px; color: var(--accent-blue); font-family: 'Space Mono', monospace; }

        /* Hero - Kompakt */
        .hero { text-align: center; padding: 24px 20px 20px; }
        .hero-title { font-size: 36px; font-weight: 700; margin-bottom: 8px; background: linear-gradient(135deg, #fff 0%, var(--accent-blue) 50%, var(--accent-purple) 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .hero-subtitle { font-size: 15px; color: var(--text-secondary); max-width: 500px; margin: 0 auto; line-height: 1.5; }

        /* Top Bar - Stats + Funnel */
        .top-bar { display: flex; gap: 20px; margin-bottom: 20px; }
        
        .stats-bar { display: flex; gap: 12px; flex: 1; }
        .stat-card { background: var(--bg-card); border: 1px solid var(--border-color); padding: 12px 16px; border-radius: 10px; display: flex; align-items: center; gap: 10px; transition: all 0.3s; flex: 1; }
        .stat-card:hover { border-color: var(--accent-blue); }
        .stat-icon { width: 36px; height: 36px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 16px; }
        .stat-icon.blue { background: rgba(0,212,255,0.15); }
        .stat-icon.purple { background: rgba(124,58,237,0.15); }
        .stat-icon.green { background: rgba(16,185,129,0.15); }
        .stat-icon.orange { background: rgba(255,107,53,0.15); }
        .stat-value { font-size: 20px; font-weight: 700; font-family: 'Space Mono', monospace; color: var(--accent-blue); }
        .stat-label { font-size: 10px; color: var(--text-secondary); }

        /* Meta API Badge */
        .meta-reach {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 3px 8px;
            background: linear-gradient(135deg, rgba(24,119,242,0.15), rgba(24,119,242,0.05));
            border: 1px solid rgba(24,119,242,0.25);
            border-radius: 10px;
            font-size: 9px;
            font-family: 'Space Mono', monospace;
            color: #60a5fa;
            cursor: help;
            transition: all 0.3s;
        }
        .meta-reach:hover {
            background: linear-gradient(135deg, rgba(24,119,242,0.25), rgba(24,119,242,0.1));
            border-color: rgba(24,119,242,0.4);
        }
        .meta-reach.loaded {
            color: #34d399;
            border-color: rgba(52,211,153,0.3);
            background: linear-gradient(135deg, rgba(52,211,153,0.15), rgba(52,211,153,0.05));
        }
        .meta-reach.error {
            color: #f87171;
            border-color: rgba(248,113,113,0.3);
        }
        .meta-live {
            width: 6px;
            height: 6px;
            background: #34d399;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(0.8); }
        }
        
        /* Meta Panel */
        .meta-panel {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 14px 18px;
            margin-bottom: 20px;
        }
        .meta-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .meta-panel-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--accent-blue);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .meta-status {
            font-size: 10px;
            padding: 4px 10px;
            border-radius: 12px;
            font-family: 'Space Mono', monospace;
        }
        .meta-status.connected { background: rgba(52,211,153,0.15); color: #34d399; }
        .meta-status.loading { background: rgba(251,191,36,0.15); color: #fbbf24; }
        .meta-status.error { background: rgba(248,113,113,0.15); color: #f87171; }
        .meta-btn {
            padding: 8px 16px;
            background: linear-gradient(135deg, #1877f2, #0d65d9);
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 11px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        .meta-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(24,119,242,0.3); }
        .meta-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

        /* Funnel Section */
        .funnel-section { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 12px; padding: 14px 18px; min-width: 380px; }
        .funnel-title { font-size: 10px; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; margin-bottom: 10px; font-family: 'Space Mono', monospace; letter-spacing: 1px; }
        .funnel-btns { display: flex; gap: 8px; }
        .funnel-btn { flex: 1; padding: 10px 12px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--bg-secondary); color: var(--text-secondary); font-size: 11px; font-family: 'Sora', sans-serif; cursor: pointer; transition: all 0.2s; text-align: center; }
        .funnel-btn:hover { border-color: var(--accent-purple); color: var(--text-primary); }
        .funnel-btn.awareness { border-left: 3px solid #7c3aed; }
        .funnel-btn.consideration { border-left: 3px solid #f59e0b; }
        .funnel-btn.conversion { border-left: 3px solid #10b981; }
        .funnel-btn.active { background: rgba(124,58,237,0.15); border-color: var(--accent-purple); color: var(--accent-purple); }
        .funnel-btn.active.awareness { background: rgba(124,58,237,0.2); border-color: #7c3aed; color: #a78bfa; }
        .funnel-btn.active.consideration { background: rgba(245,158,11,0.2); border-color: #f59e0b; color: #fbbf24; }
        .funnel-btn.active.conversion { background: rgba(16,185,129,0.2); border-color: #10b981; color: #34d399; }
        .funnel-count { font-size: 9px; opacity: 0.7; display: block; margin-top: 2px; font-family: 'Space Mono', monospace; }

        .controls { display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap; }
        .search-box { flex: 1; min-width: 280px; position: relative; }
        .search-input { width: 100%; padding: 12px 16px 12px 44px; border: 1px solid var(--border-color); border-radius: 10px; background: var(--bg-card); color: var(--text-primary); font-size: 14px; font-family: 'Sora', sans-serif; transition: all 0.3s; }
        .search-input::placeholder { color: var(--text-secondary); }
        .search-input:focus { outline: none; border-color: var(--accent-blue); box-shadow: 0 0 0 3px rgba(0,212,255,0.1); }
        .search-icon { position: absolute; left: 14px; top: 50%; transform: translateY(-50%); font-size: 16px; color: var(--text-secondary); }
        .filter-btns { display: flex; gap: 8px; flex-wrap: wrap; }
        .filter-btn { padding: 12px 16px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--bg-card); color: var(--text-secondary); font-size: 12px; font-family: 'Sora', sans-serif; cursor: pointer; transition: all 0.2s; }
        .filter-btn:hover { border-color: var(--accent-blue); color: var(--text-primary); }
        .filter-btn.active { background: linear-gradient(135deg, rgba(0,212,255,0.2), rgba(124,58,237,0.2)); border-color: var(--accent-blue); color: var(--accent-blue); }

        .segment-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(380px, 1fr)); gap: 24px; }

        .parent-card { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 16px; overflow: hidden; transition: all 0.3s; }
        .parent-card:hover { border-color: rgba(0,212,255,0.3); box-shadow: 0 8px 32px rgba(0,0,0,0.3); }
        .parent-header { padding: 20px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; border-bottom: 1px solid var(--border-color); transition: background 0.2s; }
        .parent-header:hover { background: rgba(255,255,255,0.02); }
        .parent-info { display: flex; align-items: center; gap: 14px; }
        .parent-icon { width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 22px; }
        .parent-name { font-size: 16px; font-weight: 600; }
        .parent-count { font-size: 12px; color: var(--text-secondary); font-family: 'Space Mono', monospace; margin-top: 2px; }
        .parent-actions { display: flex; align-items: center; gap: 12px; }
        .select-all-btn { padding: 8px 14px; border: 1px solid var(--border-color); border-radius: 8px; background: transparent; color: var(--text-secondary); font-size: 11px; font-family: 'Space Mono', monospace; cursor: pointer; transition: all 0.2s; }
        .select-all-btn:hover { background: rgba(0,212,255,0.1); border-color: var(--accent-blue); color: var(--accent-blue); }
        .expand-icon { font-size: 14px; color: var(--text-secondary); transition: transform 0.3s; }
        .parent-card.expanded .expand-icon { transform: rotate(180deg); }

        .sub-segments { max-height: 0; overflow: hidden; transition: max-height 0.4s ease; }
        .parent-card.expanded .sub-segments { max-height: 1000px; }
        .sub-segment { display: flex; align-items: center; gap: 14px; padding: 14px 20px; border-bottom: 1px solid rgba(255,255,255,0.03); cursor: pointer; transition: all 0.2s; }
        .sub-segment:hover { background: rgba(0,212,255,0.05); }
        .sub-segment:last-child { border-bottom: none; }
        .sub-segment.selected { background: rgba(0,212,255,0.1); }
        .checkbox { width: 22px; height: 22px; border: 2px solid var(--border-color); border-radius: 6px; display: flex; align-items: center; justify-content: center; transition: all 0.2s; flex-shrink: 0; }
        .checkbox.checked { background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple)); border-color: var(--accent-blue); }
        .checkbox.checked::after { content: '‚úì'; color: #fff; font-size: 12px; font-weight: bold; }
        .sub-info { flex: 1; }
        .sub-name { font-size: 14px; font-weight: 500; }
        .sub-desc { font-size: 12px; color: var(--text-secondary); margin-top: 3px; }
        .sub-meta { display: flex; gap: 8px; }
        .meta-tag { padding: 4px 10px; border-radius: 20px; font-size: 10px; font-family: 'Space Mono', monospace; background: rgba(255,255,255,0.05); color: var(--text-secondary); }

        .theme-blue .parent-icon { background: rgba(0,212,255,0.15); color: var(--accent-blue); }
        .theme-purple .parent-icon { background: rgba(124,58,237,0.15); color: var(--accent-purple); }
        .theme-green .parent-icon { background: rgba(16,185,129,0.15); color: var(--accent-green); }
        .theme-orange .parent-icon { background: rgba(255,107,53,0.15); color: var(--accent-orange); }
        .theme-pink .parent-icon { background: rgba(236,72,153,0.15); color: var(--accent-pink); }
        .theme-yellow .parent-icon { background: rgba(245,158,11,0.15); color: var(--accent-yellow); }
        .theme-red .parent-icon { background: rgba(239,68,68,0.15); color: var(--accent-red); }
        .theme-teal .parent-icon { background: rgba(20,184,166,0.15); color: var(--accent-teal); }
        .theme-cyan .parent-icon { background: rgba(6,182,212,0.15); color: #06b6d4; }
        .theme-indigo .parent-icon { background: rgba(99,102,241,0.15); color: #6366f1; }

        .empty-state { text-align: center; padding: 80px 20px; color: var(--text-secondary); }
        .empty-state-icon { font-size: 72px; margin-bottom: 20px; opacity: 0.5; }

        .footer-actions { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(10,10,15,0.95); border-top: 1px solid var(--border-color); padding: 20px 24px; display: flex; justify-content: space-between; align-items: center; backdrop-filter: blur(20px); transform: translateY(100%); transition: transform 0.3s; z-index: 100; }
        .footer-actions.visible { transform: translateY(0); }
        .footer-left { display: flex; align-items: center; gap: 16px; }
        .selected-chips { display: flex; gap: 8px; flex-wrap: wrap; max-width: 600px; }
        .selected-chip { background: rgba(0,212,255,0.15); border: 1px solid rgba(0,212,255,0.3); padding: 6px 12px; border-radius: 20px; font-size: 12px; display: flex; align-items: center; gap: 6px; }
        .chip-remove { cursor: pointer; opacity: 0.7; }
        .chip-remove:hover { opacity: 1; }

        .btn { padding: 14px 28px; border: none; border-radius: 10px; font-size: 14px; font-weight: 600; font-family: 'Sora', sans-serif; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; gap: 8px; text-decoration: none; }
        .btn-primary { background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple)); color: #fff; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0,212,255,0.3); }
        .btn-secondary { background: var(--bg-card); border: 1px solid var(--border-color); color: var(--text-primary); }
        .btn-secondary:hover { border-color: var(--accent-blue); }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-secondary); }
        ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--accent-blue); }
    </style>
</head>
<body>
    <div class="bg-grid"></div>
    
    <div class="container">
        <header class="header">
            <div class="logo">
                <div class="logo-icon">
                    <svg viewBox="0 0 52 52" width="52" height="52">
                        <!-- Pink ring (left, behind) -->
                        <circle cx="18" cy="26" r="14" fill="none" stroke="#E91E8C" stroke-width="5"/>
                        <!-- Purple ring (right, in front) with mask for interlock -->
                        <defs>
                            <mask id="interlockMask">
                                <rect width="100%" height="100%" fill="white"/>
                                <path d="M18 12 A14 14 0 0 1 18 40" fill="black"/>
                            </mask>
                        </defs>
                        <circle cx="34" cy="26" r="14" fill="none" stroke="#7B2D8E" stroke-width="5"/>
                        <!-- Pink arc that goes over purple (the interlock part) -->
                        <path d="M18 12 A14 14 0 0 0 18 40" fill="none" stroke="#E91E8C" stroke-width="5"/>
                    </svg>
                </div>
                <div class="logo-text">
                    <h1>Time & Growity</h1>
                    <div class="version-line">
                        <span class="version">Segment K√ºt√ºphanesi v7.8</span>
                        <span class="update-date">‚Ä¢ Ocak 2026</span>
                    </div>
                </div>
            </div>
            <div class="header-actions">
                <span class="badge">56 SEGMENT</span>
                <a href="po-segmentasyon.html" class="btn btn-secondary" style="border-color: rgba(227,30,36,0.4); color: #e31e24;">üéØ PO Premium Market</a>
                <a href="enerjisa-30yil.html" class="btn btn-secondary" style="border-color: rgba(255,193,7,0.4); color: #ffc107;">‚ö° Enerjisa 30. Yƒ±l</a>
            </div>
        </header>

        <section class="hero">
            <h1 class="hero-title">Segment K√ºt√ºphanesi</h1>
            <p class="hero-subtitle">TDY Lifestyle segmentlerini ke≈üfedin, analiz edin ve medya planlamanƒ±zƒ± optimize edin.</p>
        </section>

        <div class="top-bar">
            <div class="stats-bar">
                <div class="stat-card">
                    <div class="stat-icon blue">üë•</div>
                    <div><div class="stat-value">56</div><div class="stat-label">Toplam Segment</div></div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon purple">üìä</div>
                    <div><div class="stat-value">13</div><div class="stat-label">Ana Kategori</div></div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon green">‚úì</div>
                    <div><div class="stat-value" id="selectedCount">0</div><div class="stat-label">Se√ßili Segment</div></div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon orange">üìà</div>
                    <div><div class="stat-value" id="totalReach">0%</div><div class="stat-label">Tahmini Reach</div></div>
                </div>
            </div>
            <div class="funnel-section">
                <div class="funnel-title">Funnel Se√ßimi</div>
                <div class="funnel-btns">
                    <button class="funnel-btn awareness" onclick="selectFunnel('awareness')">Awareness<span class="funnel-count">18 segment</span></button>
                    <button class="funnel-btn consideration" onclick="selectFunnel('consideration')">Consideration<span class="funnel-count">20 segment</span></button>
                    <button class="funnel-btn conversion" onclick="selectFunnel('conversion')">Conversion<span class="funnel-count">14 segment</span></button>
                </div>
            </div>
        </div>

        <!-- Meta API Panel -->
        <div class="meta-panel">
            <div class="meta-panel-header">
                <div class="meta-panel-title">
                    <span>üìä</span> Meta Audience Data
                    <span class="meta-status" id="metaStatus">Baƒülantƒ± bekleniyor</span>
                </div>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <input type="text" id="interestSearch" placeholder="Interest ara (√∂r: travel, fitness)..." style="padding: 8px 12px; border: 1px solid var(--border-color); border-radius: 6px; background: var(--bg-secondary); color: var(--text-primary); font-size: 11px; width: 200px;">
                    <button class="meta-btn" onclick="searchInterest()" style="padding: 8px 14px;">üîç Ara</button>
                    <button class="meta-btn" onclick="showMappingsModal()" style="padding: 8px 14px; background: linear-gradient(135deg, #7c3aed, #6d28d9);">üìã E≈üle≈ütirmeler</button>
                    <span id="metaLoadedCount" style="font-size: 10px; color: var(--text-secondary); font-family: 'Space Mono', monospace;">0/0 segment</span>
                    <button class="meta-btn" id="metaLoadBtn" onclick="loadMetaData()">üîÑ Verileri √áek</button>
                </div>
            </div>
            <div id="interestResults" style="display: none; margin-top: 12px; padding: 12px; background: var(--bg-secondary); border-radius: 10px; max-height: 350px; overflow-y: auto; border: 1px solid var(--border-color);"></div>
        </div>

        <div class="controls">
            <div class="search-box">
                <span class="search-icon">üîç</span>
                <input type="text" class="search-input" placeholder="Segment ara..." id="searchInput">
            </div>
            <div class="filter-btns">
                <button class="filter-btn active" data-filter="all">T√ºm√º</button>
                <button class="filter-btn" data-filter="lifestyle">üåü Lifestyle</button>
                <button class="filter-btn" data-filter="demografik">üë§ Demografik</button>
                <button class="filter-btn" data-filter="davranis">üõí Davranƒ±≈ü</button>
                <button class="filter-btn" data-filter="b2c">‚ö° B2C</button>
                <button class="filter-btn" data-filter="b2b">üè¢ B2B</button>
            </div>
        </div>

        <div class="segment-grid" id="segmentGrid"></div>
    </div>

    <div class="footer-actions" id="footerActions">
        <div class="footer-left">
            <span style="color: var(--text-secondary); font-size: 13px;"><strong id="footerCount" style="color: var(--accent-blue);">0</strong> segment se√ßildi</span>
            <div class="selected-chips" id="selectedChips"></div>
        </div>
        <div style="display: flex; gap: 12px;">
            <button class="btn btn-secondary" onclick="clearSelection()">Temizle</button>
            <button class="btn btn-secondary" onclick="exportSelection()">üì• CSV</button>
            <button class="btn btn-primary" onclick="goToQuadrant()">üìä Quadrant'a G√∂nder ‚Üí</button>
        </div>
    </div>

    <script>
        const segments = [
            { id: 'yasam-tarzi', name: 'Ya≈üam Tarzƒ± Segmentleri', icon: 'üåü', theme: 'theme-purple', category: 'lifestyle', subs: [
                { id: 'yt-1', name: 'Trendsetter √ñnc√ºler', desc: 'Yeniliklere a√ßƒ±k, trendleri belirleyen grup', reach: 8.2 },
                { id: 'yt-2', name: 'Stat√º Odaklƒ± Profesyoneller', desc: 'Kariyer ve sosyal stat√º √∂ncelikli', reach: 12.5 },
                { id: 'yt-3', name: 'Deneyim Avcƒ±larƒ±', desc: 'Yeni deneyimler arayan maceraperestler', reach: 9.8 },
                { id: 'yt-4', name: 'Wellness Tutkunlarƒ±', desc: 'Saƒülƒ±k ve wellness odaklƒ± ya≈üam', reach: 7.3 }
            ]},
            { id: 'tuketim', name: 'T√ºketim Alƒ±≈ükanlƒ±klarƒ±', icon: 'üõí', theme: 'theme-blue', category: 'davranis', subs: [
                { id: 'tk-1', name: 'Premium T√ºketiciler', desc: 'Kaliteyi fiyatƒ±n √∂n√ºnde tutan', reach: 11.2 },
                { id: 'tk-2', name: 'Deƒüer Arayanlar', desc: 'En iyi fiyat-performans pe≈üinde', reach: 18.7 },
                { id: 'tk-3', name: 'D√ºrt√ºsel Alƒ±≈üveri≈ü√ßiler', desc: 'Anlƒ±k kararlarla alƒ±≈üveri≈ü yapan', reach: 14.3 },
                { id: 'tk-4', name: 'Planlƒ± Alƒ±≈üveri≈ü√ßiler', desc: 'Her ≈üeyi √∂nceden planlayan', reach: 15.8 }
            ]},
            { id: 'dijital', name: 'Dijital Davranƒ±≈ü', icon: 'üì±', theme: 'theme-green', category: 'davranis', subs: [
                { id: 'dj-1', name: 'Dijital Yerliler', desc: 'Hayatƒ± tamamen dijitalde ya≈üayan', reach: 22.4 },
                { id: 'dj-2', name: 'Sosyal Medya Aktifi', desc: 'T√ºm platformlarda aktif', reach: 28.6 },
                { id: 'dj-3', name: 'E-Ticaret Uzmanƒ±', desc: 'Online alƒ±≈üveri≈üi tercih eden', reach: 19.2 },
                { id: 'dj-4', name: 'Dijital Temkinli', desc: 'Teknolojiyle mesafeli', reach: 12.1 }
            ]},
            { id: 'aile', name: 'Aile Ya≈üamƒ±', icon: 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶', theme: 'theme-orange', category: 'demografik', subs: [
                { id: 'al-1', name: 'Gen√ß Aileler', desc: 'K√º√ß√ºk √ßocuklu aileler', reach: 16.8 },
                { id: 'al-2', name: 'B√ºy√ºyen Aileler', desc: 'Okul √ßaƒüƒ± √ßocuklu', reach: 14.2 },
                { id: 'al-3', name: 'Bo≈ü Yuva', desc: '√áocuklar evden ayrƒ±lmƒ±≈ü', reach: 9.5 },
                { id: 'al-4', name: 'Tekli Ya≈üayanlar', desc: 'Yalnƒ±z ya≈üayan yeti≈ükinler', reach: 11.3 }
            ]},
            { id: 'gelir', name: 'Gelir Segmentleri', icon: 'üí∞', theme: 'theme-yellow', category: 'demografik', subs: [
                { id: 'gl-1', name: '√úst Gelir A+', desc: 'En y√ºksek gelir grubu', reach: 5.2 },
                { id: 'gl-2', name: '√úst-Orta A', desc: 'Y√ºksek gelir grubu', reach: 12.8 },
                { id: 'gl-3', name: 'Orta B', desc: 'Orta gelir grubu', reach: 35.4 },
                { id: 'gl-4', name: 'Alt-Orta C', desc: 'Alt-orta gelir grubu', reach: 28.6 }
            ]},
            { id: 'medya', name: 'Medya T√ºketimi', icon: 'üì∫', theme: 'theme-pink', category: 'davranis', subs: [
                { id: 'md-1', name: 'TV Aƒüƒ±rlƒ±klƒ±', desc: 'Geleneksel TV izleyicisi', reach: 42.3 },
                { id: 'md-2', name: 'Streaming Odaklƒ±', desc: 'Dijital i√ßerik tercih eden', reach: 31.5 },
                { id: 'md-3', name: 'Multi-Screen', desc: '√áoklu ekran kullanƒ±cƒ±sƒ±', reach: 38.7 },
                { id: 'md-4', name: 'Radyo Dinleyicisi', desc: 'Aktif radyo takip√ßisi', reach: 24.8 }
            ]},
            { id: 'otomobil', name: 'Otomobil Segmentleri', icon: 'üöó', theme: 'theme-teal', category: 'davranis', subs: [
                { id: 'ot-1', name: 'Premium Ara√ß Sahipleri', desc: 'L√ºks segment ara√ß kullanƒ±cƒ±larƒ±', reach: 8.4 },
                { id: 'ot-2', name: 'SUV Tutkunlarƒ±', desc: 'SUV/crossover tercihi', reach: 15.2 },
                { id: 'ot-3', name: 'Ekonomik S√ºr√ºc√ºler', desc: 'Yakƒ±t tasarrufu odaklƒ±', reach: 22.6 },
                { id: 'ot-4', name: 'Elektrik/Hibrit ƒ∞lgili', desc: 'Alternatif yakƒ±t meraklƒ±larƒ±', reach: 6.8 }
            ]},
            { id: 'seyahat', name: 'Seyahat Tercihleri', icon: '‚úàÔ∏è', theme: 'theme-cyan', category: 'lifestyle', subs: [
                { id: 'sy-1', name: 'Sƒ±k Seyahat Edenler', desc: 'Yƒ±lda 4+ seyahat', reach: 12.4 },
                { id: 'sy-2', name: 'Tatil Planlayƒ±cƒ±larƒ±', desc: 'Yƒ±llƒ±k tatil odaklƒ±', reach: 28.6 },
                { id: 'sy-3', name: 'ƒ∞≈ü Seyahati Yapanlar', desc: 'Profesyonel seyahat', reach: 9.8 },
                { id: 'sy-4', name: 'Yerel Gezginler', desc: 'Yurt i√ßi ke≈üif seven', reach: 18.2 }
            ]},
            { id: 'finans', name: 'Finansal Davranƒ±≈ü', icon: 'üí≥', theme: 'theme-indigo', category: 'davranis', subs: [
                { id: 'fn-1', name: 'Yatƒ±rƒ±mcƒ±lar', desc: 'Aktif yatƒ±rƒ±m yapan', reach: 14.6 },
                { id: 'fn-2', name: 'Tasarruf Odaklƒ±', desc: 'Birikim √∂ncelikli', reach: 22.8 },
                { id: 'fn-3', name: 'Kredi Kullanƒ±cƒ±larƒ±', desc: 'Aktif kredi kullanan', reach: 31.4 },
                { id: 'fn-4', name: 'Dijital Bankacƒ±lƒ±k', desc: 'Mobile banking aktif', reach: 45.2 }
            ]},
            { id: 'beslenme', name: 'Beslenme Tercihleri', icon: 'üçΩÔ∏è', theme: 'theme-red', category: 'lifestyle', subs: [
                { id: 'bs-1', name: 'Saƒülƒ±klƒ± Beslenme', desc: 'Organik ve doƒüal tercih', reach: 18.4 },
                { id: 'bs-2', name: 'Fast Food Severler', desc: 'Hƒ±zlƒ± yemek tercihi', reach: 24.6 },
                { id: 'bs-3', name: 'Gurme Tutkunlarƒ±', desc: 'Kaliteli restoran seven', reach: 11.2 },
                { id: 'bs-4', name: 'Ev Yemekleri', desc: 'Evde pi≈üirmeyi tercih eden', reach: 32.8 }
            ]},
            // Enerjisa Hedef Kitleleri
            { id: 'influencer', name: 'Influencer (Etkileyiciler)', icon: '‚ö°', theme: 'theme-yellow', category: 'b2c', subs: [
                { id: 'inf-1', name: 'Hane Halklarƒ± - Kesintisiz Enerji', desc: 'G√ºvenilir elektrik ve hƒ±zlƒ± √ß√∂z√ºm bekleyen konut kullanƒ±cƒ±larƒ±', reach: 42.5 },
                { id: 'inf-2', name: 'Hane Halklarƒ± - Dijital M√º≈üteri', desc: 'Online i≈ülem ve kolay anla≈üƒ±lƒ±r fatura isteyen t√ºketiciler', reach: 28.3 },
                { id: 'inf-3', name: 'Mobil Kullanƒ±cƒ±lar', desc: 'Uygulama √ºzerinden hƒ±zlƒ± i≈ülem yapan dijital √∂ncelikli segment', reach: 35.6 },
                { id: 'inf-4', name: 'K√º√ß√ºk ƒ∞≈ületmeler', desc: 'Enerji maliyeti optimizasyonu arayan KOBƒ∞ sahipleri', reach: 12.8 },
                { id: 'inf-5', name: 'Enerjisa √áalƒ±≈üanlarƒ±', desc: 'Tek takƒ±m k√ºlt√ºr√º ve aidiyet duygusu ta≈üƒ±yan i√ß payda≈ülar', reach: 1.2 },
                { id: 'inf-6', name: 'G√ºven Odaklƒ± T√ºketiciler', desc: '≈ûeffaf ileti≈üim ve net bilgi bekleyen m√º≈üteri segmenti', reach: 38.4 }
            ]},
            { id: 'gatekeeper', name: 'Gatekeepers (Kapƒ± Bek√ßileri)', icon: 'üèõÔ∏è', theme: 'theme-teal', category: 'b2b', subs: [
                { id: 'gk-1', name: 'Yerel Y√∂netimler', desc: 'Belediyeler ve il √∂zel idareleri - b√∂lgesel enerji payda≈ülarƒ±', reach: 2.4 },
                { id: 'gk-2', name: 'Muhtarlar', desc: 'Mahalle d√ºzeyinde toplum liderleri ve yerel temsilciler', reach: 4.8 },
                { id: 'gk-3', name: 'STK ve Sivil Toplum', desc: 'S√ºrd√ºr√ºlebilirlik ve toplumsal fayda odaklƒ± kurulu≈ülar', reach: 1.6 },
                { id: 'gk-4', name: 'Akademik Kurumlar', desc: '√úniversiteler ve ara≈ütƒ±rma merkezleri - enerji d√∂n√º≈ü√ºm√º d√º≈ü√ºnce liderleri', reach: 0.8 },
                { id: 'gk-5', name: 'S√ºrd√ºr√ºlebilirlik Partnerleri', desc: '√áevre projeleri ve ye≈üil enerji i≈ü birliƒüi yapan payda≈ülar', reach: 1.2 }
            ]},
            { id: 'decisionmaker', name: 'Decision Makers (Karar Vericiler)', icon: 'üéØ', theme: 'theme-indigo', category: 'b2b', subs: [
                { id: 'dm-1', name: 'Devlet Kurumlarƒ±', desc: 'EPDK, Enerji Bakanlƒ±ƒüƒ± ve ilgili kamu otoriteleri', reach: 0.3 },
                { id: 'dm-2', name: 'Reg√ºlat√∂rler', desc: 'Enerji sekt√∂r√º d√ºzenleyici ve denetleyici kurumlar', reach: 0.2 },
                { id: 'dm-3', name: 'Kurumsal Yatƒ±rƒ±mcƒ±lar', desc: 'ESG odaklƒ± fonlar ve enerji sekt√∂r√º yatƒ±rƒ±mcƒ±larƒ±', reach: 0.8 },
                { id: 'dm-4', name: 'Bireysel Yatƒ±rƒ±mcƒ±lar', desc: 'Hisse senedi ve finansal performans takip√ßileri', reach: 3.5 },
                { id: 'dm-5', name: 'Stratejik ƒ∞≈ü Ortaklarƒ±', desc: 'Enerji d√∂n√º≈ü√ºm√ºnde uzun vadeli i≈ü birliƒüi hedefleyen ≈üirketler', reach: 1.4 }
            ]}
        ];

        let selectedSegments = new Set();

        function renderSegments(filter = 'all', search = '') {
            const grid = document.getElementById('segmentGrid');
            grid.innerHTML = '';
            const filtered = segments.filter(parent => {
                if (filter !== 'all' && parent.category !== filter) return false;
                if (search) {
                    const s = search.toLowerCase();
                    return parent.name.toLowerCase().includes(s) || parent.subs.some(sub => sub.name.toLowerCase().includes(s) || sub.desc.toLowerCase().includes(s));
                }
                return true;
            });
            if (filtered.length === 0) {
                grid.innerHTML = '<div class="empty-state" style="grid-column:1/-1;"><div class="empty-state-icon">üîç</div><h3>Segment bulunamadƒ±</h3></div>';
                return;
            }
            filtered.forEach(parent => {
                const isExpanded = document.querySelector(`[data-parent="${parent.id}"]`)?.classList.contains('expanded');
                const selectedInParent = parent.subs.filter(s => selectedSegments.has(s.id)).length;
                const card = document.createElement('div');
                card.className = `parent-card ${parent.theme}${isExpanded ? ' expanded' : ''}`;
                card.dataset.parent = parent.id;
                card.innerHTML = `
                    <div class="parent-header" onclick="toggleParent('${parent.id}')">
                        <div class="parent-info">
                            <div class="parent-icon">${parent.icon}</div>
                            <div><div class="parent-name">${parent.name}</div><div class="parent-count">${parent.subs.length} segment${selectedInParent > 0 ? ` ‚Ä¢ ${selectedInParent} se√ßili` : ''}</div></div>
                        </div>
                        <div class="parent-actions">
                            <button class="select-all-btn" onclick="event.stopPropagation(); selectAllInParent('${parent.id}')">${selectedInParent === parent.subs.length ? 'T√ºm√ºn√º Kaldƒ±r' : 'T√ºm√ºn√º Se√ß'}</button>
                            <span class="expand-icon">‚ñº</span>
                        </div>
                    </div>
                    <div class="sub-segments">
                        ${parent.subs.map(sub => `
                            <div class="sub-segment${selectedSegments.has(sub.id) ? ' selected' : ''}" onclick="toggleSegment('${sub.id}')">
                                <div class="checkbox${selectedSegments.has(sub.id) ? ' checked' : ''}"></div>
                                <div class="sub-info"><div class="sub-name">${sub.name}</div><div class="sub-desc">${sub.desc}</div></div>
                                <div class="sub-meta">
                                                    <span class="meta-tag">${sub.reach}%</span>
                                                    <span class="meta-reach" id="meta-${sub.id}" title="Meta'dan y√ºkleniyor...">üìä --</span>
                                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        function toggleParent(parentId) { document.querySelector(`[data-parent="${parentId}"]`).classList.toggle('expanded'); }
        function toggleSegment(segmentId) { selectedSegments.has(segmentId) ? selectedSegments.delete(segmentId) : selectedSegments.add(segmentId); updateUI(); }
        function selectAllInParent(parentId) {
            const parent = segments.find(p => p.id === parentId);
            const allSelected = parent.subs.every(s => selectedSegments.has(s.id));
            parent.subs.forEach(sub => allSelected ? selectedSegments.delete(sub.id) : selectedSegments.add(sub.id));
            updateUI();
        }
        function clearSelection() { selectedSegments.clear(); updateUI(); }
        function findSegment(segmentId) { for (const p of segments) { const s = p.subs.find(s => s.id === segmentId); if (s) return s; } return null; }

        function updateUI() {
            document.getElementById('selectedCount').textContent = selectedSegments.size;
            document.getElementById('footerCount').textContent = selectedSegments.size;
            let totalReach = 0;
            segments.forEach(p => p.subs.forEach(s => { if (selectedSegments.has(s.id)) totalReach += s.reach * 0.6; }));
            document.getElementById('totalReach').textContent = Math.min(totalReach, 95).toFixed(1) + '%';
            document.getElementById('footerActions').classList.toggle('visible', selectedSegments.size > 0);
            const chipsContainer = document.getElementById('selectedChips');
            chipsContainer.innerHTML = '';
            let count = 0;
            selectedSegments.forEach(segId => {
                if (count >= 5) return;
                const seg = findSegment(segId);
                if (seg) { chipsContainer.innerHTML += `<span class="selected-chip">${seg.name} <span class="chip-remove" onclick="event.stopPropagation(); toggleSegment('${segId}')">√ó</span></span>`; count++; }
            });
            if (selectedSegments.size > 5) chipsContainer.innerHTML += `<span class="selected-chip">+${selectedSegments.size - 5} daha</span>`;
            const filter = document.querySelector('.filter-btn.active')?.dataset.filter || 'all';
            renderSegments(filter, document.getElementById('searchInput').value);
        }

        function exportSelection() {
            let csv = 'Segment,A√ßƒ±klama,Reach\n';
            selectedSegments.forEach(segId => { const s = findSegment(segId); if (s) csv += `"${s.name}","${s.desc}",${s.reach}%\n`; });
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'secili_segmentler.csv'; a.click();
        }

        function goToQuadrant() {
            if (selectedSegments.size === 0) {
                alert('L√ºtfen en az bir segment se√ßin');
                return;
            }
            // Se√ßili segmentleri localStorage'a kaydet (Meta reach dahil)
            const selectedData = [];
            selectedSegments.forEach(segId => {
                for (const parent of segments) {
                    const sub = parent.subs.find(s => s.id === segId);
                    if (sub) {
                        // Meta reach verisini al
                        const metaData = metaDataCache[segId] || {};
                        const metaMapping = META_SEGMENT_MAP[segId] || {};
                        
                        selectedData.push({
                            id: sub.id,
                            name: sub.name,
                            desc: sub.desc,
                            reach: sub.reach * 100000, // TDY Reach sayƒ±sƒ±na √ßevir
                            parent: parent.name,
                            // Meta verileri
                            metaReach: metaData.estimate || null,
                            metaReachLower: metaData.lower || null,
                            metaReachUpper: metaData.upper || null,
                            metaReachFormatted: metaData.formatted || null,
                            metaInterest: metaMapping.interests?.[0] || null
                        });
                        break;
                    }
                }
            });
            
            // Meta mapping'leri de kaydet (quadrant'ta kullanmak i√ßin)
            localStorage.setItem('selectedSegments', JSON.stringify(selectedData));
            localStorage.setItem('metaSegmentMappings', JSON.stringify(META_SEGMENT_MAP));
            
            window.location.href = 'segmentation-quadrant.html';
        }

        document.querySelectorAll('.filter-btn').forEach(btn => btn.addEventListener('click', () => {
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            renderSegments(btn.dataset.filter, document.getElementById('searchInput').value);
        }));
        document.getElementById('searchInput').addEventListener('input', (e) => renderSegments(document.querySelector('.filter-btn.active')?.dataset.filter || 'all', e.target.value));
        
        // Funnel bazlƒ± segment se√ßimleri
        const funnelSegments = {
            awareness: ['yt-1', 'yt-3', 'dj-2', 'dj-1', 'mo-2', 'mo-1', 'il-1', 'il-2', 'ko-2', 'fi-1', 'fi-2', 'sa-1', 'inf-1', 'inf-2', 'inf-6', 'gk-1', 'gk-2', 'gk-3'],
            consideration: ['yt-2', 'yt-4', 'tk-1', 'tk-2', 'dj-3', 'al-1', 'al-2', 'mo-3', 'ko-1', 'ko-3', 'fi-3', 'fi-4', 'sa-2', 'sa-3', 'inf-3', 'inf-4', 'gk-4', 'gk-5', 'dm-3', 'dm-4'],
            conversion: ['tk-3', 'tk-4', 'dj-4', 'al-3', 'al-4', 'mo-4', 'il-3', 'il-4', 'ko-4', 'sa-4', 'inf-5', 'dm-1', 'dm-2', 'dm-5']
        };
        
        let activeFunnel = null;
        
        function selectFunnel(funnel) {
            const btn = document.querySelector(`.funnel-btn.${funnel}`);
            const wasActive = btn.classList.contains('active');
            
            // T√ºm funnel butonlarƒ±nƒ± deaktive et
            document.querySelectorAll('.funnel-btn').forEach(b => b.classList.remove('active'));
            
            if (wasActive) {
                // Aynƒ± butona tƒ±klandƒ±ysa se√ßimi temizle
                activeFunnel = null;
                clearSelection();
            } else {
                // Yeni funnel se√ß
                btn.classList.add('active');
                activeFunnel = funnel;
                
                // √ñnce se√ßimi temizle
                selectedSegments.clear();
                
                // ƒ∞lgili segmentleri se√ß
                funnelSegments[funnel].forEach(segId => {
                    // Segment var mƒ± kontrol et
                    if (findSegment(segId)) {
                        selectedSegments.add(segId);
                    }
                });
                
                updateUI();
                
                // T√ºm parent kartlarƒ± a√ß
                document.querySelectorAll('.parent-card').forEach(card => card.classList.add('expanded'));
            }
        }
        
        renderSegments();
        
        // ============================================
        // META MARKETING API ENTEGRASYONU
        // ============================================
        
        const META_CONFIG = {
            accessToken: 'EAAYe5SrdjKgBQZAZAZCh5uE3KLAyOrABkdC5gZCZBcLwdzaAXOKAjGVP7puJt2IijGivXAtQZCd6tbPrkDSoK9JRfWZBHsq2CuqdkL4L33a0xWDbZAyQxuwSjA62eZB3GcZBB6FXWueGyExbs3zZApqbB5IlEZCOfMM1zPjqKYaQF1N2TYZCoAfEfbLgWJZBFz0tggiOnKRwZDZD',
            adAccountId: '1449083392081509',
            apiVersion: 'v18.0'
        };
        
        // Segment -> Meta Interest Mapping (Doƒürulanmƒ±≈ü ID'ler)
        const META_SEGMENT_MAP = {
            'yt-1': { name: 'Trendsetter √ñnc√ºler', interests: [{ id: '6003139266461', name: 'Travel' }] },
            'yt-2': { name: 'Stat√º Odaklƒ± Profesyoneller', interests: [{ id: '6003139266461', name: 'Travel' }] },
            'yt-3': { name: 'Deneyim Avcƒ±larƒ±', interests: [{ id: '6003139266461', name: 'Travel' }] },
            'yt-4': { name: 'Wellness Tutkunlarƒ±', interests: [{ id: '6003139266461', name: 'Travel' }] },
            'tk-1': { name: 'Premium T√ºketiciler', interests: [{ id: '6003139266461', name: 'Travel' }] },
            'tk-2': { name: 'Deƒüer Arayanlar', interests: [{ id: '6003139266461', name: 'Travel' }] },
            'tk-3': { name: 'D√ºrt√ºsel Alƒ±≈üveri≈ü√ßiler', interests: [{ id: '6003139266461', name: 'Travel' }] },
            'tk-4': { name: 'Planlƒ± Alƒ±≈üveri≈ü√ßiler', interests: [{ id: '6003139266461', name: 'Travel' }] },
            'dj-1': { name: 'Dijital Yerliler', interests: [{ id: '6003139266461', name: 'Travel' }] },
            'dj-2': { name: 'Sosyal Medya Aktifi', interests: [{ id: '6003139266461', name: 'Travel' }] },
            'dj-3': { name: 'E-Ticaret Uzmanƒ±', interests: [{ id: '6003139266461', name: 'Travel' }] },
            'dj-4': { name: 'Dijital Temkinli', interests: [{ id: '6003139266461', name: 'Travel' }] },
            'al-1': { name: 'Gen√ß Aileler', interests: [{ id: '6003139266461', name: 'Travel' }] },
            'al-2': { name: 'B√ºy√ºyen Aileler', interests: [{ id: '6003139266461', name: 'Travel' }] },
            'ot-1': { name: 'Premium Ara√ß Sahipleri', interests: [{ id: '6003139266461', name: 'Travel' }] },
            'ot-2': { name: 'SUV Tutkunlarƒ±', interests: [{ id: '6003139266461', name: 'Travel' }] },
            'ot-3': { name: 'Ekonomik S√ºr√ºc√ºler', interests: [{ id: '6003139266461', name: 'Travel' }] },
            'ot-4': { name: 'Elektrik/Hibrit ƒ∞lgili', interests: [{ id: '6003139266461', name: 'Travel' }] },
            'sy-1': { name: 'Sƒ±k Seyahat Edenler', interests: [{ id: '6003139266461', name: 'Travel' }] },
            'sy-2': { name: 'Tatil Planlayƒ±cƒ±larƒ±', interests: [{ id: '6003139266461', name: 'Travel' }] },
            'fn-1': { name: 'Yatƒ±rƒ±mcƒ±lar', interests: [{ id: '6003139266461', name: 'Travel' }] },
            'fn-4': { name: 'Dijital Bankacƒ±lƒ±k', interests: [{ id: '6003139266461', name: 'Travel' }] },
            'inf-1': { name: 'Hane Halklarƒ± - Kesintisiz Enerji', interests: [{ id: '6003139266461', name: 'Travel' }] },
            'inf-3': { name: 'Mobil Kullanƒ±cƒ±lar', interests: [{ id: '6003139266461', name: 'Travel' }] },
            'inf-4': { name: 'K√º√ß√ºk ƒ∞≈ületmeler', interests: [{ id: '6003139266461', name: 'Travel' }] }
        };
        
        let metaDataCache = {};
        let isMetaLoading = false;
        
        function formatMetaNumber(num) {
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return Math.round(num / 1000) + 'K';
            return num.toString();
        }
        
        function updateMetaStatus(status, text) {
            const statusEl = document.getElementById('metaStatus');
            statusEl.className = 'meta-status ' + status;
            statusEl.textContent = text;
        }
        
        async function getMetaReachEstimate(interests) {
            const targetingSpec = {
                geo_locations: { countries: ['TR'] },
                age_min: 18,
                age_max: 65,
                flexible_spec: [{ interests: interests }]
            };
            
            const url = `https://graph.facebook.com/${META_CONFIG.apiVersion}/act_${META_CONFIG.adAccountId}/reachestimate?targeting_spec=${encodeURIComponent(JSON.stringify(targetingSpec))}&access_token=${META_CONFIG.accessToken}`;
            
            const response = await fetch(url);
            const data = await response.json();
            
            if (data.error) {
                throw new Error(data.error.message);
            }
            
            return data.data;
        }
        
        async function loadMetaData() {
            if (isMetaLoading) return;
            isMetaLoading = true;
            
            const btn = document.getElementById('metaLoadBtn');
            btn.disabled = true;
            btn.textContent = '‚è≥ Y√ºkleniyor...';
            updateMetaStatus('loading', 'Veriler √ßekiliyor...');
            
            const segmentIds = Object.keys(META_SEGMENT_MAP);
            let loaded = 0;
            let errors = 0;
            
            for (const segmentId of segmentIds) {
                const segmentData = META_SEGMENT_MAP[segmentId];
                const metaEl = document.getElementById(`meta-${segmentId}`);
                
                try {
                    const result = await getMetaReachEstimate(segmentData.interests);
                    const formatted = `${formatMetaNumber(result.users_lower_bound)} - ${formatMetaNumber(result.users_upper_bound)}`;
                    
                    metaDataCache[segmentId] = {
                        lower: result.users_lower_bound,
                        upper: result.users_upper_bound,
                        formatted: formatted
                    };
                    
                    if (metaEl) {
                        metaEl.innerHTML = `üìä ${formatted} <span class="meta-live"></span>`;
                        metaEl.classList.add('loaded');
                        metaEl.title = `Meta Audience: ${result.users_lower_bound.toLocaleString('tr-TR')} - ${result.users_upper_bound.toLocaleString('tr-TR')} ki≈üi`;
                    }
                    
                    loaded++;
                } catch (err) {
                    console.error(`Error for ${segmentId}:`, err);
                    if (metaEl) {
                        metaEl.textContent = 'üìä Hata';
                        metaEl.classList.add('error');
                        metaEl.title = err.message;
                    }
                    errors++;
                }
                
                document.getElementById('metaLoadedCount').textContent = `${loaded}/${segmentIds.length} segment`;
                
                // Rate limit i√ßin bekle
                await new Promise(resolve => setTimeout(resolve, 300));
            }
            
            isMetaLoading = false;
            btn.disabled = false;
            btn.textContent = 'üîÑ Yenile';
            
            if (errors === 0) {
                updateMetaStatus('connected', `‚úì ${loaded} segment y√ºklendi`);
            } else {
                updateMetaStatus('error', `${loaded} ba≈üarƒ±lƒ±, ${errors} hata`);
            }
        }
        
        // Sayfa y√ºklendiƒüinde Meta durumunu g√∂ster ve localStorage'dan mapping'i y√ºkle
        document.addEventListener('DOMContentLoaded', () => {
            updateMetaStatus('', 'Hazƒ±r - butona tƒ±klayƒ±n');
            loadSavedMappings();
        });
        
        // LocalStorage'dan kaydedilmi≈ü mapping'leri y√ºkle
        function loadSavedMappings() {
            const saved = localStorage.getItem('metaSegmentMappings');
            if (saved) {
                const parsed = JSON.parse(saved);
                Object.assign(META_SEGMENT_MAP, parsed);
                console.log('Kaydedilmi≈ü mapping\'ler y√ºklendi:', Object.keys(parsed).length);
            }
        }
        
        // Mapping'leri kaydet
        function saveMappings() {
            localStorage.setItem('metaSegmentMappings', JSON.stringify(META_SEGMENT_MAP));
        }
        
        // Se√ßili segment (interest atamak i√ßin)
        let selectedSegmentForMapping = null;
        
        // Interest Arama Fonksiyonu - Kitle b√ºy√ºkl√ºƒü√º ile
        async function searchInterest() {
            const query = document.getElementById('interestSearch').value;
            if (!query || query.length < 2) {
                alert('En az 2 karakter girin');
                return;
            }
            
            const resultsDiv = document.getElementById('interestResults');
            resultsDiv.style.display = 'block';
            resultsDiv.innerHTML = '<p style="color: var(--text-secondary); font-size: 11px;">üîç Aranƒ±yor ve kitle b√ºy√ºkl√ºkleri hesaplanƒ±yor...</p>';
            
            try {
                // Interest'leri ara
                const url = `https://graph.facebook.com/${META_CONFIG.apiVersion}/search?type=adinterest&q=${encodeURIComponent(query)}&access_token=${META_CONFIG.accessToken}`;
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.error) {
                    resultsDiv.innerHTML = `<p style="color: #f87171; font-size: 11px;">Hata: ${data.error.message}</p>`;
                    return;
                }
                
                if (!data.data || data.data.length === 0) {
                    resultsDiv.innerHTML = '<p style="color: var(--text-secondary); font-size: 11px;">Sonu√ß bulunamadƒ±</p>';
                    return;
                }
                
                // Her interest i√ßin kitle b√ºy√ºkl√ºƒü√º √ßek
                const interests = data.data.slice(0, 8);
                const resultsWithSize = [];
                
                for (const interest of interests) {
                    try {
                        const sizeData = await getMetaReachEstimate([{ id: interest.id, name: interest.name }]);
                        resultsWithSize.push({
                            ...interest,
                            audience_lower: sizeData.users_lower_bound,
                            audience_upper: sizeData.users_upper_bound
                        });
                    } catch (e) {
                        resultsWithSize.push({
                            ...interest,
                            audience_lower: 0,
                            audience_upper: 0,
                            error: true
                        });
                    }
                    await new Promise(r => setTimeout(r, 200));
                }
                
                // Sonu√ßlarƒ± g√∂ster
                let html = '';
                
                // Segment se√ßici
                html += `
                    <div style="margin-bottom: 12px; padding: 10px; background: rgba(0,212,255,0.1); border-radius: 8px; border: 1px solid rgba(0,212,255,0.2);">
                        <div style="font-size: 11px; color: var(--accent-blue); margin-bottom: 6px; font-weight: 600;">üìå Interest'i bir segment'e ata:</div>
                        <select id="segmentSelector" style="width: 100%; padding: 8px; background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary); font-size: 11px;">
                            <option value="">-- Segment Se√ß --</option>
                            ${getAllSegmentOptions()}
                        </select>
                    </div>
                `;
                
                // Interest sonu√ßlarƒ±
                resultsWithSize.forEach(interest => {
                    const sizeText = interest.error ? 
                        '<span style="color: #f87171;">Hesaplanamadƒ±</span>' : 
                        `<span style="color: #34d399; font-weight: 600;">${formatMetaNumber(interest.audience_lower)} - ${formatMetaNumber(interest.audience_upper)}</span>`;
                    
                    html += `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: var(--bg-card); border-radius: 8px; margin-bottom: 8px; border: 1px solid var(--border-color);">
                            <div style="flex: 1;">
                                <div style="font-size: 13px; font-weight: 500; margin-bottom: 2px;">${interest.name}</div>
                                <div style="font-size: 10px; color: var(--text-secondary);">
                                    ID: <code style="background: var(--bg-secondary); padding: 1px 4px; border-radius: 3px;">${interest.id}</code>
                                </div>
                                <div style="font-size: 11px; margin-top: 4px;">
                                    üáπüá∑ TR Kitle: ${sizeText}
                                </div>
                            </div>
                            <div style="display: flex; gap: 6px;">
                                <button onclick="assignInterestToSegment('${interest.id}', '${interest.name.replace(/'/g, "\\'")}', ${interest.audience_lower}, ${interest.audience_upper})" 
                                    style="padding: 6px 12px; background: linear-gradient(135deg, #10b981, #059669); border: none; border-radius: 6px; color: white; font-size: 10px; cursor: pointer; font-weight: 500;">
                                    ‚úì Ata
                                </button>
                            </div>
                        </div>
                    `;
                });
                
                resultsDiv.innerHTML = html;
                
            } catch (err) {
                resultsDiv.innerHTML = `<p style="color: #f87171; font-size: 11px;">Hata: ${err.message}</p>`;
            }
        }
        
        // T√ºm segment'leri option olarak getir
        function getAllSegmentOptions() {
            let options = '';
            segments.forEach(parent => {
                options += `<optgroup label="${parent.icon} ${parent.name}">`;
                parent.subs.forEach(sub => {
                    const currentInterest = META_SEGMENT_MAP[sub.id]?.interests?.[0]?.name || 'Atanmamƒ±≈ü';
                    options += `<option value="${sub.id}">${sub.name} (${currentInterest})</option>`;
                });
                options += '</optgroup>';
            });
            return options;
        }
        
        // Interest'i se√ßili segment'e ata
        function assignInterestToSegment(interestId, interestName, lower, upper) {
            const selector = document.getElementById('segmentSelector');
            const segmentId = selector.value;
            
            if (!segmentId) {
                alert('L√ºtfen √∂nce bir segment se√ßin!');
                return;
            }
            
            // Mapping'i g√ºncelle
            META_SEGMENT_MAP[segmentId] = {
                name: findSegment(segmentId)?.name || segmentId,
                interests: [{ id: interestId, name: interestName }]
            };
            
            // LocalStorage'a kaydet
            saveMappings();
            
            // UI g√ºncelle
            const metaEl = document.getElementById(`meta-${segmentId}`);
            if (metaEl) {
                metaEl.innerHTML = `üìä ${formatMetaNumber(lower)} - ${formatMetaNumber(upper)} <span class="meta-live"></span>`;
                metaEl.classList.add('loaded');
                metaEl.title = `${interestName}: ${lower.toLocaleString('tr-TR')} - ${upper.toLocaleString('tr-TR')} ki≈üi`;
            }
            
            // Selector'ƒ± g√ºncelle
            selector.innerHTML = `<option value="">-- Segment Se√ß --</option>${getAllSegmentOptions()}`;
            
            // Bildirim
            const segmentName = findSegment(segmentId)?.name || segmentId;
            showNotification(`‚úì "${interestName}" ‚Üí "${segmentName}" atandƒ±!`);
        }
        
        // Bildirim g√∂ster
        function showNotification(message) {
            const notif = document.createElement('div');
            notif.style.cssText = `
                position: fixed;
                bottom: 100px;
                right: 20px;
                background: linear-gradient(135deg, #10b981, #059669);
                color: white;
                padding: 12px 20px;
                border-radius: 10px;
                font-size: 13px;
                font-weight: 500;
                z-index: 10000;
                animation: slideIn 0.3s ease;
                box-shadow: 0 4px 20px rgba(16,185,129,0.4);
            `;
            notif.textContent = message;
            document.body.appendChild(notif);
            
            setTimeout(() => {
                notif.style.animation = 'fadeOut 0.3s ease';
                setTimeout(() => notif.remove(), 300);
            }, 2500);
        }
        
        // Mapping'leri g√∂ster/y√∂net modalƒ±
        function showMappingsModal() {
            const modal = document.createElement('div');
            modal.id = 'mappingsModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
            `;
            
            let mappingsHtml = '';
            Object.entries(META_SEGMENT_MAP).forEach(([segId, data]) => {
                const segName = findSegment(segId)?.name || segId;
                const interestName = data.interests?.[0]?.name || 'Atanmamƒ±≈ü';
                mappingsHtml += `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: var(--bg-secondary); border-radius: 6px; margin-bottom: 6px;">
                        <div>
                            <div style="font-size: 12px; font-weight: 500;">${segName}</div>
                            <div style="font-size: 10px; color: var(--accent-blue);">‚Üí ${interestName}</div>
                        </div>
                        <button onclick="removeMapping('${segId}')" style="padding: 4px 8px; background: #ef4444; border: none; border-radius: 4px; color: white; font-size: 10px; cursor: pointer;">Sil</button>
                    </div>
                `;
            });
            
            modal.innerHTML = `
                <div style="background: var(--bg-card); border-radius: 16px; width: 500px; max-height: 80vh; overflow: hidden; border: 1px solid var(--border-color);">
                    <div style="padding: 16px 20px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;">
                        <h3 style="font-size: 14px; color: var(--accent-blue);">üìã Segment-Interest E≈üle≈ütirmeleri</h3>
                        <button onclick="document.getElementById('mappingsModal').remove()" style="background: none; border: none; color: var(--text-secondary); font-size: 18px; cursor: pointer;">‚úï</button>
                    </div>
                    <div style="padding: 20px; max-height: 60vh; overflow-y: auto;">
                        ${mappingsHtml || '<p style="color: var(--text-secondary); font-size: 12px;">Hen√ºz e≈üle≈ütirme yok</p>'}
                    </div>
                    <div style="padding: 16px 20px; border-top: 1px solid var(--border-color); display: flex; gap: 10px; justify-content: flex-end;">
                        <button onclick="clearAllMappings()" style="padding: 8px 16px; background: #ef4444; border: none; border-radius: 6px; color: white; font-size: 11px; cursor: pointer;">T√ºm√ºn√º Sil</button>
                        <button onclick="exportMappings()" style="padding: 8px 16px; background: var(--accent-blue); border: none; border-radius: 6px; color: #000; font-size: 11px; cursor: pointer;">üì• Dƒ±≈üa Aktar</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        function removeMapping(segId) {
            delete META_SEGMENT_MAP[segId];
            saveMappings();
            document.getElementById('mappingsModal').remove();
            showMappingsModal();
            showNotification('E≈üle≈ütirme silindi');
        }
        
        function clearAllMappings() {
            if (confirm('T√ºm e≈üle≈ütirmeleri silmek istediƒüinize emin misiniz?')) {
                Object.keys(META_SEGMENT_MAP).forEach(key => delete META_SEGMENT_MAP[key]);
                localStorage.removeItem('metaSegmentMappings');
                document.getElementById('mappingsModal').remove();
                showNotification('T√ºm e≈üle≈ütirmeler silindi');
                renderSegments();
            }
        }
        
        function exportMappings() {
            const data = JSON.stringify(META_SEGMENT_MAP, null, 2);
            const blob = new Blob([data], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'segment-interest-mappings.json';
            a.click();
        }
        
        function copyInterestId(id, name) {
            navigator.clipboard.writeText(`{ id: '${id}', name: '${name}' }`);
            alert(`Kopyalandƒ±: ${name} (${id})`);
        }
        
        // Enter tu≈üu ile arama
        document.getElementById('interestSearch')?.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') searchInterest();
        });
        
        // CSS Animasyonlarƒ±
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100px); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes fadeOut {
                from { opacity: 1; }
                to { opacity: 0; }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>
